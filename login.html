
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Menú Principal</title>
  <!-- Fuente Poppins -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Chart.js (para gráficos en el menú de Finanzas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    /* =================== ESTILOS GENERALES =================== */
#appLoader{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(255,255,255,.98);
  z-index:2000;        /* por encima de todo */
  opacity:0; pointer-events:none;
  transition:opacity .25s ease;
}
#appLoader.active{
display:flex;              /* se muestra y ocupa la viewport */
align-items:center;        /* (movidos aquí)                 */
justify-content:center;
  opacity:1;
  pointer-events:all;
}

/* spinner */
.loader-ring{
  width:64px; height:64px;
  border:8px solid #4a90e2;
  border-top-color:transparent;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
#proofBackdrop{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center;
  background:rgba(0,0,0,.55); z-index:1000;
}

/* tarjeta */
#proofModal{
  width: min(90%, 400px);
  background:#ffffff;
  border-radius:12px;
  box-shadow:0 8px 28px rgba(0,0,0,.25);
  padding:28px 32px;
  text-align:center;
  animation: zoom .25s ease;
}
@keyframes zoom{
  from{ transform:scale(.8); opacity:.3; }
  to  { transform:scale(1); opacity:1;  }
}
#proofModal h3{
  margin:0 0 18px;
  font-size:1.2rem;
  color:#1a2e55;
  white-space:normal;         /* asegura que no desborde */
}

#proofModal input[type=file]{
  width:100%;
  margin-bottom:20px;
}

#proofModal button{
  margin:0 6px;
  padding:10px 24px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  color:#fff;
  transition:filter .15s;
}
#proofModal button:hover{ filter:brightness(1.15); }

#btnProofSave{ background:#4a90e2; }
#btnProofCancel{ background:#999; }
#logoutContainer {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 9999;
}

#logoutContainer button {
  background-color: #f1c40f;
  color: #1a2e55;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: background-color 0.2s ease;
}
/* ░░░ Loader ligero – solo para “Guardar comprobante” ░░░ */
#proofLoader{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  /* apenas cubre la vista (35 %), con un suave blur */
  background:rgba(255,255,255,.35);
  backdrop-filter:blur(2px);
  z-index:2000;
  opacity:0; pointer-events:none;
  transition:opacity .25s ease;
}
#proofLoader.active{            /* la misma mecánica de #appLoader */
  display:flex;
  opacity:1;
  pointer-events:all;
}
/* spinner un poco más discreto */
.proof-spinner{
  width:48px; height:48px;
  border:6px solid #4a90e2;
  border-top-color:transparent;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

#logoutContainer button:hover {
  box-shadow: 0 4px 7px rgba(0, 0, 0, 0.2);
}
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #e5efff;
      min-height: 100vh;
    }
    .hidden { display: none !important; }



    /* =================== LANDING PAGE =================== */
    #landingPage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #landingPage h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: #1a2e55;
    }
    .landing-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }
/* ====== estilos botones acciones & hover ====== */
.action-group{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:center;
}
.action-btn{
  width:30px;height:30px;
  border:none;border-radius:6px;
  color:#fff;font-weight:600;
  cursor:pointer;
  transition:filter .15s;
}
.action-btn:hover{ filter:brightness(1.25); }
.custom-dropdown .selected:hover,
.custom-dropdown .option:hover{
  filter:brightness(1.25);
}
/* hover para caja seleccionada del dropdown */
.custom-dropdown .selected:hover{ filter:brightness(1.15); }

    .landing-buttons button {
      background-color: #f1c40f;
      color: #1a2e55;
      border: none;
      border-radius: 6px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    .landing-buttons button:hover {
      background-color: #1a2e55;
      color: #f1c40f;
    }

    /* =================== CONTENEDOR GENERAL =================== */
    .app-container {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding-bottom: 60px;
    }
    .activeContainer { display: block !important; }

    /* Botón Regresar */
    .bottom-left-btn {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background-color: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .bottom-left-btn:hover { background-color: #1a2e55; }
.day-picker{
  position:absolute;
  background:#fff;
  border:1px solid #ccd3e6;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  padding:6px;
  display:grid;
  grid-template-columns:repeat(7,30px);  /* 7 col = semana */
  gap:4px;
  z-index:9999;
}
.day-picker button{
  width:30px;height:30px;
  border:none;
  background:#f9fbff;
  cursor:pointer;
}
.day-picker button:hover{
  background:#4a90e2;
  color:#fff;
}


    /* =================== TABS =================== */
    .tabs {
      display: flex;
      background-color: #1a2e55;
      border-radius: 6px 6px 0 0;
    }
    .tab {
      flex: 1;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .tab:hover { background-color: #4a90e2; }
    .tab.activeTab { background-color: #4a90e2; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.activeTabContent { display: block; }


    /* =================== ESTILOS MACROS =================== */
    #macrosContainer .macros-list {
      display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;
    }
    #macrosContainer .macro-item {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    #macrosContainer .macro-item button {
      background: none; border: none; cursor: pointer; color: #4a90e2; font-weight: 600; margin-left: 10px;
    }
    #macrosContainer .macro-item button:hover { color: #1a2e55; }
    #macrosContainer .create-macro {
      display: flex; gap: 0.5rem; margin-top: 1rem; align-items: center;
    }
    #macrosContainer .create-macro input {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px;
      flex: 1; max-width: 300px;
    }
    #macrosContainer .create-macro button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #macrosContainer .create-macro button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    #macrosContainer .register-children-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    #macrosContainer .macro-title {
      font-size: 1.1rem; font-weight: 600; color: #4a90e2;
    }
    #macrosContainer .form-section {
      display: flex; flex-direction: column; max-width: 400px; gap: 0.5rem; margin-bottom: 1rem;
    }
    #macrosContainer .form-section label { font-weight: 600; }
    #macrosContainer .form-section input { border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; max-width: 220px; }
    #macrosContainer .child-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #macrosContainer .child-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #macrosContainer .child-table th,
    #macrosContainer .child-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    #macrosContainer .actions {
      margin-top: 1rem; display: flex; gap: 1rem;
    }
    #macrosContainer .actions button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #macrosContainer .actions button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }

    /* =================== ESTILOS SERVICES =================== */
    #servicesContainer .services-list {
      display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;
    }
    #servicesContainer .service-item {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    #servicesContainer .service-item button {
      background: none; border: none; cursor: pointer; color: #4a90e2; font-weight: 600; margin-left: 10px;
    }
    #servicesContainer .service-item button:hover { color: #1a2e55; }
    #servicesContainer .create-service {
      display: flex; gap: 0.5rem; margin-top: 1rem; align-items: center;
    }
    #servicesContainer .create-service input {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px;
      flex: 1; max-width: 300px;
    }
    #servicesContainer .create-service button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #servicesContainer .create-service button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    #servicesContainer .variants-form {
      display: flex; flex-direction: column; max-width: 400px; gap: 0.5rem; margin-top: 1rem;
    }
    #servicesContainer .days-container {
      display: flex; gap: 6px; margin: 6px 0;
    }
    .day-btn {
      background-color: #4a90e2; color: white; border: none; border-radius: 6px;
      padding: 6px 12px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
    }
    .day-btn.selected {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .variants-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #servicesContainer .variants-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .variants-table th, 
    #servicesContainer .variants-table td {
      border: 1px solid #ddd; padding: 8px;
    }
    #servicesContainer .children-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #servicesContainer .children-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .children-table th,
    #servicesContainer .children-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
 /* ========= Services › Administrar Niños ========= */

/* --- Cabecera selector de mes (ya existe .finanzas-header) --- */
#contentServicesChildren .finanzas-header{
  justify-content:flex-end;
  background:#f9fbff;
  border:1px solid #e0e6f0;
  border-radius:8px;
  padding:12px 18px;
  margin-bottom:18px;
}
#contentServicesChildren .finanzas-header label{
  font-weight:600;
  color:#1a2e55;
}

/* --- Formulario principal ---------------------------------- */
#contentServicesChildren .form-section{
  display:grid;
  grid-template-columns: 120px 1fr 130px 1fr; /* etiqueta‑campo, etiqueta‑campo */
  gap:14px 22px;                              /* fila / columna                */
  align-items:center;
  background:#f9fbff;
  border:1px solid #e0e6f0;
  border-radius:8px;
  padding:20px 24px 14px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}

#contentServicesChildren .form-section label{
  justify-self:end;           /* etiquetas a la derecha de la celda */
  font-weight:600;
  color:#1a2e55;
}

#contentServicesChildren .form-section input,
#contentServicesChildren .form-section select{
  width:100%;
  padding:8px 12px;
  border:1px solid #ccd3e6;
  border-radius:6px;
  background:#fff;
  font-size:.95rem;
}

/* Botón Agregar / Guardar Niño ocupa la fila completa */
#contentServicesChildren #btnChildPrincipal{
  grid-column:1 / -1;         /* de la 1ª a la última columna */
  justify-self:start;
  margin-top:8px;
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:10px 26px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
#contentServicesChildren #btnChildPrincipal:hover{
  background:#1a2e55;
}

/* --- Buscador ------------------------------------------------ */
#contentServicesChildren .children-search{
  margin:22px 0 14px;
  display:flex;
  gap:10px;
}

#contentServicesChildren .children-search input{
  flex:1;
  padding:10px 14px;
  border:1px solid #ccd3e6;
  border-radius:6px;
  font-size:.95rem;
}

#contentServicesChildren .children-search button{
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:10px 22px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
#contentServicesChildren .children-search button:hover{
  background:#1a2e55;
}

/* --- Tabla de niños ----------------------------------------- */
#contentServicesChildren .children-table thead{
  background:#f1c40f;
  color:#1a2e55;
}
#contentServicesChildren .children-table td,
#contentServicesChildren .children-table th{
  font-size:.9rem;
}


    /* =================== ESTILOS MATRÍCULAS =================== */
/* ========= Matrículas › cabecera de filtros ========= */
/* ===== Matrículas › barra de búsqueda ===== */
#matriculasContainer .matriculas-search{
  display:flex;
  gap:10px;
  max-width:600px; 
  margin: 0 0 24px;              /* “24” = separación con la tabla */
  padding: 0 20px;               /* coincide con el padding lateral del contenedor */
  gap: 14px;     
}
#matriculasContainer .matriculas-search input{
  padding:10px 14px;
  flex:0 1 360px; 
  border:1px solid #ccd3e6;
  border-radius:6px;
  font-size:.95rem;
}
#matriculasContainer .matriculas-search button{
  background:#4a90e2;
  flex:0 0 auto; 
  color:#fff;
  border:none;
  border-radius:6px;
  padding:10px 22px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
#matriculasContainer .matriculas-search button:hover{
  background:#1a2e55;
}

#matriculasContainer .matriculas-header{
  display:flex;
  flex-wrap:wrap;
  gap:12px 18px;                /* fila / columna */
  align-items:center;
  background:#f9fbff;
  border:1px solid #e0e6f0;
  border-radius:8px;
  padding:12px 18px;
  margin-bottom:18px;
  margin: 20px 20px 20px;              /* separamos del search‑bar      */
  padding: 16px 20px;            /* aire respecto a su propio borde */
  gap: 14px 24px;  
}

#matriculasContainer .matriculas-header label{
  font-weight:600;
  color:#1a2e55;
}

#matriculasContainer .matriculas-header select{
  padding:6px 10px;
  border:1px solid #ccd3e6;
  border-radius:6px;
  background:#fff;
  font-size:.95rem;
  min-width:120px;
}

.matriculas-btn{
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 22px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
.matriculas-btn:hover{
  background:#1a2e55;
}

    #matriculasContainer .tabs-bar {
      background-color: #1a2e55;
      border-radius: 6px 6px 0 0;
      color: #fff;
      padding: 14px;
      font-weight: 600;
      font-size: 1rem;
    }
    #matriculasContainer .filter-section {
      margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;
    }
    #matriculasContainer .matriculas-list-table {
      width: 100%; border-collapse: collapse;
    }
    #matriculasContainer .matriculas-list-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #matriculasContainer .matriculas-list-table th,
    #matriculasContainer .matriculas-list-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    /* Ficha / Pensiones */
    .ficha-btn, .pension-btn {
      border: none;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 10px;
      outline: none;
    }
button.matriculas-btn,
button.day-btn,
#macrosContainer .actions button,
#servicesContainer .actions button,
.finanzas-form button,
.bottom-left-btn,
#logoutContainer button,
.ficha-btn,
.pension-btn {
  margin:6px;                 /* 6 px en los 4 lados */
}
#contentServicesChildren .finanzas-header{
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(249,251,255,.95);
  backdrop-filter: blur(6px);
  transition: box-shadow .25s ease, transform .25s ease;
}
#contentServicesChildren .finanzas-header.scrolled{
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
  transform: translateY(-4px);
}

/* ═════════════════════ MATRÍCULAS – botón «Aplicar Filtro» ═══════════════════ */
#matriculasContainer .matriculas-header button,
#matriculasContainer .matriculas-header .matriculas-btn{   /* te cubre las 2 formas */
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 22px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s, box-shadow .2s;
}
#matriculasContainer .matriculas-header button:hover{
  background:#1a2e55;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}

/* ═════════════════════ MACROS – botón «Agregar Niño / Guardar Niño» ═══════════ */
#macrosContainer .form-section button{
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:10px 10px;
  margin: 6px 0px 0px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
#macrosContainer .form-section button:hover{background:#1a2e55;}

/* ═════════════════════ SERVICIOS – botones «Listo» (Variants & Children) ══════ */
#servicesContainer .actions button{
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:10px 26px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
#servicesContainer .actions button:hover{background:#1a2e55;}

/* ═════════════════════ USUARIOS – recuadros y botones ═════════════════════════ */
#usersContainer #usersList .user-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#f9fbff;
  border:1px solid #e0e6f0;
  border-radius:8px;
  padding:10px 14px;
  margin-bottom:8px;
}
#usersContainer #usersList .user-item button,
#usersContainer input[type="text"],
#usersContainer input[type="password"]{
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 18px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
#usersContainer #usersList .user-item button:hover{background:#1a2e55;}
#usersContainer input[type="text"],
#usersContainer input[type="password"]{
  background:#fff;
  color:#1a2e55;
  border:1px solid #ccd3e6;
  font-weight:400;
  padding:8px 12px;
}

/* ═════════════════════ FINANZAS – filtros y recuadros de “Agregar” ════════════ */
#finanzasContainer .finanzas-form{
  background:#f9fbff;
  border:1px solid #e0e6f0;
  border-radius:8px;
  padding:14px 20px;
  display:flex;
  flex-wrap:wrap;
  gap:14px 20px;
}
#finanzasContainer .finanzas-form label{font-weight:600;color:#1a2e55;}
#finanzasContainer .finanzas-form select,
#finanzasContainer .finanzas-form input{
  padding:8px 12px;
  border:1px solid #ccd3e6;
  border-radius:6px;
  background:#fff;
  font-size:.95rem;
}
#finanzasContainer .finanzas-form button{
  background:#4a90e2;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 22px;
  font-weight:600;
  cursor:pointer;
  transition:background-color .2s;
}
#finanzasContainer .finanzas-form button:hover{background:#1a2e55;}
/* Botoncitos + / – compactos */
#finanzasContainer .finanzas-form button[type="button"]{
  width:34px; padding:6px 0;
}


    /* =================== FICHA INFORMATIVA =================== */
    #fichaInformativaPanel {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding: 20px;
      padding-bottom: 60px; 
    }
    #fichaInformativaPanel h2 {
      margin-bottom: 1rem;
    }
    #fichaInformativaPanel .section-title {
      font-weight: 600; font-size: 1.1rem; margin-top: 1rem; color: #1a2e55;
    }
    .form-field {
      margin-bottom: 8px; display: flex; flex-direction: column; max-width: 400px;
    }
    .form-field label {
      font-weight: 600; margin-bottom: 2px;
    }
    .form-field input[type='text'],
    .form-field input[type='number'],
    .form-field textarea {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; max-width: 350px;
    }
    .form-field select, .form-field input[type='date'] {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; max-width: 200px;
    }
    .finish-btn {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; 
      padding: 8px 12px; font-weight: 600; cursor: pointer; margin-top: 1rem;
    }
    .finish-btn:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    .subsection {
      border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-top: 10px; 
    }
    .subsection h4 {
      margin-bottom: 5px;
    }
    .edit-section-btn {
      background: #4a90e2; color: #fff; border: none; border-radius: 6px; padding: 5px 8px; font-weight: 600; margin-left: 10px; cursor: pointer;
    }
    .edit-section-btn:hover {
      background-color: #1a2e55;
    }
.listo-btn{
  background:#f1c40f;
  color:#1a2e55;
  border:none;
  border-radius:6px;
  padding:6px 16px;         /* más delgado */
  font-weight:600;
  font-size:.9rem;          /* un poco menor */
  cursor:pointer;
  transition:background-color .2s;
}
.listo-btn:hover{
  background:#d9ae0a;       /* tono más oscuro al pasar */
}
    /* =================== ESTILOS ADMIN FINANZAS =================== */
    /* Contenedor para Finanzas */
    #finanzasContainer {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding-bottom: 60px;
    }
    /* Fin de pestañas: se reutiliza la clase .tabs, .tab y .tab-content */

    /* Selector de mes (dropdown) en finanzas */
    .finanzas-header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 20px;
      background-color: #f9f9f9;
    }
    .finanzas-header label {
      margin-right: 10px;
      font-weight: 600;
      color: #1a2e55;
    }
    .finanzas-header select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    /* Tarjetas (cajas) para Total Mensual */
    .finanzas-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    .finanzas-card {
      background-color: #f1c40f;
      color: #1a2e55;
      border-radius: 6px;
      padding: 15px;
      flex: 1 1 calc(33.333% - 20px);
      text-align: center;
      min-width: 250px;
    }
    .finanzas-card h3 {
      margin: 0;
      font-size: 1.2rem;
    }
    .finanzas-card p {
      margin: 5px 0 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
/* Contenedor del dropdown */
.custom-dropdown {
  position: relative;
  display: inline-block;
  font-size: 1rem;
  margin: 0;
}

/* La caja que muestra la opción seleccionada */
.custom-dropdown .selected {
  background-color: #eee;
  color: #333;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  user-select: none;
  min-width: 100px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Flecha */
.custom-dropdown .selected::after {
  content: '▾';
  margin-left: 8px;
  font-size: 0.8em;
}

/* Contenedor de las opciones */
.custom-dropdown .options {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ccd3e6;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  z-index: 100;
  overflow: hidden;
  display: none; /* se muestra al abrir */
}

/* Cada opción */
.custom-dropdown .option {
  background: #f9f9f9;
  margin: 4px;
  padding: 10px 12px;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  white-space: nowrap;
  /* ligero aumento */
  transform: scale(1);
  transition: transform 0.1s ease;
}
.custom-dropdown .option:active {
  transform: scale(1.05);
}
/* Color fijo según tipo */
.custom-dropdown .option.no      { background: #E74C3C; color: #fff; }
.custom-dropdown .option.yes     { background: #3BB273; color: #fff; }
.custom-dropdown .option.partial { background: #4a90e2; color: #fff; }

    /* Indicador de porcentaje */
    .finanzas-indicador {
      margin-top: 20px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }
    /* Formularios y tablas en Egresos e Ingresos */
    .finanzas-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .finanzas-form input, .finanzas-form select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      flex: 1;
      min-width: 150px;
    }
    .finanzas-form button {
      background-color: #f1c40f;
      color: #1a2e55;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .finanzas-form button:hover {
      background-color: #1a2e55;
      color: #f1c40f;
    }
    .finanzas-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .finanzas-table th, .finanzas-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .finanzas-table thead {
      background-color: #f1c40f;
      color: #1a2e55;
    }
    /* Placeholder para gráficos */
    .chart-container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px;
} 
.ficha-btn,
.pension-btn{
  color:#fff !important;     /* texto siempre blanco */
}
    
  </style>
</head>
<body>
<div id="appLoader">
  <div class="loader-ring"></div>
</div>
  <div id="logoutContainer" style="position:absolute; top:15px; right:15px;">
    <button onclick="logout()" style="background-color:#f1c40f; border:none; border-radius:6px; padding:8px; font-weight:600; cursor:pointer;">
      Cerrar Sesión
    </button>
  </div>
<!-- =================== LANDING PAGE =================== -->
<div id="landingPage">
  <h1>Bienvenid@, selecciona qué deseas administrar:</h1>
  <div class="landing-buttons">
    <!-- Agregamos id a cada botón -->
    <button id="btnMacros" onclick="goToMacros()">Administrador de Macros</button>
    <button id="btnServices" onclick="goToServices()">Administrador de Servicios</button>
    <button id="btnMatriculas" onclick="goToMatriculas()">Administrador de Matrículas</button>
    <button id="btnFinanzas" onclick="goToFinanzas()">Administrador de Finanzas</button>
    <button id="btnUsers" onclick="goToUsers()">Administrador de Usuarios</button>
  </div>
</div>
<div id="proofBackdrop">
  <div id="proofModal">
    <h3>Subir comprobante de pago</h3>
    <input type="file" id="proofFile" accept="image/*,.doc,.docx,.pdf">
    <br>
    <button id="btnProofSave">Guardar</button>
    <button id="btnProofCancel">Cerrar</button>
  </div>
</div>
<!-- =================== CONTENEDOR MACROS =================== -->
<div class="app-container" id="macrosContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabMacros" onclick="openTabMacros('Macros')">Administrador de Macros</div>
    <div class="tab" id="tabNinos" style="display:none;">Registrar Niños</div>
  </div>
  <div class="tab-content activeTabContent" id="contentMacros">
    <h2>Administrador de Macros</h2>
    <p>Aquí puedes ver todas las macros, crear nuevas o gestionarlas.</p>
    <div class="macros-list" id="macrosList"></div>
    <div class="create-macro">
      <input type="text" id="tituloMacro" placeholder="Título de la nueva macro..." />
      <button onclick="crearMacro()">Crear Macro</button>
    </div>
  </div>
  <div class="tab-content" id="contentNinos">
    <div class="register-children-header">
      <h2>Registrar Niños</h2>
      <span class="macro-title" id="currentMacroTitle"></span>
    </div>
    <div class="form-section">
      <label>Nombre:</label>
      <input type="text" id="nombre" placeholder="Ej: ALESSA" />
      <label>Apellidos:</label>
      <input type="text" id="apellidos" placeholder="Ej: AGURTO HO" />
      <label>Código:</label>
      <div style="display:flex; align-items:center; gap:5px;">
        <span id="codigoFijo"></span>
        <input type="text" id="codigoRestante" placeholder="01" />
      </div>
      <label>Fecha:</label>
      <input type="date" id="fechaInscripcion" />
      <label>Importe:</label>
      <input type="number" id="importe" placeholder="Ej: 50.00" step="0.01" />
      <button onclick="agregarOguardarNino()" id="btnNinoPrincipal">Agregar Niño</button>
    </div>
    <table class="child-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Apellidos</th>
          <th>Código</th>
          <th>Fecha</th>
          <th>Importe</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyNinos"></tbody>
    </table>
    <div class="actions">
      <button onclick="generarTxt()">Generar TXT</button>
      <button onclick="guardarYVolver()">Guardar y Volver</button>
    </div>
  </div>
</div>
<div id="proofLoader">
  <div class="proof-spinner"></div>
</div>
<!-- =================== CONTENEDOR SERVICES =================== -->
<div class="app-container" id="servicesContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabServicesMain" onclick="openTabServices('ServicesMain')">Administrador de Servicios</div>
    <div class="tab" id="tabServicesVariants" style="display:none;">Creador de Variantes</div>
    <div class="tab" id="tabServicesChildren" style="display:none;">Administrar Niños</div>
  </div>
  <div class="tab-content activeTabContent" id="contentServicesMain">
    <h2>Administrador de Servicios</h2>
    <p>Aquí puedes ver todos los servicios, crear nuevos o gestionarlos.</p>
    <div class="services-list" id="servicesList"></div>
    <div class="create-service">
      <input type="text" id="tituloService" placeholder="Título del nuevo servicio..." />
      <button onclick="crearService()">Crear Servicio</button>
    </div>
  </div>
  <div class="tab-content" id="contentServicesVariants">
    <h2>Creador de Variantes</h2>
    <p id="currentServiceTitle" style="font-weight: 600; color:#4a90e2;"></p>
    <div class="variants-form">
      <label>Nombre de la variante:</label>
      <input type="text" id="variantName" placeholder="Ej: Ejemplo 1" />
      <label>Precio:</label>
      <input type="number" id="variantPrice" placeholder="Ej: 100.00" step="0.01" />
      <label>Días de la semana:</label>
      <div class="days-container" id="daysContainer"></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div>
          <label>Hora de inicio:</label><br/>
          <input type="time" id="variantStart" />
        </div>
        <div>
          <label>Hora de término:</label><br/>
          <input type="time" id="variantEnd" />
        </div>
      </div>
      <button style="margin-top:10px;" onclick="agregarOguardarVariante()" id="btnVariantPrincipal">Agregar Variante</button>
    </div>
    <table class="variants-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Días</th>
          <th>Precio</th>
          <th>Horario</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyVariants"></tbody>
    </table>
    <div class="actions">
      <button class="listo-btn" onclick="doneChildren()">Listo</button>
    </div>
  </div>
<div class="tab-content" id="contentServicesChildren">
  <h2>Administrar Niños</h2>
  <p id="currentServiceTitleChild" style="font-weight:600; color:#4a90e2;"></p>
<div class="finanzas-header">
  <label for="servicesMes">Mes:</label>
  <select id="servicesMes" onchange="cambiarMesServices()"></select>
</div>
  <div class="form-section">
    <label>Nombre:</label>
    <input type="text" id="childName" placeholder="Ej: JUAN" />
    <label>Apellidos:</label>
    <input type="text" id="childLastname" placeholder="Ej: PEREZ" />
  <label>DNI Padre:</label>                 <!-- NUEVO -->
  <input type="text" id="childDniPadre" placeholder="DNI" />
<label>Día Ingreso:</label>
<input type="text"
       id="childDay"
       placeholder="Día"
       readonly
       onclick="openDayPicker()" />

<!-- popup -->
<div id="dayPicker" class="day-picker hidden"></div>
    <label id="labelVariantChild">Variante:</label>
    <select id="childVariantSelect">
      <!-- Llenado dinámico -->
    </select>
    <button onclick="agregarOguardarChild()" id="btnChildPrincipal">Agregar Niño</button>
  </div>
  <!-- dentro de contentServicesChildren, antes de <table class="children-table"> -->
<div class="children-search">
  <input
    type="text"
    id="childrenSearch"
    placeholder="Buscar por nombre o apellido…"
    oninput="if(event.key==='Enter') filterChildren()" />
  <button onclick="filterChildren()">Buscar</button>
</div>
  <table class="children-table">
    <thead>
      <tr>
    <th>Nombre</th>
    <th>Apellidos</th>
    <th>Fecha de Inscripción</th>
    <th>Variante</th>
    <th>Pagó Pensión</th>
    <th>Fecha de Pago</th>          <!-- NUEVA -->
    <th>Pensiones Atrasadas</th>
    <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbodyChildren"></tbody>
  </table>
  <div class="actions">
    <button onclick="doneChildren()">Listo</button>
  </div>
</div>

</div>

<!-- =================== CONTENEDOR MATRÍCULAS =================== -->
<div class="app-container" id="matriculasContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs-bar">Administrador de Matrículas</div>
  <div class="matriculas-header">
<label>Mes:</label>
<select id="filtroMesMatriculas" onchange="cambiarMesMatriculas()"></select>
    <label>Año:</label>
    <select id="filtroAno">
      <option value="">(Todos)</option>
      <option value="1">1 año</option>
      <option value="2">2 años</option>
      <option value="3">3 años</option>
      <option value="4">4 años</option>
      <option value="5">5 años</option>
    </select>
    <label>Adeudan pensión:</label>
    <select id="filtroPension">
      <option value="">(Todos)</option>
      <option value="SI">Sí</option>
      <option value="NO">No</option>
    </select>
    <button class="matriculas-btn" onclick="filtrarMatriculas()">Aplicar Filtro</button>
  </div>
<div class="matriculas-search">
<input
  type="text"
  id="matriculasSearch"
  placeholder="Buscar por nombre o apellido…"
  onkeyup="if(event.key==='Enter') filterMatriculasBySearch()" />  <!-- ← cierre -->
<button onclick="filterMatriculasBySearch()">Buscar</button>
</div>


  <table class="matriculas-list-table">
    <thead>
      <tr>
        <th>Apellidos y Nombres</th>
        <th>Año</th>
        <th>Ficha Informativa</th>
        <th>Pagó Pensión</th>
        <th>Pensiones Atrasadas</th>
      </tr>
    </thead>
    <tbody id="tbodyMatriculas"></tbody>
  </table>
</div>

<!-- =================== CONTENEDOR FINANZAS =================== -->
<div class="app-container" id="finanzasContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabFinanzasTotal" onclick="openTabFinanzas('Total')">Total Mensual</div>
    <div class="tab" id="tabFinanzasEgresos" onclick="openTabFinanzas('Egresos')">Egresos</div>
    <div class="tab" id="tabFinanzasIngresos" onclick="openTabFinanzas('Ingresos')">Ingresos</div>
  </div>
  <!-- Encabezado con selector de mes -->
  <div class="finanzas-header">
    <label for="finanzasMes">Mes:</label>
    <select id="finanzasMes" onchange="cambiarMesFinanzas()">
      <!-- Opciones generadas dinámicamente -->
    </select>
  </div>
  <!-- Contenido de cada subpanel -->
  <div class="tab-content activeTabContent" id="contentFinanzasTotal">
    <h2>Administrador de Finanzas - Total Mensual</h2>
    <!-- Sección superior con gráficos y total central (placeholders) -->
  <div style="display: flex; justify-content: center; align-items: center; height: 10%;">
      <div class="chart-container">
        <canvas id="chartFinanzasCircular"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartFinanzasLinealTotal"></canvas>
      </div>
    </div>
    <!-- Tarjetas de indicadores en 2 filas (máximo 3 por fila) -->
    <div class="finanzas-cards">
      <div class="finanzas-card">
        <h3>Egresos Variables</h3>
        <p id="egresosVariables">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Egresos Fijos</h3>
        <p id="egresosFijos">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Egresos Totales</h3>
        <p id="egresosTotales">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Brutos Esperados</h3>
        <p id="ingresosBrutosEsperados">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Netos Esperados</h3>
        <p id="ingresosNetosEsperados">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Brutos Totales</h3>
        <p id="ingresosBrutosTotales">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Netos Totales</h3>
        <p id="ingresosNetosTotales">S/ 0.00</p>
      </div>
    </div>
    <!-- Indicador de variación respecto al mes anterior -->
    <div class="finanzas-indicador" id="indicadorVariacion">
      <!-- Se mostrará algo como: +10% o -5% -->
      Variación: +0%
    </div>
  </div>
  <div class="tab-content" id="contentFinanzasEgresos">
    <h2>Administrador de Finanzas - Egresos</h2>
    <!-- Gráficos para egresos -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
      <div class="chart-container">
        <canvas id="chartEgresosLineal"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartEgresosCircular"></canvas>
      </div>
    </div>

<div class="finanzas-form" style="margin-bottom:10px;">

  <!-- Filtro de Egresos -->
  <label>Filtrar Tipo:</label>
  <select id="filtroEgresosTipo"></select>

  <label>Filtrar Subtipo:</label>
  <select id="filtroEgresosSubtipo"></select>

  <button onclick="filtrarEgresos()">Aplicar</button>
</div>

    <!-- Formulario para agregar egresos -->
    <div class="finanzas-form">
      <input type="text" id="egresoNombre" placeholder="Nombre del egreso" />
      <select id="egresoTipo">
        <option value="">-- Selecciona Tipo --</option>
        <option value="Fijo">Fijo</option>
        <option value="Variable">Variable</option>
      </select>
      <select id="egresoSubtipo">
        <!-- Opciones de subtipos, se pueden editar -->
        <option value="">-- Selecciona Subtipo --</option>
      </select>
      <button type="button" onclick="agregarNuevoSubtipo()">+</button>
      <button type="button" onclick="eliminarSubtipo()">-</button>
      <input type="number" id="egresoCantidad" placeholder="Cantidad" step="0.01" />
      <input type="number" id="egresoDescuento" placeholder="Descuento" step="0.01" />
      <button onclick="agregarEgreso()">Agregar</button>
    </div>
    <!-- Tabla de egresos -->
    <table class="finanzas-table" id="tablaEgresos">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Subtipo</th>
          <th>Cantidad</th>
          <th>Descuento</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filas generadas dinámicamente -->
      </tbody>
    </table>
  </div>
<div class="tab-content" id="contentFinanzasIngresos">
  <h2>Administrador de Finanzas - Ingresos</h2>
<!-- NUEVA SECCIÓN DE FILTROS PARA INGRESOS -->
    <!-- Gráficos para ingresos -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
      <div class="chart-container">
        <canvas id="chartIngresosLineal"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartIngresosCircular"></canvas>
      </div>
    </div>
  <div class="finanzas-form" style="margin-bottom:10px;">
    <label>Filtrar Tipo:</label>
    <select id="filtroIngresosTipo"></select>

    <label>Filtrar Subtipo:</label>
    <select id="filtroIngresosSubtipo"></select>

    <button onclick="filtrarIngresos()">Aplicar</button>
  </div>
  <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
    <div class="finanzas-card">
      <h3>Total Bruto Esperado</h3>
      <p id="ingresosBruto">S/ 0.00</p> <!-- Cambiamos id e texto -->
    </div>
    <div class="finanzas-card">
      <h3>Total Neto</h3>
      <p id="ingresosNetos">S/ 0.00</p>
    </div>
  </div>
    <!-- Tabla de ingresos (solo visualización) -->
    <table class="finanzas-table" id="tablaIngresos">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Subtipo</th>
          <th>Total</th>
          <th>Pagó Mensualidad</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filas generadas dinámicamente -->
      </tbody>
    </table>

  </div>
</div>
<!-- =================== CONTENEDOR USERS =================== -->
<div class="app-container" id="usersContainer" style="display:none;">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabUsersMain" onclick="openTabUsers('UsersMain')">Usuarios</div>
    <!-- Ocultamos la pestaña de Editar Usuario por defecto -->
    <div class="tab" id="tabEditUser" style="display:none;" onclick="openTabUsers('EditUser')">Editar Usuario</div>
  </div>

  <!-- Contenido pestaña principal: lista y creación de usuarios -->
  <div class="tab-content activeTabContent" id="contentUsersMain">
    <h2>Administrador de Usuarios</h2>
    <div id="usersList" style="margin-top:10px;"></div>

    <h3 style="margin-top:20px;">Crear nuevo usuario</h3>
    <div style="display:flex; gap:10px; align-items:center;">
      <input type="text" id="newUserName" placeholder="Usuario" />
      <input type="password" id="newUserPass" placeholder="Contraseña" />
      <button onclick="crearUser()">Crear</button>
    </div>
  </div>

  <!-- Contenido pestaña para editar un usuario -->
  <div class="tab-content" id="contentEditUser">
    <h2 id="currentUserTitle"></h2>
    <p>Define los permisos para el usuario</p>
    <div style="display:flex; flex-direction:column; gap:6px;">
      <label><input type="checkbox" id="permMacros"/> Macros</label>
      <label><input type="checkbox" id="permMacrosNinos"/> Macros - Niños</label>
      <label><input type="checkbox" id="permServices"/> Servicios</label>
      <label><input type="checkbox" id="permServicesVariants"/> Servicios - Variantes</label>
      <label><input type="checkbox" id="permServicesChildren"/> Servicios - Niños</label>
      <label><input type="checkbox" id="permMatriculas"/> Matrículas</label>
      <label><input type="checkbox" id="permFinanzas"/> Finanzas</label>
      <label style="margin-left:20px;"><input type="checkbox" id="permFinanzasTotal"/> - Total</label>
      <label style="margin-left:20px;"><input type="checkbox" id="permFinanzasEgresos"/> - Egresos</label>
      <label style="margin-left:20px;"><input type="checkbox" id="permFinanzasIngresos"/> - Ingresos</label>
    </div>
    <button style="margin-top:10px;" onclick="guardarPermisosUsuario()">Guardar Permisos</button>
  </div>
</div>

<!-- =================== FICHA INFORMATIVA =================== -->
<div id="fichaInformativaPanel">
  <button class="bottom-left-btn" onclick="goBackFicha()">Regresar</button>
  <h2>Ficha Informativa</h2>
  <div id="fichaContent" style="margin-bottom:30px;"></div>
</div>

<!-- Coloca esto al inicio del bloque de <script> en tu dashboard -->
<script type="module" defer>
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  /* ⬇️  TUS CREDENCIALES PROPIAS (las que acabas de pasarme) */
  const SUPABASE_URL = 'https://grootjniffhweeuegwsn.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyb290am5pZmZod2VldWVnd3NuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwOTUzMDAsImV4cCI6MjA2NTY3MTMwMH0.hrTwlWaO4aPOLXMSrEyPHgUh9O8ql_qh2NA53birE6I';

  /* ➡️  Cliente global accesible en todos tus scripts */
  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    getDocs,
    deleteDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCPSya0kEAydB8_WxEbei56KF36ZmJ1n7I",
    authDomain: "definitivo-4841f.firebaseapp.com",
    projectId: "definitivo-4841f",
    storageBucket: "definitivo-4841f.firebasestorage.app",
    messagingSenderId: "92662019661",
    appId: "1:92662019661:web:de3ccc7b6b5ae5e4134e04"
  };

  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);
  /* ---------- UTILIDAD PARA BLOQUEAR ELIMINACIONES MASIVAS ---------- */
const _delTimes_ = [];                                   // timestamps en ms
function _canDelete(n){
  const now = Date.now();
  for(let i=_delTimes_.length-1;i>=0;i--){
    if(now - _delTimes_[i] > 60_000) _delTimes_.splice(i,1); // descarta >1 min
  }
  if(_delTimes_.length + n > 3) return false;               // máx. 3 niños/min
  while(n--) _delTimes_.push(now);
  return true;
}

/* ---------- CLON Y DETECCIÓN DE ELIMINADOS ---------- */
const deepCopy = obj => JSON.parse(JSON.stringify(obj));
const diffRemoved = (oldArr,newArr)=>{
  const oldIds=new Set(), newIds=new Set();
  oldArr.forEach(s=>s.children.forEach(c=>oldIds.add(c.id)));
  newArr.forEach(s=>s.children.forEach(c=>newIds.add(c.id)));
  let gone=0; oldIds.forEach(id=>{ if(!newIds.has(id)) gone++; });
  return gone;
};

/* ---------- CARGA Y GUARDADO DE SERVICES CON BLINDAJE ---------- */
let prevServicesSnap = [];
async function loadFromFirebaseServices(){
  const snap = await getDoc(doc(db,"data","servicesData"));
  if(!snap.exists()) return;
  services = snap.data().services || [];
  prevServicesSnap = deepCopy(services);
}
async function saveToFirebaseServices(){
  const eliminados = diffRemoved(prevServicesSnap,services);
  if(!_canDelete(eliminados)){
    alert("⚠️  Se bloquearon cambios: límite de 3 niños eliminados por minuto.");
    services = deepCopy(prevServicesSnap);                 // rollback
    return;
  }
  prevServicesSnap = deepCopy(services);
  await setDoc(doc(db,"data","servicesData"),{
    services, nextServiceId, nextVariantId, nextServiceChildId
  },{merge:true});
}
/* ------------------------------------------------------------------
   Garantiza IDs únicos para todas las variantes y actualiza a
   los niños que las usan.  (se ejecuta una sola vez en cada carga)
   ------------------------------------------------------------------ */
function sanitizeVariantIds(){
  let maxId = 0;
  const usado = new Map();              // id → servicio que lo usa

  services.forEach(serv => {
    serv.variants.forEach(v => {
      maxId = Math.max(maxId, v.id);

      if (usado.has(v.id)) {            // ← id duplicado detectado
        const nuevoId = ++maxId;
        console.warn(`ID duplicado ${v.id} en «${serv.title}», `
                    +`re-asignado a ${nuevoId}`);

        const viejoId = v.id;
        v.id = nuevoId;                 // actualiza variante

        /* actualiza todos los niños que apuntaban a ese id */
        services.forEach(s=>{
          s.children.forEach(c=>{
            if(c.variantId === viejoId){
              c.variantId   = nuevoId;
              c.variantName = v.name;    // mantiene el nombre correcto
            }
          });
        });
      }
      usado.set(v.id, serv.title);
    });
  });
  nextVariantId = maxId + 1;            // asegura futuros ids únicos
}

function agregarOguardarChild(){
  if(!editingServiceId){ alert('No hay servicio seleccionado.'); return; }
  const serv = services.find(s=>s.id===editingServiceId);
  if(!serv) return;

  const name     = document.getElementById('childName').value.trim().toUpperCase();
  const lastname = document.getElementById('childLastname').value.trim().toUpperCase();
  const dniPadre = document.getElementById('childDniPadre').value.trim();
  const day      = document.getElementById('childDay').value.trim();
  const mesSel   = document.getElementById('servicesMes').value;           // YYYY-MM
  const sel      = document.getElementById('childVariantSelect');

  /* — id y nombre de la variante (o año) — */
  let variantId   = null;
  let variantName = '';
  if(!sel.disabled){
    variantId   = parseInt(sel.value);
    variantName = sel.options[sel.selectedIndex].textContent;
  }else if(serv.variants.length === 1){
    variantId   = serv.variants[0].id;
    variantName = serv.variants[0].name;
  }

  if(!name || !lastname || !day){
    alert('Completa todos los campos'); return;
  }
  const precio = (serv.variants.find(v=>v.id===variantId)?.price) || 0;

  if(editingServiceChildId===null){                /* NUEVO ---------------- */
    serv.children.push({
      id : nextServiceChildId++,
      name, lastname,
      dniPadre,
      date        : `${mesSel}-${String(parseInt(day)).padStart(2,'0')}`,
      variantId,
      variantName,                                // 💡 se guarda el nombre
      mesRegistro : mesSel,
      mesBaja     : null,
      total       : precio,
      ficha       : {},
      fichaCompleta:false,
      pagoPorMes  : { [mesSel]: false },
      fechaPagoPorMes : {},
      partialPayments  : {},
      deudaPorMes      : {},
      pensionesAtrasadas: 0,
      lastPagoCheck    : getYearMonth()
    });
  }else{                                           /* EDICIÓN -------------- */
    const ch = serv.children.find(c=>c.id===editingServiceChildId);
    if(ch){
      Object.assign(ch,{
        name, lastname, dniPadre,
        date:`${mesSel}-${String(parseInt(day)).padStart(2,'0')}`,
        variantId, variantName,
        total:precio
      });
    }
    editingServiceChildId = null;
    document.getElementById('btnChildPrincipal').textContent = 'Agregar Niño';
  }

  clearChildForm();
  renderChildrenTable(serv.children, mesSel);
  saveToFirebaseServices();
}

/* ---------- DAR DE BAJA UN NIÑO ---------- */
function deleteServiceChild(childId){
  const serv = services.find(s => s.id === editingServiceId);
  if(!serv) return;
  const idx = serv.children.findIndex(c => c.id === childId);
  if(idx === -1) return;
  const ch  = serv.children[idx];

  const mesSel = document.getElementById('servicesMes').value || getYearMonth();
  const full   = `${ch.name} ${ch.lastname}`.trim();
  if(!confirm(`¿Dar de baja a ${full}?`)) return;

  /* ▶️ si mes de registro === mes a dar de baja → borrado físico */
  if(ch.mesRegistro === mesSel){
    serv.children.splice(idx,1);               // eliminación real
  }else{
    ch.mesBaja = mesSel;                       // baja lógica
  }
  saveToFirebaseServices();
  renderChildrenTable(serv.children, mesSel);
}
/* =====================================================
   0.  Loader helpers  –  fade-in  ➜  callback  ➜  fade-out
   ===================================================== */
/* ========== loader liviano para comprobantes ========== */
/* ░░░ Loader liviano para los comprobantes ░░░ */
function ensureProofLoader(){
  let l = document.getElementById('proofLoader');
  if(!l){
    l = document.createElement('div');
    l.id = 'proofLoader';
    l.innerHTML = '<div class="proof-spinner"></div>';
    document.body.appendChild(l);
  }
  return l;
}

/* ── aparece ── */
function fadeInProofLoader(){
  return new Promise(res=>{
    const L   = ensureProofLoader();
    const fin = ()=>{ L.ontransitionend=null; clearTimeout(tid); res(); };
    const tid = setTimeout(fin, 400);          // fallback de 0,4 s

    L.classList.add('active');
    requestAnimationFrame(()=>{
      L.style.opacity = '1';                   // dispara la transición
      L.ontransitionend = e=> e.propertyName==='opacity' && fin();
    });
  });
}

/* ── desaparece ── */
function fadeOutProofLoader(){
  return new Promise(res=>{
    const L   = ensureProofLoader();
    const fin = ()=>{ L.ontransitionend=null; clearTimeout(tid);
                      L.classList.remove('active'); res(); };
    const tid = setTimeout(fin, 400);          // fallback

    L.style.opacity = '0';
    L.ontransitionend = e=> e.propertyName==='opacity' && fin();
  });
}

/* wrapper idéntico a withLoader() pero solo para comprobantes */
async function withProofLoader(cb){
  await fadeInProofLoader();
  try{ await cb(); }
  finally{ await fadeOutProofLoader(); }
}


function ensureLoader(){
  let l = document.getElementById('appLoader');
  if(!l){
    l = document.createElement('div');
    l.id = 'appLoader';
    l.innerHTML = '<div class="loader-ring"></div>';
    document.body.appendChild(l);
  }
  return l;
}
function fadeInLoader(){
  return new Promise(res=>{
    const l = ensureLoader();
    l.classList.add('active');
    l.style.opacity = '0';
    requestAnimationFrame(()=>{
      l.style.opacity = '1';
      l.ontransitionend = e=>{
        if(e.propertyName==='opacity'){ l.ontransitionend=null; res(); }
      };
    });
  });
}
function fadeOutLoader(){
  return new Promise(res=>{
    const l = ensureLoader();
    l.style.opacity = '0';
    l.ontransitionend = e=>{
      if(e.propertyName==='opacity'){
        l.ontransitionend=null;
        l.classList.remove('active');
        res();
      }
    };
  });
}
/* 👉 wrapper: llama tu lógica entre fade-in y fade-out */
async function withLoader(cb){
  await fadeInLoader();
  try{ await cb(); }
  finally{ await fadeOutLoader(); }
}


/* Para compatibilidad con llamadas existentes --------------- */
function showLoader(){ document.getElementById('appLoader').classList.add('active'); document.getElementById('appLoader').style.opacity='1'; }
function hideLoader(){ document.getElementById('appLoader').style.opacity='0'; document.getElementById('appLoader').classList.remove('active'); }

/* ---------- ELIMINAR SERVICIO COMPLETO ---------- */
function deleteService(serviceTitle){
  const idx  = services.findIndex(s => s.title === serviceTitle);
  if(idx === -1) return;

  const serv = services[idx];
  const n    = serv.children.length;

  if(!_canDelete(n)){
    alert("Límite de eliminaciones alcanzado (máx. 3 niños por minuto).");
    return;
  }
  if(!confirm(`¿Seguro de eliminar “${serviceTitle}” y todos sus niños?`)) return;

  services.splice(idx,1);
  showServicesList();
  saveToFirebaseServices();
}



/* ============== 3.  COPIA PROFUNDA & SNAPSHOT PARA GUARDADO ============== */

  // Recuperar usuario y permisos del localStorage
let proofChild   = null;   // referencia al objeto niño
let proofMesKey  = null; 
let services=[], nextServiceId=1,nextVariantId=1,nextServiceChildId=1;
let currentUser = {
  username: localStorage.getItem("usuario"),
  permisos: JSON.parse(localStorage.getItem("permisos") || "{}")
};

if (!currentUser.username) {
  window.location.href = "login.html";
} else {
  // Ya tengo currentUser, así que aplico permisos:
  applyPermissionsToMenus();
}

  /*************************************************************
   * Global Variables and Screen Navigation
   *************************************************************/
  let editingVariantName = null;
  let screenStack = ["landing"];
  let updatingFromFirestore = false;
  let childrenSearchTerm = '';
  let matriculasSearchTerm = '';
  let users = [];
  let editingUsername = null;
  let subtiposEgresos = ["Planilla", "Agua", "Luz", "Internet"]; 
  let editingEgresoId = null;

async function goToMacros(){
  if(!currentUser || !currentUser.permisos.macros){
    alert("No tienes permiso para acceder a Macros."); return;
  }
  await withLoader(async ()=>{
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('macrosContainer').classList.add('activeContainer');
    screenStack.push("macros");
    await initMacros();
  });
}

// 2) Autoajusta el ancho de columnas
function autoFitColumns(ws, data) {
  const cols = [];
  const headers = Object.keys(data[0] || {});
  headers.forEach((h, i) => {
    let maxLen = h.length;
    data.forEach(row => {
      const v = row[h] != null ? row[h].toString() : '';
      if (v.length > maxLen) maxLen = v.length;
    });
    cols[i] = { wch: maxLen + 2 };
  });
  ws['!cols'] = cols;
}

// 3) Estiliza encabezados y celdas
function styleSheet(ws, data) {
  const headerRow = 0;
  const headers = Object.keys(data[0] || {});
  headers.forEach((h, i) => {
    const addr = XLSX.utils.encode_cell({ r: headerRow, c: i });
    const cell = ws[addr];
    if (cell) cell.s = {
      fill:      { patternType: "solid", fgColor: { rgb: "FFFF00" } },
      font:      { bold: true },
      alignment: { horizontal: "left", vertical: "center" }
    };
  });
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = 1; R <= range.e.r; ++R) {
    for (let C = 0; C <= range.e.c; ++C) {
      const addr = XLSX.utils.encode_cell({ r: R, c: C });
      const cell = ws[addr];
      if (cell) {
        cell.s = cell.s || {};
        cell.s.alignment = { horizontal: "left", vertical: "center" };
        if (typeof cell.v === "number") cell.s.numFmt = "#,##0.00";
      }
    }
  }
}
/* ░░░ MIGRACIÓN DE COMPROBANTES BASE-64 ░░░ */
/* ░░░ MIGRACIÓN v2 ░░░  –  renombra “.blob” binarios reales  */
window.migrateOldProofs = async function migrateOldProofs(){
  let procesados = 0, renombrados = 0;

  for(const serv of services){
    for(const ch of serv.children){
      const proofs = ch.paymentProof || {};
      for(const [mes,info] of Object.entries(proofs)){
        procesados++;
        if(!info.filePath.endsWith('.blob')) continue;   // ya corregido

        try{
          /* ① descargamos el objeto */
          const res  = await fetch(info.url,{mode:'cors'});
          const mime = res.headers.get('content-type') || '';
          const body = await res.blob();

          /* — si era texto/plain seguimos con la lógica del v1 — */
          if (mime.startsWith('text/plain')) {
            const text = await body.text();
            if(!text.startsWith('data:')) continue;      // algo raro, omitimos

            const { publicUrl,fileName,filePath } =
              await uploadProofToSupabase(text, mes, ch.id);

            await supabase.storage.from('comprobantes').remove([info.path]);
            proofs[mes] = { name:fileName,url:publicUrl,path:filePath };
            renombrados++;
          }
          /* — si YA es binario: solo re-subimos con extensión real — */
          else{
            const extMap = {
              'image/png':'png','image/jpeg':'jpg','image/webp':'webp',
              'application/pdf':'pdf',
              'application/msword':'doc',
              'application/vnd.openxmlformats-officedocument.wordprocessingml.document':'docx'
            };
            const ext = extMap[mime] || mime.split('/').pop() || 'bin';

            const { publicUrl,fileName,filePath } =
              await uploadProofToSupabase(
                     new File([body], `file.${ext}`, {type:mime}),
                     mes, ch.id);

            await supabase.storage.from('comprobantes').remove([info.path]);
            proofs[mes] = { name:fileName,url:publicUrl,path:filePath };
            renombrados++;
          }

        }catch(e){ console.error('Error migrando',info.path,e); }
      }
    }
  }

  if(renombrados) await saveToFirebaseServices();
  alert(`Renombrados correctamente: ${renombrados} / ${procesados}`);
};


// 4) Exporta Histórico o Actual, incluyendo deuda por atrasos y parciales
function exportServiceExcel(type){
  const serv = services.find(s=>s.id===editingServiceId);
  if(!serv) return;
  const currentYM = getYearMonth();

  let children = type==='Actual'
      ? serv.children.filter(ch=>childIsActiveInMonth(ch,currentYM))
      : serv.children;

  const toDDMMYYYY = iso=>{
    if(!iso) return '';
    const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`;
  };

  const rows = children.map(ch=>{
    const fechasPag = Object.values(ch.fechaPagoPorMes||{})
                      .map(toDDMMYYYY).join(', ');

const partialDebt = Object.values(ch.deudaPorMes || {}).reduce((s,v)=>s+v,0);
const overdueDebt = (ch.pensionesAtrasadas || 0) * (ch.total || 0);

/* ▲ deuda del MES que se está exportando  */
let currentDebt = 0;
if (ch.partialPayments?.[currentYM] != null) {
  /* pago parcial → resta lo abonado */
  currentDebt = (ch.total || 0) - ch.partialPayments[currentYM];
} else {
  /* “Sí” o “No” cuentan la pensión completa */
  currentDebt = ch.total || 0;
}

const totalDebt = partialDebt + overdueDebt + currentDebt;


    let paidSum = 0;
    Object.values(ch.partialPayments||{}).forEach(p=>paidSum+=p);
    Object.entries(ch.pagoPorMes||{}).forEach(([m,v])=>{
      if(v) paidSum += ch.total||0;
    });

    return {
      'Nombre y Apellidos' : `${ch.name} ${ch.lastname}`,
      'Variante'           : getVariantName(ch.variantId)||'',
      'DNI Padre'          : ch.dniPadre||'',
      'Fecha de Ingreso'   : ch.date,
      'Fecha de Baja'      : ch.mesBaja || '',            // NUEVO
      'Fechas de Pago'     : fechasPag,                   // NUEVO formato
      'Deuda actual (S/)'  : totalDebt,
      'Pensiones atrasadas': ch.pensionesAtrasadas||0,
      'Dinero pagado (S/)' : paidSum
    };
  });

  const wb = XLSX.utils.book_new();
  if(rows.length){
    const ws = XLSX.utils.json_to_sheet(rows,{header:Object.keys(rows[0])});
    autoFitColumns(ws,rows);
    styleSheet(ws,rows);
    XLSX.utils.book_append_sheet(wb,ws,type);
  }
  const d=new Date();
  const fecha=`${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
  XLSX.writeFile(wb,`${type} - ${serv.title} - ${fecha}.xlsx`);
}
document.getElementById('btnProofSave').onclick =
  () => withProofLoader(async () => {

    const inp = document.getElementById('proofFile');
    if (!inp.files.length){ closeProofModal(); return; }

    const file = inp.files[0];
    const preparado = await smartCompress(file);   //  string ó Blob

    /* subida */
    const { publicUrl, fileName, filePath } =
      await uploadProofToSupabase(preparado, proofMesKey, proofChild.id);

    /* guardado en el niño */
    if (!proofChild.paymentProof) proofChild.paymentProof = {};
    proofChild.paymentProof[proofMesKey] = {
      name:fileName, url:publicUrl, path:filePath
    };
    await saveToFirebaseServices();

    /* refresco UI */
    const serv = services.find(s => s.id === editingServiceId);
    renderChildrenTable(serv.children, proofMesKey);
    closeProofModal();
    showPopup('✅ Comprobante subido correctamente.','ok',500);
  });
/* ============================================================
 * 5️⃣  (opcional) asegúrate de tener closeProofModal:
 * ============================================================ */



// 5) Wrappers de llamada
function exportServiceHistoric() { exportServiceExcel('Histórico'); }
function exportServiceCurrent()  { exportServiceExcel('Actual'); }

// 6) Añade los botones al pie de “Administrar Niños”
function addExportButtons() {
  const actions = document.querySelector('#contentServicesChildren .actions');
  if (!actions) return;
  actions.style.justifyContent = 'flex-start';

  [
    ['Exportar Histórico', exportServiceHistoric],
    ['Exportar Actual',    exportServiceCurrent ]
  ].forEach(([text, cb]) => {
    const btn = document.createElement('button');
    btn.textContent = text;
    btn.classList.add('listo-btn');
    Object.assign(btn.style, {
      textAlign: 'left',
      alignSelf: 'flex-start',
      margin:    '0 8px 0 0'
    });
    btn.onclick = cb;
    actions.appendChild(btn);
  });
}

// 7) Ejecutar al cargar
document.addEventListener('DOMContentLoaded', addExportButtons);

  async function loadFinanzasData() {
  try {
    const docRef = doc(db, "data", "finanzas");
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      finanzasData.egresos = data.egresos || [];
      // Si tienes almacenados los subtipos también:
      subtiposEgresos = data.subtipos || subtiposEgresos;
    }
  } catch (error) {
    console.error("Error loading finanzas data:", error);
  }
}
function calcularVariacion(mesKey) {
  const [y,m] = mesKey.split('-').map(Number);
  let ay=y, am=m-1;
  if (am===0) { ay--; am=12; }
  const prevKey = `${ay}-${String(am).padStart(2,'0')}`;
  const prev = finanzasData.resumenMensual[prevKey]?.netoTotales  || 0;
  const curr = finanzasData.resumenMensual[mesKey]?.netoTotales   || 0;
  return prev ? ((curr - prev)/prev)*100 : 0;
}

async function saveFinanzasData() {
  try {
    const docRef = doc(db, "data", "finanzas");
    const data = {
      egresos: finanzasData.egresos,
      subtipos: subtiposEgresos,
  resumenMensual: finanzasData.resumenMensual
    };
    await setDoc(docRef, data, { merge: true });
    console.log("Finanzas data saved to Firebase");
  } catch (error) {
    console.error("Error saving finanzas data:", error);
  }
}

async function goToServices(){
  if(!currentUser || !currentUser.permisos.services){
    alert("No tienes permiso para acceder a Servicios."); return;
  }
  await withLoader(async ()=>{
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('servicesContainer').classList.add('activeContainer');
    screenStack.push("services");
    await initServices();
  });
}

async function goToMatriculas(){
  if(!currentUser || !currentUser.permisos.matriculas){
    alert("No tienes permiso para acceder a Matrículas."); return;
  }
  await withLoader(async ()=>{
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('matriculasContainer').classList.add('activeContainer');
    screenStack.push("matriculas");
    await initMatriculas();
  });
}

async function goToFinanzas(){
  if(!currentUser || !currentUser.permisos.finanzas){
    alert("No tienes permiso para acceder a Finanzas."); return;
  }
  await withLoader(async ()=>{
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('finanzasContainer').classList.add('activeContainer');
    screenStack.push("finanzas");

    await loadFromFirebaseServices();
    await initFinanzas();
    initFinanzasRealTime();
  });
}

function goBack() {
  screenStack.pop(); 

  /* Ocultar / limpiar todo */
  document.getElementById('landingPage').classList.add('hidden');
  document.getElementById('macrosContainer').classList.remove('activeContainer');
  document.getElementById('servicesContainer').classList.remove('activeContainer');
  document.getElementById('matriculasContainer').classList.remove('activeContainer');
  document.getElementById('finanzasContainer').classList.remove('activeContainer');

  /* ➡ OCULTA TAMBIÉN el de Usuarios */
  const uc = document.getElementById('usersContainer');
  uc.classList.remove('activeContainer');      // ⬅ **<– nueva línea**
  uc.style.display = 'none';

  /* Mostrar la pantalla correspondiente */
  const current = screenStack[screenStack.length - 1] || "landing";
  if (current === "landing")          document.getElementById('landingPage').classList.remove('hidden');
  else if (current === "macros")      document.getElementById('macrosContainer').classList.add('activeContainer');
  else if (current === "services")    document.getElementById('servicesContainer').classList.add('activeContainer');
  else if (current === "matriculas")  document.getElementById('matriculasContainer').classList.add('activeContainer');
  else if (current === "finanzas")    document.getElementById('finanzasContainer').classList.add('activeContainer');
  else if (current === "users")       uc.style.removeProperty('display');

  /* vuelve al tope de la página */
  window.scrollTo(0,0);
}



  function goBackFicha(){
    screenStack.pop();
    document.getElementById('fichaInformativaPanel').style.display = 'none';
    const curr = screenStack[screenStack.length - 1];
    if (curr === "matriculas") {
      document.getElementById('matriculasContainer').classList.add('activeContainer');
      renderMatriculasList();
    } else {
      goBack();
    }
  }
/* --- Helpers de fechas --- */
function openDayPicker(){
  const inp    = document.getElementById('childDay');
  const picker = document.getElementById('dayPicker');
  picker.innerHTML = '';

  const total = daysInSelectedMonth();
  for(let d=1; d<=total; d++){
    const btn = document.createElement('button');
    btn.textContent = d;
    btn.onclick = () => {
      inp.value = d;
      picker.classList.add('hidden');
    };
    picker.appendChild(btn);
  }

  /* posición bajo el input */
  const rect = inp.getBoundingClientRect();
  picker.style.top  = rect.bottom + window.scrollY + 4 + 'px';
  picker.style.left = rect.left   + window.scrollX + 'px';
  picker.classList.remove('hidden');
}

/* ——— cerrar si se hace clic fuera ——— */
document.addEventListener('click', e=>{
  const picker = document.getElementById('dayPicker');
  if(!picker.contains(e.target) && e.target.id !== 'childDay'){
    picker.classList.add('hidden');
  }
});

function daysInSelectedMonth(){
  const [y,m] = document.getElementById('servicesMes').value.split('-').map(Number);
  return new Date(y, m, 0).getDate();        // último día del mes
}
function actualizarResumenMensual(mesKey){
  finanzasData.resumenMensual[mesKey] = {
    brutoEsperado : calcularIngresosBrutoEsperado(mesKey),
    netoEsperado  : calcularIngresosNetoEsperado(mesKey),
    brutoTotales  : calcularIngresosBrutosTotales(mesKey),
    netoTotales   : calcularIngresosNetosTotales(mesKey),
    egresosTotales: calcularEgresosTotales(
                      finanzasData.egresos.filter(e =>
                        `${e.anio}-${String(e.mes).padStart(2,'0')}`===mesKey))
  };

  /* 👇 Sólo guarda si la llamada viene de una acción del usuario */
  if(!updatingFromFirestore){
    saveFinanzasData();
  }
}

function childIsActiveInMonth(child, mesKey){
  /*   Sigue activo si:
       – se matriculó en o antes de «mesKey»  y
       – (no tiene mesBaja)  o  (mesKey < mesBaja)                */
  return child.mesRegistro <= mesKey &&
         (!child.mesBaja || mesKey < child.mesBaja);
}

function strToYYYYMM(str){                     // "2025-05" -> 202505
  return parseInt(str.replace('-',''));
}

/* --- Ingresos esperados / reales --- */
function calcularIngresosBrutoEsperado(mesKey){
  let total = 0;
  services.forEach(serv=>{
    serv.children.forEach(ch=>{
      if(childIsActiveInMonth(ch, mesKey)){
        total += ch.total || 0;                 // precio de su variante
      }
    });
  });
  return total;
}

function calcularIngresosBrutosTotales(mesKey) {
  let total = 0;
  services.forEach(serv => {
    serv.children.forEach(c => {
      if (!childIsActiveInMonth(c, mesKey)) return;

      const parc = c.partialPayments?.[mesKey];
      if (parc != null) {
        // si hay pago parcial, lo sumamos
        total += parc;
      } else if (c.pagoPorMes?.[mesKey]) {
        // si marcó Sí, sumamos el total completo
        total += c.total || 0;
      }
    });
  });
  return total;
}
function calcularIngresosNetoEsperado(mesKey){
  return calcularIngresosBrutoEsperado(mesKey) -
         calcularEgresosTotales(finanzasData.egresos
           .filter(e => `${e.anio}-${String(e.mes).padStart(2,'0')}` === mesKey));
}

function calcularIngresosNetosTotales(mesKey){
  return calcularIngresosBrutosTotales(mesKey) -
         calcularEgresosTotales(finanzasData.egresos
           .filter(e => `${e.anio}-${String(e.mes).padStart(2,'0')}` === mesKey));
}
async function attemptLogin(){
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;

  if(!username || !password){
    alert("Completa usuario y contraseña");
    return;
  }
  try {
    // Buscar doc en la colección "users"
    const docRef = doc(db, "users", username);
    const docSnap = await getDoc(docRef);
    if(!docSnap.exists()){
      alert("Usuario no encontrado en la base de datos.");
      return;
    }
    const userData = docSnap.data();
    if(userData.password !== password){
      alert("Contraseña incorrecta.");
      return;
    }

    // Si coincide, login exitoso
    currentUser = {
      username: userData.username,
      permisos: userData.permisos || {}
    };

    // Oculta login, muestra landing
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('landingPage').classList.remove('hidden');

    // Muestra botón de logout
    document.getElementById('logoutContainer').style.display = 'block';

    // Aplica permisos en la interfaz
    applyPermissionsToMenus();

  } catch (err) {
    console.error("Error en login:", err);
    alert("Error al iniciar sesión.");
  }
}

function logout(){
  // Limpiar la variable actual y el almacenamiento local
  currentUser = null;
  localStorage.removeItem("usuario");
  localStorage.removeItem("permisos");

  // Ocultar todos los contenedores de la app
  document.getElementById('landingPage').classList.add('hidden');
  document.getElementById('macrosContainer').classList.remove('activeContainer');
  document.getElementById('servicesContainer').classList.remove('activeContainer');
  document.getElementById('matriculasContainer').classList.remove('activeContainer');
  document.getElementById('finanzasContainer').classList.remove('activeContainer');
  document.getElementById('usersContainer').style.display = 'none';

  // Ocultar el contenedor de logout
  document.getElementById('logoutContainer').style.display = 'none';

  // Redirigir al login
  window.location.href = "login.html";
}

function applyPermissionsToMenus() {
  // Si no hay usuario actual, no hacemos nada
  if (!currentUser) return;

  // Permisos del usuario actual
  const p = currentUser.permisos || {};

  // Muestra u oculta los botones del menú principal
  // (Son los mismos botones que definimos con id en el HTML)
  document.getElementById('btnMacros').style.display     = p.macros      ? 'inline-block' : 'none';
  document.getElementById('btnServices').style.display   = p.services    ? 'inline-block' : 'none';
  document.getElementById('btnMatriculas').style.display = p.matriculas  ? 'inline-block' : 'none';
  document.getElementById('btnFinanzas').style.display   = p.finanzas    ? 'inline-block' : 'none';
  
  // Por ejemplo, "Administrador de Usuarios" solo lo ve un usuario específico
  document.getElementById('btnUsers').style.display = (currentUser.username === "renatozepi") 
                                                      ? 'inline-block'
                                                      : 'none';

  // Si además quieres ocultar pestañas internas, puedes hacer algo similar:
  // Pestaña "Registrar Niños" en Macros
  const tabNinos = document.getElementById('tabNinos');
  if (tabNinos) {
    // Se muestra solo si el usuario tiene el permiso "macrosNinos"
    tabNinos.style.display = p.macrosNinos ? 'block' : 'none';
  }

  // Pestañas de Finanzas
  const tabFinTotal = document.getElementById('tabFinanzasTotal');
  const tabFinEgresos = document.getElementById('tabFinanzasEgresos');
  const tabFinIngresos = document.getElementById('tabFinanzasIngresos');

  if (tabFinTotal) {
    tabFinTotal.style.display = p.finanzasTotal ? 'block' : 'none';
  }
  if (tabFinEgresos) {
    tabFinEgresos.style.display = p.finanzasEgresos ? 'block' : 'none';
  }
  if (tabFinIngresos) {
    tabFinIngresos.style.display = p.finanzasIngresos ? 'block' : 'none';
  }

  // Así puedes controlar cualquier otro elemento que requiera permisos específicos.
}



  /****************************************************
   * MACROS CODE (Con Firebase en lugar de localStorage)
   ****************************************************/
  let macros = [];
  let nextMacroId = 1;
  let nextAlumnoId = 1;
  let editingMacroId = null;
  let editingAlumnoId = null;
  let generateCount = 0;
  const anioActual = new Date().getFullYear();
  const anioDosDig = anioActual.toString().slice(-2);
  const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];

  async function loadFromFirebaseMacros(){
    try {
      const docRef = doc(db, "data", "macrosAlumnos");
      const docSnap = await getDoc(docRef);
      if(docSnap.exists()){
        const parsed = docSnap.data();
        macros = parsed.macros || [];
        nextMacroId = parsed.nextMacroId || 1;
        nextAlumnoId = parsed.nextAlumnoId || 1;
      } else {
        macros = [];
        nextMacroId = 1;
        nextAlumnoId = 1;
      }
    } catch(error){
      console.error("Error loading macros from Firebase:", error);
    }
  }
async function uploadProofToSupabase(fileOrData, mesKey, childId){
  /* ── 1.  Normalizar a Blob ─────────────────────────────── */
  let blob, ext, mime;

  if (typeof fileOrData === 'string') {                 //  data-URL
    /* data:image/png;base64,AAAA… → split */
    const [header, b64] = fileOrData.split(',');
    mime = header.match(/data:(.*?);/)[1];              // image/png
    ext  = mime.split('/').pop();                       // png

    /* decodificamos Base-64 */
    const bin  = atob(b64);
    const buf  = Uint8Array.from(bin, ch => ch.charCodeAt(0));
    blob = new Blob([buf], { type: mime });

  } else {                                              //  File / Blob
    blob = fileOrData;
    mime = blob.type || 'application/octet-stream';
    ext  = (blob.name || 'file').split('.').pop();
  }

  /* ── 2.  Generar ruta destino ─────────────────────────── */
  const dir      = `${mesKey}/${childId}`;
  const fileName = `${Date.now()}.${ext}`;
  const filePath = `${dir}/${fileName}`;

  /* ── 3.  Subir a Supabase Storage ─────────────────────── */
  const { error } = await supabase
    .storage
    .from('comprobantes')
    .upload(filePath, blob, { upsert:true, contentType:mime });

  if (error) throw error;

  const { data:{ publicUrl } } = supabase
    .storage
    .from('comprobantes')
    .getPublicUrl(filePath);

  return { publicUrl, fileName, filePath };
}
  async function saveToFirebaseMacros(){
    try {
      const docRef = doc(db, "data", "macrosAlumnos");
      const obj = { macros, nextMacroId, nextAlumnoId };
      await setDoc(docRef, obj, { merge: true });
      console.log("Macros data saved to Firebase");
    } catch(error){
      console.error("Error saving macros to Firebase:", error);
    }
  }
  async function initMacros() {
    await loadFromFirebaseMacros();
    mostrarMacros();
  }
  function mostrarMacros(){
    const container = document.getElementById('macrosList');
    container.innerHTML = '';
    macros.forEach(m => {
      const div = document.createElement('div');
      div.className = 'macro-item';
      const leftSpan = document.createElement('span');
      leftSpan.textContent = `${m.titulo} (Alumnos: ${m.alumnos.length})`;
      const rightDiv = document.createElement('div');
      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.onclick = () => editarMacro(m.id);
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Eliminar';
      btnDel.onclick = () => eliminarMacro(m.id);
      rightDiv.appendChild(btnEdit);
      rightDiv.appendChild(btnDel);
      div.appendChild(leftSpan);
      div.appendChild(rightDiv);
      container.appendChild(div);
    });
  }
  function crearMacro(){
    const titulo = document.getElementById('tituloMacro').value.trim();
    if(!titulo){
      alert('Ingresa un título para la macro');
      return;
    }
    const nueva = { id: nextMacroId++, titulo, alumnos: [] };
    macros.push(nueva);
    document.getElementById('tituloMacro').value = '';
    mostrarMacros();
    saveToFirebaseMacros();
    editarMacro(nueva.id);
  }
  function editarMacro(macroId){
    editingMacroId = macroId;
    const mac = macros.find(m => m.id === macroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    openTabMacros('Ninos');
    document.getElementById('currentMacroTitle').textContent = mac.titulo;
    mostrarAlumnosEnTablaMacros(mac.alumnos);
  }
  function eliminarMacro(macroId){
    if(!confirm('¿Seguro de eliminar esta macro?')) return;
    macros = macros.filter(m => m.id !== macroId);
    mostrarMacros();
    saveToFirebaseMacros();
  }
  function mostrarAlumnosEnTablaMacros(arr){
    const tbody = document.getElementById('tbodyNinos');
    tbody.innerHTML = '';
    arr.forEach(al => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = al.nombre;
      row.insertCell(1).textContent = al.apellidos;
      row.insertCell(2).textContent = `CJ${anioDosDig}${al.codigoRestante}`;
      row.insertCell(3).textContent = al.fechaInscripcion;
      row.insertCell(4).textContent = al.importe.toFixed(2);
      const accCell = row.insertCell(5);
      const btnE = document.createElement('button');
      btnE.textContent = '✎';
      btnE.onclick = () => editarNinoMacros(al.id);
      accCell.appendChild(btnE);
      const btnD = document.createElement('button');
      btnD.textContent = '🗑️';
      btnD.style.marginLeft = '5px';
      btnD.onclick = () => eliminarAlumnoMacros(al.id);
      accCell.appendChild(btnD);
    });
  }
  function agregarOguardarNino(){
    if(!editingMacroId){
      alert('No hay una macro seleccionada.');
      return;
    }
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    const nombre = document.getElementById('nombre').value.trim().toUpperCase();
    const apellidos = document.getElementById('apellidos').value.trim().toUpperCase();
    const codigoRestante = document.getElementById('codigoRestante').value.trim().toUpperCase();
    const fechaInscripcion = document.getElementById('fechaInscripcion').value;
    const importe = parseFloat(document.getElementById('importe').value);
    if(!nombre || !apellidos || !codigoRestante || !fechaInscripcion || isNaN(importe)){
      alert('Completa todos los campos');
      return;
    }
    if(editingAlumnoId === null){
      const nuevo = {
        id: nextAlumnoId++,
        nombre,
        apellidos,
        codigoRestante,
        fechaInscripcion,
        importe
      };
      mac.alumnos.push(nuevo);
    } else {
      const idx = mac.alumnos.findIndex(a => a.id === editingAlumnoId);
      if(idx >= 0){
        mac.alumnos[idx].nombre = nombre;
        mac.alumnos[idx].apellidos = apellidos;
        mac.alumnos[idx].codigoRestante = codigoRestante;
        mac.alumnos[idx].fechaInscripcion = fechaInscripcion;
        mac.alumnos[idx].importe = importe;
      }
      editingAlumnoId = null;
      document.getElementById('btnNinoPrincipal').textContent = 'Agregar Niño';
    }
    document.getElementById('nombre').value = '';
    document.getElementById('apellidos').value = '';
    document.getElementById('codigoRestante').value = '';
    document.getElementById('fechaInscripcion').value = '';
    document.getElementById('importe').value = '';
    mostrarAlumnosEnTablaMacros(mac.alumnos);
    saveToFirebaseMacros();
  }
  function editarNinoMacros(alumnoId){
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac) return;
    const al = mac.alumnos.find(a => a.id === alumnoId);
    if(!al) return;
    editingAlumnoId = alumnoId;
    document.getElementById('nombre').value = al.nombre;
    document.getElementById('apellidos').value = al.apellidos;
    document.getElementById('codigoRestante').value = al.codigoRestante;
    document.getElementById('fechaInscripcion').value = al.fechaInscripcion;
    document.getElementById('importe').value = al.importe;
    document.getElementById('btnNinoPrincipal').textContent = 'Guardar Niño';
  }
  function eliminarAlumnoMacros(alumnoId){
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac) return;
    mac.alumnos = mac.alumnos.filter(a => a.id !== alumnoId);
    mostrarAlumnosEnTablaMacros(mac.alumnos);
    saveToFirebaseMacros();
  }
  function guardarYVolver(){
    openTabMacros('Macros');
    mostrarMacros();
    saveToFirebaseMacros();
  }
function generarTxt() {
  if (!editingMacroId) {
    alert("No hay macro seleccionada.");
    return;
  }

  const mac = macros.find(m => m.id === editingMacroId);
  if (!mac) {
    alert("Macro no encontrada");
    return;
  }

  /* ====== parámetros fijos de cabecera (registro 01) ====== */
  generateCount++;                                       // consecutivo local
  const hoy        = new Date();
  const yyyy       = hoy.getFullYear();                  // 2025
  const yy         = yyyy.toString().slice(-2);          // 25
  const fechaFact  = yyyy + String(hoy.getMonth() + 1).padStart(2, "0") +
                     String(hoy.getDate()).padStart(2, "0");

  const ruc            = "10181763472";
  const moneda         = "PEN";
  const numeroClase    = "000";      // BBVA: clase de servicio
  const tipoActu       = "P";        // P = provisión
  const blancosCab     = " ".repeat(322);

  let contenido  = "";
  /* ---------- REGISTRO 01 (cabecera) ----------- */
  contenido +=
      "01" +                 // id registro
      ruc +
      numeroClase +
      moneda +
      fechaFact +
      "001" +                // Nº de lote
      " ".repeat(7) +
      tipoActu +
      blancosCab +
      "\r\n";

  /* ---------- REGISTROS 02 (detalle) ----------- */
  const meses = [
    "ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO",
    "JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"
  ];

  let contadorReg  = 0;
  let importeMin   = Number.POSITIVE_INFINITY;   // en céntimos
  let importeMax   = 0;
  let importeTotal = 0;

  /* Para la fecha de bloqueo (30‑SEP del año siguiente) */
  const fechaBloqueo = `${yyyy + 1}0930`;

  mac.alumnos.forEach(item => {
    const fechaIns = new Date(item.fechaInscripcion);
    const anioIni  = fechaIns.getFullYear();
    const mesIni   = fechaIns.getMonth();        // 0–11
    const diaIns   = String(fechaIns.getDate()).padStart(2, "0");

    /* -------- prefijo CJ / 0CJ según regla del banco -------- */
    const codigoNum  = parseInt(item.codigoRestante, 10);  // ej. '37' → 37
    const prefijo    = codigoNum < 100
                        ? `CJ${yyyy}`      //  CJ2025
                        : `0CJ${yy}`;      // 0CJ25

    for (let m = mesIni; m < 12; m++) {
      const mesNombre = meses[m];                         // texto (ENERO, …)
      const mesStr    = String(m + 1).padStart(2, "0");   // 01‑12

      /* ------------- campo “concepto” (40 car.) ------------- */
      const codigoConc = (
        prefijo +
        item.codigoRestante.padStart(2, "0") +   // asegura 2 dígitos
        mesNombre
      )
        .substring(0, 40)   // si se pasa, corta
        .padEnd(40, " ");   // rellena a la derecha

      /* ------------ importe en céntimos (18 N) -------------- */
      const importeCent = Math.round(item.importe * 100);

      importeMin   = Math.min(importeMin, importeCent);
      importeMax   = Math.max(importeMax, importeCent);
      importeTotal += importeCent;

      /* ---------- armado del registro 02 (360 car.) --------- */
      let linea02 =
        "02" +
        (item.apellidos + " " + item.nombre)           // alumno
          .substring(0, 30)
          .padEnd(30, " ") +
        codigoConc +                                   // concepto
        " ".repeat(8) +                                // libre
        `${anioIni}${mesStr}${diaIns}` +               // fecha venc.
        fechaBloqueo +
        "00" +                                         // tipo de recargo
        String(importeCent).padStart(15, "0") +        // importe mínimo
        String(importeCent).padStart(15, "0") +        // importe máximo
        "0".repeat(180) +                              // blanco / libre
        "L000000000000000";                            // indicador detalle

      /* asegurar 360 */
      linea02 = linea02.padEnd(360, " ");
      contenido += linea02 + "\r\n";
      contadorReg++;
    }
  });

  /* ---------- REGISTRO 03 (trailer) ------------ */
  let linea03 =
    "03" +
    String(contadorReg).padStart(9, "0") +
    String(importeMin) .padStart(18, "0") +
    String(importeMax) .padStart(18, "0") +
    String(importeTotal).padStart(18, "0") +
    " ".repeat(295);

  contenido += linea03; // el 03 no lleva CRLF final según BBVA

  /* ---------- descarga del archivo .TXT ---------- */
  const filename = `carga_bbva_${fechaFact}_${generateCount}.txt`;
  const blob     = new Blob([contenido], { type: "text/plain" });
  const url      = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href     = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}


/* ===========================================================
   ✂ UTILIDADES DE COMPRESIÓN  ≤ 900 kB (Firestore 1 MiB) ✂
   =========================================================== */
const MAX_B64_LEN = 100_048_576;   // 1 MiB en Base-64
const MIN_QUALITY = 0.10;
const MIN_WIDTH   = 1;

function compressImageOnce(file, width, quality){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=>{
      const ratio = Math.min(1, width / img.width);
      const w = img.width  * ratio;
      const h = img.height * ratio;
      const cvs = document.createElement('canvas');
      cvs.width = w; cvs.height = h;
      cvs.getContext('2d').drawImage(img,0,0,w,h);
      cvs.toBlob(blob=>{
        const fr = new FileReader();
        fr.onload  = () => resolve(fr.result);   // dataURL
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      }, 'image/jpeg', quality);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

/* ▸ Convierte cualquier File a dataURL sin compresión */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload  = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

/* ▸ Algoritmo “inteligente” – devuelve siempre un dataURL ≤ 900 kB */
async function smartCompress(file){
  /* — Imágenes (jpeg/png/webp…) — */
  if (file.type.startsWith('image/')) {
    let q = 0.7, w = 1400;
    while (true) {
      const dataUrl = await compressImageOnce(file, w, q);
      if (dataUrl.length <= MAX_B64_LEN ||
          (w <= MIN_WIDTH && q <= MIN_QUALITY)) {
        return dataUrl;                 //  ←  string Base-64
      }
      w = Math.round(w * 0.8);
      q = Math.max(q - 0.05, MIN_QUALITY);
    }
  }

  /* — PDF, Word, etc. —  devuelve el archivo tal cual (Blob) */
  return file;                          //  ←  Blob/File
}

/* ===========================================================
   NUEVA LÓGICA DE SUBIDA  – pop-up en el intento de “subir”
   =========================================================== */

/* ---- variable global temporal para guardar el archivo ya comprimido ---- */
let proofReady = null;   // { data, name }  o  null

/* ---- 1.  Al elegir archivo (change) ------------------------------------ */
document.getElementById('proofFile').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) {            // usuario canceló el diálogo
    proofReady = null;
    return;
  }

  try {
    const dataUrl = await smartCompress(file);   // tu compresor original

    /* ↓  Si incluso después de comprimir sigue > 1 MiB → error inmediato  */
    if (dataUrl.length > MAX_B64_LEN) {
      proofReady = null;
      showPopup('⚠️  El archivo comprimido supera 1 MB. Usa uno más ligero.', 'error');
      return;
    }

    /* Todo bien */
    proofReady = { data: dataUrl, name: file.name };
    /* pop-up de éxito con 0,5 s de retardo */
    showPopup('✅ Archivo listo para subir.', 'ok', 500);

  } catch (err) {
    console.error(err);
    proofReady = null;
    showPopup('❌ Error al procesar el archivo.', 'error');
  }
});




/* ========== BOTÓN CANCELAR ========== */
document.getElementById('btnProofCancel').onclick = closeProofModal;

function openTabMacros(tabName){
  if(tabName==='Macros' && !currentUser.permisos.macros){
    alert("No tienes permiso para la pestaña principal de Macros."); return;
  }
  if(tabName==='Ninos'  && !currentUser.permisos.macrosNinos){
    alert("No tienes permiso para 'Registrar Niños'."); return;
  }

  withLoader(()=>{          /* ← animación */
    document.getElementById('contentMacros').classList.remove('activeTabContent');
    document.getElementById('contentNinos').classList.remove('activeTabContent');
    document.getElementById('tabMacros').classList.remove('activeTab');
    document.getElementById('tabNinos').classList.remove('activeTab');

    if(tabName==='Macros'){
      document.getElementById('contentMacros').classList.add('activeTabContent');
      document.getElementById('tabMacros').classList.add('activeTab');
    }else{
      document.getElementById('contentNinos').classList.add('activeTabContent');
      document.getElementById('tabNinos').classList.add('activeTab');
    }
  });
}


  /**************************************************************
   * ADMIN SERVICES
   **************************************************************/

  let editingVariantId = null;
  let serviceCheckDone = false; 
  let MATRICULA_ID = null;
  let editingServiceId = null;
  let editingServiceChildId = null;
 let editingServiceTitle  = null;
async function initServices(){
  await loadFromFirebaseServices();     // datos desde Firestore
  sanitizeVariantIds();                 // ← evita duplicados
  ensureMatriculaService();
  showServicesList();
  setupDaysButtons();
  initSelectorMes('servicesMes');
}
  function ensureMatriculaService(){
    if(serviceCheckDone) return;
    serviceCheckDone = true;
    let mat = services.find(s => s.title === 'Matrícula');
    if(!mat){
      mat = {
        id: nextServiceId++,
        title: 'Matrícula',
        variants: [],
        children: []
      };
      services.unshift(mat);
      for(let i = 1; i <= 5; i++){
        const v = {
          id: nextVariantId++,
          name: i.toString(),
          price: 480,
          days: ['LUN','MAR','MIE','JUE','VIE'],
          start: '07:30',
          end: '13:00'
        };
        mat.variants.push(v);
      }
      saveToFirebaseServices();
    }
    MATRICULA_ID = mat.id;
  }
function openTabServices(tabName){
  if(tabName==='ServicesMain'     && !currentUser.permisos.services       ){ alert("No tienes permiso."); return; }
  if(tabName==='ServicesVariants' && !currentUser.permisos.servicesVariants){ alert("No tienes permiso."); return; }
  if(tabName==='ServicesChildren' && !currentUser.permisos.servicesChildren){ alert("No tienes permiso."); return; }

  withLoader(()=>{   /* animación de fade */
    ['contentServicesMain','contentServicesVariants','contentServicesChildren']
      .forEach(id => document.getElementById(id).classList.remove('activeTabContent'));
    ['tabServicesMain','tabServicesVariants','tabServicesChildren']
      .forEach(id => document.getElementById(id).classList.remove('activeTab'));

    if(tabName==='ServicesMain'){
      document.getElementById('contentServicesMain').classList.add('activeTabContent');
      document.getElementById('tabServicesMain').classList.add('activeTab');
    }else if(tabName==='ServicesVariants'){
      document.getElementById('contentServicesVariants').classList.add('activeTabContent');
      document.getElementById('tabServicesVariants').classList.add('activeTab');
    }else{
      document.getElementById('contentServicesChildren').classList.add('activeTabContent');
      document.getElementById('tabServicesChildren').classList.add('activeTab');
    }
  });
}



/* ==========================================================
   Muestra la lista de servicios con los niños activos
   en el mes actual (YYYY‑MM), no el total histórico.
   ========================================================== */
function showServicesList(){
  const container = document.getElementById('servicesList');
  container.innerHTML = '';

  /* Matrícula primero */
  services.sort((a,b) => (a.title === 'Matrícula' ? -1 : b.title === 'Matrícula' ? 1 : 0));

  const mesActual = getYearMonth();

  services.forEach(s => {
    const div  = document.createElement('div');
    div.className = 'service-item';

    const ninosMes = s.children.filter(c => childIsActiveInMonth(c, mesActual)).length;
    const left = document.createElement('span');
    left.textContent = `${s.title} (Variantes: ${s.variants.length}) (Niños: ${ninosMes})`;
    div.appendChild(left);

    const right = document.createElement('div');

    if(s.title !== 'Matrícula'){
      const bEd = document.createElement('button');
      bEd.textContent = 'Editar';
      bEd.onclick = () => editService(s.title);
      right.appendChild(bEd);
    }

const bNi = document.createElement('button');
bNi.textContent = 'Administrar Niños';
bNi.onclick = () => openServiceChildren(s.id);   // ← enviamos el ID, no el título
right.appendChild(bNi);

    if(s.title !== 'Matrícula'){
      const bDel = document.createElement('button');
      bDel.textContent = 'Eliminar';
      bDel.style.marginLeft = '5px';
      bDel.onclick = () => deleteService(s.title);
      right.appendChild(bDel);
    }

    div.appendChild(right);
    container.appendChild(div);
  });
}


function crearService(){
  /* ── permisos ── */
  if(!currentUser.permisos.services){
    alert("No tienes permiso para crear servicios.");
    return;
  }
  if(!currentUser.permisos.servicesVariants){
    alert("No tienes permiso para el creador de variantes.");
    return;
  }

  /* ── datos ── */
  const title = document.getElementById('tituloService').value.trim();
  if(!title){
    alert('Ingresa un título para el servicio');
    return;
  }
  if(title === 'Matrícula'){
    alert('“Matrícula” ya existe.');
    return;
  }
  if(services.some(s => s.title === title)){
    alert('Ya existe un servicio con ese nombre.');
    return;
  }

  /* ── crear ── */
const newService = {
  id: getNextServiceId(),   // ← siempre único
  title,
  variants: [],
  children: []
};
  services.push(newService);

  /* limpiar y refrescar */
  document.getElementById('tituloService').value = '';
  showServicesList();
  saveToFirebaseServices();
  editingServiceId    = null;
  editingServiceTitle = null;

  /* abrir Variantes usando el título */
  setTimeout(() => editService(title), 0);
}

function editService(serviceTitle){
  const serv = services.find(s => s.title === serviceTitle);
  if(!serv) return;                    // no existe

  /* guarda nombre + id (id sigue sirviendo internamente) */
  editingServiceTitle = serviceTitle;
  editingServiceId    = serv.id;

  openTabServices('ServicesVariants');
  document.getElementById('currentServiceTitle').textContent = serv.title;
  clearVariantForm();
  renderVariantsTable(serv.variants);
}


  /* Variants logic */
  function setupDaysButtons(){
    const dayLabels = ['LUN','MAR','MIE','JUE','VIE'];
    const container = document.getElementById('daysContainer');
    container.innerHTML = '';
    dayLabels.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'day-btn';
      btn.textContent = d;
      btn.onclick = () => btn.classList.toggle('selected');
      container.appendChild(btn);
    });
  }
  function clearVariantForm(){
    editingVariantId = null;
    document.getElementById('variantName').value = '';
    document.getElementById('variantPrice').value = '';
    document.getElementById('variantStart').value = '';
    document.getElementById('variantEnd').value = '';
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('btnVariantPrincipal').textContent = 'Agregar Variante';
  }
function agregarOguardarVariante(){
  if(!editingServiceTitle){
    alert('No hay servicio seleccionado.'); return;
  }
  const serv = services.find(s => s.title === editingServiceTitle);
  if(!serv){ alert('Servicio no encontrado'); return; }

  const name   = document.getElementById('variantName').value.trim();
  const price  = parseFloat(document.getElementById('variantPrice').value);
  const startT = document.getElementById('variantStart').value;
  const endT   = document.getElementById('variantEnd').value;
  const days   = [...document.querySelectorAll('.day-btn.selected')].map(b=>b.textContent);

  if(!name || isNaN(price) || !startT || !endT){
    alert('Completa todos los campos de la variante'); return;
  }

  /*  evita duplicados de nombre dentro del servicio */
  const existe = serv.variants.some(v => v.name === name && v.name !== editingVariantName);
  if(existe){ alert(`Ya existe una variante “${name}” en este servicio`); return; }

  /*  ——— id global único ——— */
  while (
    serv.variants.some(v => v.id === nextVariantId) ||
    services.some(s => s !== serv && s.variants.some(v => v.id === nextVariantId))
  ){
    nextVariantId++;
  }

  if(editingVariantName === null){        // ☆ NUEVA
    serv.variants.push({
      id   : nextVariantId++,
      name , price , days ,
      start: startT, end: endT
    });
  }else{                                  // ☆ MODIFICAR
    const v = serv.variants.find(v => v.name === editingVariantName);
    if(v) Object.assign(v,{ name, price, days, start:startT, end:endT });
  }

  editingVariantName = null;
  clearVariantForm();
  renderVariantsTable(serv.variants);
  saveToFirebaseServices();
}

function renderVariantsTable(arr){
  const tbody = document.getElementById('tbodyVariants');
  tbody.innerHTML = '';

  arr.forEach(v => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = v.name;
    row.insertCell(1).textContent = v.days.join(', ');
    row.insertCell(2).textContent = `S/${v.price}`;
    row.insertCell(3).textContent = `${v.start} – ${v.end}`;

    const acc = row.insertCell(4);

    /* EDITAR – pasamos el nombre */
    const bEd = document.createElement('button');
    bEd.textContent = 'editar';
    bEd.onclick = () => editVariant(v.name);
    acc.appendChild(bEd);

    /* ELIMINAR – también por nombre */
    const bDel = document.createElement('button');
    bDel.textContent = ' x ';
    bDel.style.marginLeft = '5px';
    bDel.onclick = () => deleteVariant(v.name);
    acc.appendChild(bDel);
  });
}

function editVariant(variantName){
  const serv = services.find(s => s.title === editingServiceTitle);
  if(!serv) return;

  const v = serv.variants.find(x => x.name === variantName);
  if(!v) return;

  editingVariantName = variantName;

  document.getElementById('variantName').value  = v.name;
  document.getElementById('variantPrice').value = v.price;
  document.getElementById('variantStart').value = v.start;
  document.getElementById('variantEnd').value   = v.end;

  document.querySelectorAll('.day-btn').forEach(btn => {
    btn.classList.toggle('selected', v.days.includes(btn.textContent));
  });

  document.getElementById('btnVariantPrincipal').textContent = 'Guardar Variante';
}

function deleteVariant(variantName){
  const serv = services.find(s => s.title === editingServiceTitle);
  if(!serv) return;

  const idx = serv.variants.findIndex(v => v.name === variantName);
  if(idx === -1) return;

  if(!confirm(`¿Eliminar la variante “${variantName}”?`)) return;

  serv.variants.splice(idx,1);
  renderVariantsTable(serv.variants);
  saveToFirebaseServices();
}

  function doneVariants(){
    openTabServices('ServicesMain');
    showServicesList();
    saveToFirebaseServices();
  }
  /* Administrar Niños */
/* ===============================================================
   ABRE la pestaña “Administrar Niños” de un servicio
   =============================================================== */
function openServiceChildren(serviceId){
  /* — Servicio y variables globales — */
  const serv = services.find(s => s.id === serviceId);
  if(!serv) { alert('Servicio no encontrado'); return; }

  editingServiceId    = serv.id;
  editingServiceTitle = serv.title;

  /* — UI: cambia de pestaña — */
  openTabServices('ServicesChildren');
  document.getElementById('tabServicesChildren').style.display = 'block';
  document.getElementById('currentServiceTitleChild').textContent = serv.title;

  /* — Selector de mes (si aún no existe) — */
  if(!document.getElementById('servicesMes').options.length){
    initSelectorMes('servicesMes');          // crea los 12 últimos meses
  }

  /* — Etiqueta y selector de variante / año — */
  const labVar = document.getElementById('labelVariantChild');
  const selVar = document.getElementById('childVariantSelect');
  labVar.textContent = (serv.title === 'Matrícula') ? 'Año' : 'Variante';
  selVar.innerHTML = '';

  if(serv.variants.length === 0){
    selVar.add(new Option('Sin variantes',''));
    selVar.disabled = true;
  }else if(serv.variants.length === 1){
    selVar.disabled = true;
    selVar.add(new Option(serv.variants[0].name, serv.variants[0].id));
  }else{
    selVar.disabled = false;
    serv.variants.forEach(v => selVar.add(new Option(v.name, v.id)));
  }

  /* — Limpia formulario, pinta tabla — */
  clearChildForm();
  const mesSel = document.getElementById('servicesMes').value || getYearMonth();
  renderChildrenTable(serv.children, mesSel);

  /* — Sticky header con leve animación — */
  const hdr  = document.querySelector('#contentServicesChildren .finanzas-header');
  const scFn = () => hdr.classList.toggle('scrolled', window.scrollY > 15);
  window.removeEventListener('scroll', scFn);   // evita duplicados
  window.addEventListener('scroll', scFn);
  scFn();                                       // estado inicial
}

function compressImage(file, maxW = 800, quality = 0.6){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=>{
      const scale = Math.min(1, maxW / img.width);
      const w = img.width  * scale;
      const h = img.height * scale;
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      canvas.toBlob(blob=>{
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);      // dataURL
        reader.onerror= e=>reject(e);
        reader.readAsDataURL(blob);
      },'image/jpeg',quality);
    };
    img.onerror = e=>reject(e);
    img.src = URL.createObjectURL(file);
  });
}

function clearChildForm(){
  editingServiceChildId = null;
  document.getElementById('childName').value   = '';
  document.getElementById('childLastname').value = '';
  document.getElementById('childDay').value    = '';     // ←  antes era childDate
  document.getElementById('btnChildPrincipal').textContent = 'Agregar Niño';
}

// Mapeo para mostrar etiquetas
const PagoMapping = {
  no: 'No',
  yes: 'Sí',
  partial: 'Parcial'
};

/**
 * Crea un dropdown custom con opciones estilizadas y hover.
 * @param {string} currentVal – 'yes' | 'no' | 'partial'
 * @param {Array<{value:string,label:string,cls:string}>} opts
 * @param {function(string)} onChange
 * @returns {HTMLDivElement}
 */
function createCustomDropdown(currentVal, opts, onChange) {
  const colorMap = { yes:'#3BB273', no:'#E74C3C', partial:'#4a90e2' };
  
  // contenedor
  const wrapper = document.createElement('div');
  Object.assign(wrapper.style, {
    position: 'relative', display: 'inline-block'
  });

  // caja seleccionada
  const sel = document.createElement('div');
  sel.textContent = PagoMapping[currentVal];
  Object.assign(sel.style, {
    backgroundColor: colorMap[currentVal],
    color: '#fff',
    padding: '10px 16px',
    borderRadius: '6px',
    cursor: 'pointer',
    userSelect: 'none',
    minWidth: '100px',
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    fontSize: '1rem',
    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
  });
  const arrow = document.createElement('span');
  arrow.textContent = '▾';
  arrow.style.marginLeft = '8px';
  arrow.style.fontSize   = '0.8em';
  sel.appendChild(arrow);
  wrapper.appendChild(sel);

  // lista de opciones
  const list = document.createElement('div');
  Object.assign(list.style, {
    position: 'absolute',
    top: 'calc(100% + 6px)',
    left: 0, right: 0,
    background: '#fff',
    border: '1px solid #ccd3e6',
    borderRadius: '6px',
    boxShadow: '0 4px 8px rgba(0,0,0,0.15)',
    zIndex: 100,
    display: 'none',
    padding: '8px 0'
  });

  opts.forEach(o => {
    const div = document.createElement('div');
    div.textContent = o.label;
    Object.assign(div.style, {
      backgroundColor: colorMap[o.value],
      color: '#fff',
      margin: '4px 12px',
      padding: '8px 12px',
      borderRadius: '8px',
      cursor: 'pointer',
      textAlign: 'center',
      transition: 'transform 0.15s ease, box-shadow 0.15s ease',
      boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
    });
    div.onmouseenter = () => {
      div.style.transform = 'scale(1.1)';
      div.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    };
    div.onmouseleave = () => {
      div.style.transform = 'scale(1)';
      div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    };
    div.onmousedown = e => {
      e.stopPropagation();
      sel.textContent = o.label;
      sel.style.backgroundColor = colorMap[o.value];
      list.style.display = 'none';
      onChange(o.value);
    };
    list.appendChild(div);
  });

  wrapper.appendChild(list);

  sel.onclick = e => {
    e.stopPropagation();
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
  };
  document.addEventListener('click', () => list.style.display = 'none');

  return wrapper;
}
/* ==== Popup ==== */
function openProofModal(childObj, mesKey){
  proofChild  = childObj;
  proofMesKey = mesKey;
  document.getElementById('proofFile').value = '';
  document.getElementById('proofBackdrop').style.display = 'flex';
}
function closeProofModal(){
  proofChild = proofMesKey = null;
  document.getElementById('proofBackdrop').style.display = 'none';
}

function renderChildrenTable(childrenArr, mesKey = getYearMonth()) {
  const tbody = document.getElementById('tbodyChildren');
  tbody.innerHTML = '';

  const servicioActual = services.find(s => s.id === editingServiceId);
  if (!servicioActual) return;

  const filtro = childrenSearchTerm.toLowerCase();
  const filas  = childrenArr
    .filter(ch => childIsActiveInMonth(ch, mesKey))
    .filter(ch =>
      !filtro ||
      (ch.name + ' ' + ch.lastname).toLowerCase().includes(filtro)
    );

  const fmtDate = iso => iso ? iso.split('-').reverse().join('/') : '—';
  const color   = { up:'#F1C40F', down:'#3BB273', delProof:'#E74C3C',
                    edit:'#4a90e2', delKid:'#000' };
  const mkBtn = (txt,bg,title,fn)=>{
    const b=document.createElement('button');
    b.textContent=txt; b.title=title; b.className='action-btn';
    b.style.background=bg; b.onclick=fn; return b;
  };

  filas.forEach(ch=>{
    const row=tbody.insertRow();
    row.insertCell().textContent = ch.name;
    row.insertCell().textContent = ch.lastname;
    row.insertCell().textContent = fmtDate(ch.date);
    row.insertCell().textContent = ch.variantName || getVariantName(ch.variantId)||'';

    /* ▼ dropdown pago */
    const cellPago = row.insertCell();
    const estado   = ch.partialPayments?.[mesKey]!=null ? 'partial'
                   : ch.pagoPorMes?.[mesKey] ? 'yes':'no';
    cellPago.appendChild(
      createCustomDropdown(
        estado,
        [{value:'yes',label:'Sí'},{value:'no',label:'No'},{value:'partial',label:'Parcial'}],
        nuevo=>{
          if(!ch.pagoPorMes)      ch.pagoPorMes      = {};
          if(!ch.partialPayments) ch.partialPayments = {};
          if(!ch.fechaPagoPorMes) ch.fechaPagoPorMes = {};

          if(nuevo==='yes'){
            ch.pagoPorMes[mesKey]=true;
            ch.fechaPagoPorMes[mesKey]=new Date().toISOString().split('T')[0];
            delete ch.partialPayments[mesKey];
            openProofModal(ch,mesKey);
          }else if(nuevo==='no'){
            ch.pagoPorMes[mesKey]=false;
            delete ch.fechaPagoPorMes[mesKey];
            delete ch.partialPayments[mesKey];
          }else{
            ch.pagoPorMes[mesKey]=false;
            delete ch.fechaPagoPorMes[mesKey];
            ch.partialPayments[mesKey]=ch.partialPayments[mesKey]??0;
            abrirInputParcial(ch,mesKey);
          }
          saveToFirebaseServices();
          renderChildrenTable(childrenArr,mesKey);
        }
      )
    );

    /* ▼ fecha de pago (input-date solo si pagado) */
    const cellFP=row.insertCell();
    if(ch.pagoPorMes?.[mesKey]){
      const inp=document.createElement('input');
      inp.type='date';
      inp.value=ch.fechaPagoPorMes?.[mesKey]||
                new Date().toISOString().split('T')[0];
      Object.assign(inp.style,{
        border:'none',background:'transparent',padding:'4px',
        cursor:'pointer',font:'inherit',textAlign:'center'
      });
      inp.onchange=()=>{
        if(!ch.fechaPagoPorMes) ch.fechaPagoPorMes={};
        ch.fechaPagoPorMes[mesKey]=inp.value;
        saveToFirebaseServices();
      };
      cellFP.appendChild(inp);
    }else cellFP.textContent = fmtDate(ch.fechaPagoPorMes?.[mesKey]);

    /* ▼ pensiones atrasadas */
    row.insertCell().textContent = ch.pensionesAtrasadas||0;

    /* ▼ acciones */
    const acc=row.insertCell(); acc.className='action-group';

    acc.appendChild( mkBtn('⬆',color.up,'Subir comprobante',
      ()=>openProofModal(ch,mesKey)) );

    if(ch.paymentProof?.[mesKey]){
      acc.appendChild( mkBtn('⬇',color.down,'Descargar comprobante',
        ()=>downloadProof(ch,mesKey)) );
      acc.appendChild( mkBtn('✖',color.delProof,'Borrar comprobante',
        ()=>borrarProof(ch,mesKey)) );
    }

    /* usar nombre+apellido en lugar de id */
    acc.appendChild( mkBtn('✎',color.edit,'Editar niño',
      ()=>comenzarEdicionFila(row,ch)));        // ya pasa el objeto

    acc.appendChild( mkBtn('🗑️',color.delKid,'Dar de baja',
      ()=>deleteServiceChildByName(ch.name,ch.lastname)) );
  });
}

function openDatePicker(childObj, mesKey, fila, celdaFecha) {
  /* crea / reutiliza un único <input type="date"> */
  let picker = document.getElementById('payDatePicker');
  if (!picker) {
    picker           = document.createElement('input');
    picker.type      = 'date';
    picker.id        = 'payDatePicker';
    picker.style.position = 'absolute';
    picker.style.zIndex   = 9999;
    picker.onblur = () => picker.remove();    // cierra al salir
    picker.onchange = () => {
      if (!picker.value){ picker.remove(); return; }

      if (!childObj.fechaPagoPorMes) childObj.fechaPagoPorMes = {};
      childObj.fechaPagoPorMes[mesKey] = picker.value;        // YYYY-MM-DD
      saveToFirebaseServices();

      celdaFecha.firstChild.textContent = picker.value.split('-').reverse().join('/');
      picker.remove();
    };
    document.body.appendChild(picker);
  }

  /* Posiciona justo debajo de la fila */
  const rect = fila.getBoundingClientRect();
  picker.style.left = (rect.left + window.scrollX + 10) + 'px';
  picker.style.top  = (rect.bottom + window.scrollY + 2) + 'px';
  picker.value      = childObj.fechaPagoPorMes?.[mesKey] || '';
  picker.focus();
}
function changePaymentDate(ch, mesKey){
  const actual = ch.fechaPagoPorMes?.[mesKey] ? ch.fechaPagoPorMes[mesKey].split('-').reverse().join('/') : '';
  const nuevo  = prompt("Nueva fecha de pago (DD/MM/AAAA):", actual);
  if(nuevo===null) return;

  const [d,m,y] = nuevo.split(/[\/\-]/);
  if(!d||!m||!y){ alert("Formato inválido."); return; }

  const iso = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  if(!ch.fechaPagoPorMes) ch.fechaPagoPorMes = {};
  ch.fechaPagoPorMes[mesKey] = iso;
  if(!ch.pagoPorMes) ch.pagoPorMes = {};
  ch.pagoPorMes[mesKey] = true;                // se considera pagado

  saveToFirebaseServices();
  const serv = services.find(s=>s.id===editingServiceId);
  renderChildrenTable(serv.children, mesKey);
}
  /* — Helper para crear botones compactos — */
  function mkBtn(txt, bg, title, handler) {
    const b = document.createElement('button');
    b.textContent = txt;
    b.title       = title;
    b.className   = 'action-btn';
    b.style.background = bg;
    b.onclick     = handler;
    return b;
  }

function showPopup(msg, type = 'ok') {
  const pop = document.createElement('div');
  pop.textContent = msg;
  Object.assign(pop.style, {
    position: 'fixed',
    left: '50%',
    top: '20px',
    transform: 'translateX(-50%)',
    padding: '12px 24px',
    borderRadius: '8px',
    fontWeight: '600',
    color: '#fff',
    background: type === 'error' ? '#E74C3C' : '#3BB273',
    boxShadow: '0 2px 8px rgba(0,0,0,.25)',
    zIndex: 5000,
    opacity: '0',
    transition: 'opacity .25s ease'
  });
  document.body.appendChild(pop);
  requestAnimationFrame(() => (pop.style.opacity = '1'));
  setTimeout(() => {
    pop.style.opacity = '0';
    pop.addEventListener('transitionend', () => pop.remove());
  }, 2600);
}
function startInlineEdit(row, ch, servicioActual, mesKey) {
  if (row.classList.contains('editing')) return;
  row.classList.add('editing');

  const [cNom, cApe, cFecha, cVar, , , cPens, cAcc] = row.cells;

  /* Nombre y Apellidos */
  const inpNom = createInlineInput(ch.name);
  const inpApe = createInlineInput(ch.lastname);
  cNom.innerHTML = ''; cNom.appendChild(inpNom);
  cApe.innerHTML = ''; cApe.appendChild(inpApe);

  /* Fecha inscripción */
  const inpFecha = document.createElement('input');
  inpFecha.type  = 'date';
  inpFecha.value = ch.date;
  inpFecha.style.width = '140px';
  cFecha.innerHTML = ''; cFecha.appendChild(inpFecha);

  /* Variante (selector) */
  const selVar = document.createElement('select');
  servicioActual.variants.forEach(v =>
    selVar.add(new Option(v.name, v.id))
  );
  selVar.value = ch.variantId;
  cVar.innerHTML = ''; cVar.appendChild(selVar);

  /* Pensiones atrasadas */
  const inpPens = document.createElement('input');
  inpPens.type  = 'number';
  inpPens.style.width = '60px';
  inpPens.value = ch.pensionesAtrasadas || 0;
  cPens.innerHTML = ''; cPens.appendChild(inpPens);

  /* Botones ✔ / ↶ */
  cAcc.innerHTML = '';
  cAcc.appendChild(
    mkBtn('✔', '#3BB273', () => {
      ch.name               = inpNom.value.trim().toUpperCase();
      ch.lastname           = inpApe.value.trim().toUpperCase();
      ch.date               = inpFecha.value;
      ch.variantId          = parseInt(selVar.value, 10);
      ch.variantName        = selVar.options[selVar.selectedIndex].textContent;
      ch.pensionesAtrasadas = parseInt(inpPens.value) || 0;
      saveToFirebaseServices();
      renderChildrenTable(servicioActual.children, mesKey);
    })
  );
  cAcc.appendChild(
    mkBtn('↶', '#999', () =>
      renderChildrenTable(servicioActual.children, mesKey)
    )
  );
}
function comenzarEdicionFila(row, ch){
  if(row.classList.contains('editing')) return;
  row.classList.add('editing');

  const serv = services.find(s => s.id === editingServiceId);
  if(!serv) return;

  /* — helpers — */
  const repl = (cell,val,cls='')=>{
    const inp=document.createElement('input');inp.type='text';inp.value=val;inp.className=cls;inp.style.width='100%';inp.style.padding='4px 6px';inp.style.border='1px solid #ccd3e6';inp.style.borderRadius='6px';cell.innerHTML='';cell.appendChild(inp);return inp;
  };

  /* 0-1 Nombre/Apellidos */
  const inpNom = repl(row.cells[0], ch.name     ,'edit-name' );
  const inpApe = repl(row.cells[1], ch.lastname ,'edit-last' );

  /* 2 Fecha Inscripción */
  const inpFec = document.createElement('input');
  inpFec.type='date';inpFec.value=ch.date;inpFec.className='edit-date';
  row.cells[2].innerHTML='';row.cells[2].appendChild(inpFec);

  /* 3 Variante */
  const selVar=document.createElement('select');selVar.className='edit-var';
  serv.variants.forEach(v=>selVar.add(new Option(v.name,v.id)));
  selVar.value=ch.variantId; selVar.disabled=serv.variants.length<=1;
  row.cells[3].innerHTML='';row.cells[3].appendChild(selVar);

  /* 6 Atrasos */
  const inpAtr=document.createElement('input');
  inpAtr.type='number';inpAtr.min=0;inpAtr.value=ch.pensionesAtrasadas||0;
  inpAtr.className='edit-atrasos';inpAtr.style.width='60px';
  row.cells[6].innerHTML='';row.cells[6].appendChild(inpAtr);

  /* Botones ✔ / ↶ */
  const acc=row.cells[7]; acc.innerHTML='';
  const mk = (txt,bg,fn)=>{const b=document.createElement('button');b.textContent=txt;b.className='action-btn';b.style.background=bg;b.onclick=fn;return b;};

  acc.appendChild(mk('✔','#3BB273', ()=>guardarEdicionFila(row,ch)));
  acc.appendChild(mk('↶','#999',    ()=>{row.classList.remove('editing');const mesSel=document.getElementById('servicesMes').value||getYearMonth();renderChildrenTable(serv.children,mesSel);} ));
}
function replaceCellWithInput(td, value, cls){
  const inp = document.createElement('input');
  inp.type  = 'text';
  inp.value = value;
  inp.className = cls;
  inp.style.width = '100%';
  inp.style.padding = '4px 6px';
  inp.style.border  = '1px solid #ccd3e6';
  inp.style.borderRadius = '6px';
  td.innerHTML = ''; td.appendChild(inp);
}
/* ========= descarga segura de comprobantes ========= */
/* ==========================================================
   DESCARGAR COMPROBANTE – compatible con registros antiguos
   ========================================================== */
/* ============================================================
   1️⃣  DESCARGAR COMPROBANTE  – tolerante a los .blob heredados
   ============================================================ */
async function downloadProof(childObj, mesKey) {
  const info = childObj.paymentProof?.[mesKey];
  if (!info) return alert('⚠️  Sin comprobante registrado');

  try {
    /* 1 · Bajamos el objeto que haya en Supabase ---------------- */
    const res   = await fetch(info.url, { mode: 'cors' });
    const blobO = await res.blob();                        // “Original”
    let   blobF = blobO;                                   // “Final”
    let   mime  = (blobO.type || '').split(';')[0];        // image/png …

    /* 2 · Caso legacy: era text/plain con una data-URL dentro --- */
    if (mime === 'text/plain') {
      const txt = await blobO.text();
      const m   = txt.match(/^data:([^;]+);base64,(.+)$/);
      if (!m) throw new Error('Formato legacy desconocido');

      mime  = m[1];                                        // image/jpeg…
      const bin = atob(m[2]);
      const buf = Uint8Array.from(bin, c => c.charCodeAt(0));
      blobF = new Blob([buf], { type: mime });
    }

    /* 3 · Extensión adecuada ----------------------------------- */
    const extMap = {
      'image/png':'png','image/jpeg':'jpg','image/webp':'webp','image/gif':'gif',
      'application/pdf':'pdf',
      'application/msword':'doc',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document':'docx',
      'text/plain':'txt'
    };
    const ext   = extMap[mime] || mime.split('/').pop() || 'bin';
    let   fname = (info.name || `comprobante.${ext}`).replace(/\.(blob|bin|plain|txt)$/i, '.'+ext);

    /* 4 · Disparar la descarga sin abrir pestaña ---------------- */
    const urlTmp = URL.createObjectURL(blobF);
    const a = Object.assign(document.createElement('a'), { href:urlTmp, download: fname });
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(urlTmp);

  } catch (err) {
    console.error(err);
    alert('❌ No se pudo descargar el comprobante');
  }
}
/* ==============================================================
   MIGRAR COMPROBANTES LEGACY  (.blob / .bin / .plain / .txt)
   ============================================================== */
/* ============================================================
   2️⃣  MIGRACIÓN MASIVA  (ejecútala una única vez en consola)
   ============================================================ */
window.migrateLegacyProofs = async function () {
  let procesados = 0, reparados = 0;

  for (const serv of services) {
    for (const ch of serv.children) {
      const proofs = ch.paymentProof || {};
      for (const [mes, info] of Object.entries(proofs)) {
        procesados++;
        if (!/\.(blob|bin|plain|txt)$/i.test(info.path || '')) continue;

        try {
          /* a) descargamos el objeto ----------------------------------- */
          const res   = await fetch(info.url, { mode: 'cors' });
          const mime  = (res.headers.get('content-type') || '').split(';')[0];
          const blobO = await res.blob();

          /* b) si era texto con data-URL → dejamos que uploadProof lo trate */
          const uploadable =
                mime === 'text/plain' ? await blobO.text()
                                      : new File([blobO], `file.${mime.split('/').pop()}`, { type: mime });

          /* c) nueva subida + borrado antigua --------------------------- */
          const { publicUrl, fileName, filePath } =
                await uploadProofToSupabase(uploadable, mes, ch.id);

          await supabase.storage.from('comprobantes').remove([info.path]);

          proofs[mes] = { name: fileName, url: publicUrl, path: filePath };
          reparados++;

        } catch (e) { console.error('Error migrando', info.path, e); }
      }
    }
  }
  if (reparados) await saveToFirebaseServices();
  alert(`Migración completada: ${reparados}/${procesados} comprobantes reparados`);
};

function createInlineInput(val) {
  const inp = document.createElement('input');
  inp.type  = 'text';
  inp.value = val;
  inp.style.width        = '100%';
  inp.style.padding      = '4px 6px';
  inp.style.border       = '1px solid #ccd3e6';
  inp.style.borderRadius = '6px';
  return inp;
}
function abrirInputParcial(ch, mesKey) {
  const monto = prompt("Monto abonado (S/):", ch.partialPayments?.[mesKey] || '');
  if (monto === null) return;             // cancelado
  const n = parseFloat(monto);
  if (isNaN(n) || n < 0) { alert("Valor no válido"); return; }

  if (!ch.partialPayments) ch.partialPayments = {};
  ch.partialPayments[mesKey] = n;

  /* fecha de pago parcial */
  if (!ch.fechaPagoPorMes) ch.fechaPagoPorMes = {};
  ch.fechaPagoPorMes[mesKey] = getYearMonth() + '-' + new Date().getDate().toString().padStart(2,'0');

  openProofModal(ch, mesKey);             // opcional: subir voucher
  saveToFirebaseServices();

  const serv = services.find(s=>s.id===editingServiceId);
  renderChildrenTable(serv.children, mesKey);
}
function guardarEdicionFila(row, ch){
  const serv = services.find(s => s.id === editingServiceId);
  if(!serv) return;

  const nombre   = row.querySelector('.edit-name').value.trim().toUpperCase();
  const apellidos= row.querySelector('.edit-last').value.trim().toUpperCase();
  const fecha    = row.querySelector('.edit-date').value;
  const varId    = parseInt(row.querySelector('.edit-var').value);
  const atrasos  = parseInt(row.querySelector('.edit-atrasos').value) || 0;

  if(!nombre || !apellidos || !fecha){
    alert("Nombre, apellidos y fecha son obligatorios");
    return;
  }

  ch.name = nombre; ch.lastname = apellidos; ch.date = fecha;
  ch.variantId = varId; ch.variantName = getVariantName(varId) || ch.variantName;
  ch.pensionesAtrasadas = atrasos;

  saveToFirebaseServices();
  const mesSel = document.getElementById('servicesMes').value || getYearMonth();
  renderChildrenTable(serv.children, mesSel);
}
function deleteServiceChildByName(name, lastname){
  const serv = services.find(s => s.id === editingServiceId);
  if(!serv) return;

  const idx = serv.children.findIndex(c =>
    c.name === name && c.lastname === lastname
  );
  if(idx === -1) return;

  const ch  = serv.children[idx];
  const mesSel = document.getElementById('servicesMes').value || getYearMonth();

  if(!confirm(`¿Dar de baja a ${name} ${lastname}?`)) return;

  /* baja lógica o eliminación física según el mes */
  if(ch.mesRegistro === mesSel){
    serv.children.splice(idx,1);          // fuera completamente
  }else{
    ch.mesBaja = mesSel;                  // baja lógica
  }

  saveToFirebaseServices();
  renderChildrenTable(serv.children, mesSel);
}


function editServiceChild(childId){
  const serv = services.find(s=>s.id===editingServiceId);
  if(!serv) return;
  const ch = serv.children.find(c=>c.id===childId);
  if(!ch) return;

  editingServiceChildId = childId;

  document.getElementById('childName').value      = ch.name;
  document.getElementById('childLastname').value  = ch.lastname;
  document.getElementById('childDniPadre').value  = ch.dniPadre || '';     // ← NUEVO

  const [, , dd] = ch.date.split('-');  // YYYY-MM-DD
  document.getElementById('childDay').value = parseInt(dd,10);

  const sel = document.getElementById('childVariantSelect');
  if(!sel.disabled && ch.variantId) sel.value = ch.variantId;

  document.getElementById('btnChildPrincipal').textContent = 'Guardar Niño';
}




  function doneChildren(){
    openTabServices('ServicesMain');
    showServicesList();
    saveToFirebaseServices();
  }
function getVariantName(varId, fallback = null){
  if(!varId) return fallback;
  for(const s of services){
    const v = s.variants.find(v => v.id === varId);
    if(v) return v.name;
  }
  return fallback;                // si no existe, usamos el respaldo
}
  function getYearMonth(){
    const d = new Date();
    return d.getFullYear().toString() + '-' + String(d.getMonth()+1).padStart(2, '0');
  }

  /**************************************************************
   * FINANZAS (NUEVO MENÚ)
   **************************************************************/
let finanzasData = {
  egresos: [],
  ingresos: [],
  resumenMensual: {}   //  <-- NUEVO
};
  // Se espera que cada registro de egreso tenga: id, nombre, tipo, subtipo, cantidad, descuento, mes, año
  let nextEgresoId = 1;
  // Para simplificar, los ingresos se calcularán a partir de los datos ya almacenados en servicios

  // Inicialización de opciones del selector de mes (por ejemplo, últimos 12 meses)
  function initSelectorMesFinanzas(){
    const select = document.getElementById('finanzasMes');
    select.innerHTML = '';
    const d = new Date();
    // Por defecto mostrar el mes actual y los 11 anteriores
    for(let i = 0; i < 12; i++){
      let fecha = new Date(d.getFullYear(), d.getMonth() - i, 1);
      let mes = fecha.getMonth() + 1;
      let anio = fecha.getFullYear();
      let option = document.createElement('option');
      option.value = `${anio}-${mes.toString().padStart(2,'0')}`;
      option.textContent = `${meses[fecha.getMonth()]} ${anio}`;
      select.appendChild(option);
    }
  }
function initSelectorMes(idSelect){
  const sel = document.getElementById(idSelect);
  sel.innerHTML = '';
  const hoy = new Date();
  for (let i = 0; i < 12; i++){
    const d = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
    const value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const opt   = document.createElement('option');
    opt.value   = value;
    opt.textContent = `${meses[d.getMonth()]} ${d.getFullYear()}`;
    sel.appendChild(opt);
  }
}
  // Función para cambiar de mes en Finanzas
  function cambiarMesFinanzas(){
    monthlyPaymentCheckAllServices();
    renderFinanzas();
  }
  function cargarSubtiposEgresos() {
  const sel = document.getElementById('egresoSubtipo');
  sel.innerHTML = '<option value="">-- Selecciona Subtipo --</option>';
  subtiposEgresos.forEach(st => {
    const opt = document.createElement('option');
    opt.value = st;
    opt.textContent = st;
    sel.appendChild(opt);
  });
  }
function cambiarMesServices(){
  const serv   = services.find(s => s.id === editingServiceId);
  const mesSel = document.getElementById('servicesMes').value;
  if(serv) renderChildrenTable(serv.children, mesSel);

  /* si el selector de días está abierto, lo redibujamos */
  if(!document.getElementById('dayPicker').classList.contains('hidden')){
    openDayPicker();
  }
}

function cambiarMesMatriculas(){
  renderMatriculasList();   // la función ya leerá el nuevo valor del select
}

function agregarNuevoSubtipo() {
  const nuevo = prompt("Ingresa el nuevo subtipo de egreso:");
  if(nuevo && nuevo.trim() !== "") {
    subtiposEgresos.push(nuevo.trim());
    cargarSubtiposEgresos();
    document.getElementById('egresoSubtipo').value = nuevo.trim();
    saveFinanzasData(); // Guarda la lista actualizada de subtipos en Firebase
  }
}

  // Función para inicializar Finanzas
async function initFinanzas() {
  initSelectorMesFinanzas();
  await loadFinanzasData();
  cargarSubtiposEgresos();

  // Llamada a ambos
  initEgresosFilters();    // <--- IMPORTANTE
  initIngresosFilters();

  renderFinanzas();
  actualizarGraficosFinanzas();
}

function carryOverFixedEgresos(mesKey) {
  /*  Función vacía por ahora.
      Si necesitas lógica adicional, la añades aquí. */
}



  // Renderiza la vista de Finanzas según el mes seleccionado
/**
 * Renderiza todo el panel de Finanzas cuando cambia de mes, 
 * incluyendo parciales en Ingresos y en los gráficos.
 */
/**
 * Renderiza todo el panel de Finanzas para el mes seleccionado,
 * calcula egresos, ingresos (incluyendo parciales), variación y actualiza gráficos/tablas.
 */
function renderFinanzas() {
  // 1️⃣ Mes seleccionado
  const mesSeleccionado = document.getElementById('finanzasMes').value; // "YYYY-MM"
  const [anioSel, mesSel] = mesSeleccionado.split('-').map(Number);

  // 2️⃣ Copia de egresos fijos del mes anterior si aún no existen
  const prevDate = new Date(anioSel, mesSel - 2, 1);
  const prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,'0')}`;
  const existeFijos = finanzasData.egresos.some(e =>
    e.tipo === "Fijo" &&
    `${e.anio}-${String(e.mes).padStart(2,'0')}` === mesSeleccionado
  );
  if (!existeFijos) {
    const prevFijos = finanzasData.egresos.filter(e =>
      e.tipo === "Fijo" &&
      `${e.anio}-${String(e.mes).padStart(2,'0')}` === prevKey
    );
    prevFijos.forEach(e => {
      finanzasData.egresos.push({
        ...e,
        id: nextEgresoId++,
        anio: anioSel,
        mes: mesSel
      });
    });
  }

  // 3️⃣ Filtrar egresos de este mes
  const egresosFiltrados = finanzasData.egresos.filter(e =>
    `${e.anio}-${String(e.mes).padStart(2,'0')}` === mesSeleccionado
  );

  // 4️⃣ Totales de egresos
  const totalEgresosVariables = calcularEgresosTipo(egresosFiltrados, "Variable");
  const totalEgresosFijos     = calcularEgresosTipo(egresosFiltrados, "Fijo");
  const totalEgresos          = calcularEgresosTotales(egresosFiltrados);

  // 5️⃣ Ingresos esperados y reales (incluyendo parciales)
  const brutoEsperado = calcularIngresosBrutoEsperado(mesSeleccionado);
  const brutoTotales  = calcularIngresosBrutosTotales(mesSeleccionado);
  const netoEsperado  = calcularIngresosNetoEsperado(mesSeleccionado);
  const netoTotales   = calcularIngresosNetosTotales(mesSeleccionado);

  // 6️⃣ Actualizar tarjeta de indicadores
  document.getElementById('egresosVariables').textContent     = "S/ " + totalEgresosVariables.toFixed(2);
  document.getElementById('egresosFijos').textContent         = "S/ " + totalEgresosFijos.toFixed(2);
  document.getElementById('egresosTotales').textContent       = "S/ " + totalEgresos.toFixed(2);
  document.getElementById('ingresosBrutosEsperados').textContent = "S/ " + brutoEsperado.toFixed(2);
  document.getElementById('ingresosNetosEsperados').textContent  = "S/ " + netoEsperado.toFixed(2);
  document.getElementById('ingresosBrutosTotales').textContent   = "S/ " + brutoTotales.toFixed(2);
  document.getElementById('ingresosNetosTotales').textContent    = "S/ " + netoTotales.toFixed(2);

  // 7️⃣ Actualizar resumen mensual en memoria
  actualizarResumenMensual(mesSeleccionado);

  // 8️⃣ Calcular y mostrar variación con respecto al mes anterior
  const pct = calcularVariacion(mesSeleccionado);
  const indicador = document.getElementById('indicadorVariacion');
  indicador.textContent = `Variación: ${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
  indicador.style.color = pct < 0 ? 'red' : '';

  // 9️⃣ Renderizar tablas y gráficos
  renderTablaEgresos(egresosFiltrados);
  renderTablaIngresos(mesSeleccionado);
  actualizarGraficosFinanzas();
}


  function calcularEgresosTipo(egresos, tipo){
    return egresos.filter(e => e.tipo === tipo).reduce((acc, e) => acc + (parseFloat(e.cantidad) - parseFloat(e.descuento || 0)), 0);
  }
  function calcularEgresosTotales(egresos){
    return egresos.reduce((acc, e) => acc + (parseFloat(e.cantidad) - parseFloat(e.descuento || 0)), 0);
  }
function obtenerLineal(keyName) {
  const labels = [];
  const datos  = [];
  // Tomamos hasta los últimos 12 meses registrados
  const mesesOrdenados = Object.keys(finanzasData.resumenMensual)
                               .sort()    // “2025-01”, “2025-02”, …
                               .slice(-12);
  mesesOrdenados.forEach(k => {
    const valor = finanzasData.resumenMensual[k][keyName] || 0;
    // Solo incluimos si no es cero
    if (valor !== 0) {
      const [y, m] = k.split('-');
      // Convierte “05” → índice 4 → “MAYO”
      labels.push(`${meses[parseInt(m, 10)-1]} ${y}`);
      datos.push(valor);
    }
  });
  return { labels, datos };
}
/* ============================================================== */
/* ===  TABLA EGRESOS – acciones por Nombre + Cantidad + Mes  === */
/* ============================================================== */

/* Devuelve el índice del egreso que coincide CON lo que se ve   */
function indexEgreso(nombre, cantidad, anio, mes){
  return finanzasData.egresos.findIndex(e =>
    e.nombre   === nombre &&
    Number(e.cantidad) === Number(cantidad) &&
    e.anio     === anio &&
    e.mes      === mes
  );
}

/* ------------ ELIMINAR ------------ */
function eliminarEgresoComp(nombre, cantidad, anio, mes){
  const idx = indexEgreso(nombre, cantidad, anio, mes);
  if(idx === -1){
    alert("No se encontró el egreso.");
    return;
  }
  const eg = finanzasData.egresos[idx];
  const mesTxt = `${String(mes).padStart(2,'0')}-${anio}`;
  if(!confirm(`¿Eliminar “${eg.nombre}” de S/ ${eg.cantidad} (mes ${mesTxt})?`)) return;

  finanzasData.egresos.splice(idx,1);
  renderFinanzas();     // refresca tablas y tarjetas
  saveFinanzasData();   // guarda en Firebase
}



async function borrarProof(childObj, mesKey){
  const info = childObj.paymentProof?.[mesKey];
  if(!info)            return alert('No existe comprobante');
  if(!confirm('¿Eliminar comprobante definitivamente?')) return;

  await withProofLoader(async ()=>{

    /* 1 · eliminar del bucket */
    const { error } = await supabase
      .storage
      .from('comprobantes')
      .remove([info.path]);
    if(error){ console.error(error); throw new Error('Error en Supabase'); }

    /* 2 · quitar referencia y refrescar UI */
    delete childObj.paymentProof[mesKey];
    await saveToFirebaseServices();

    const serv = services.find(s => s.id === editingServiceId);
    renderChildrenTable(serv.children, mesKey);
  }).catch(err=>{
    console.error(err);
    showPopup('❌ ' + (err.message || 'Error al borrar comprobante'),'error');
  });
}


/* ------------ EDITAR ------------   */
/* Carga en el formulario el egreso seleccionado                    */
function editarEgresoComp(nombre, cantidad, anio, mes){
  const idx = indexEgreso(nombre, cantidad, anio, mes);
  if(idx === -1){
    alert("No se encontró el egreso.");
    return;
  }
  const eg = finanzasData.egresos[idx];

  editingEgresoId = eg.id ?? null;          // por si tu lógica interna usa id
  document.getElementById('egresoNombre').value    = eg.nombre;
  document.getElementById('egresoTipo').value      = eg.tipo;
  document.getElementById('egresoSubtipo').value   = eg.subtipo;
  document.getElementById('egresoCantidad').value  = eg.cantidad;
  document.getElementById('egresoDescuento').value = eg.descuento || 0;
}

/* ------------ PINTAR TABLA ------------ */
function renderTablaEgresos(egresos){
  const tipoSel    = document.getElementById("filtroEgresosTipo").value;
  const subtipoSel = document.getElementById("filtroEgresosSubtipo").value;

  let rows = egresos;
  if(tipoSel)    rows = rows.filter(e => e.tipo    === tipoSel);
  if(subtipoSel) rows = rows.filter(e => e.subtipo === subtipoSel);

  const tbody = document.querySelector('#tablaEgresos tbody');
  tbody.innerHTML = '';

  rows.forEach(e => {
    const tr = tbody.insertRow();
    tr.insertCell(0).textContent = e.nombre;
    tr.insertCell(1).textContent = e.tipo;
    tr.insertCell(2).textContent = e.subtipo;
    tr.insertCell(3).textContent = Number(e.cantidad).toFixed(2);
    tr.insertCell(4).textContent = Number(e.descuento || 0).toFixed(2);
    tr.insertCell(5).textContent = (
      Number(e.cantidad) - Number(e.descuento || 0)
    ).toFixed(2);

    /* BOTONES ACCIÓN – usamos los 4 datos clave */
    const tdAcc = tr.insertCell(6),
          key   = [e.nombre, e.cantidad, e.anio, e.mes]; // pack de claves

    /* Editar */
    const bEd = document.createElement('button');
    bEd.textContent = 'Editar';
    bEd.onclick = () => editarEgresoComp(...key);
    tdAcc.appendChild(bEd);

    /* Eliminar */
    const bDel = document.createElement('button');
    bDel.textContent = 'Eliminar';
    bDel.style.marginLeft = '5px';
    bDel.onclick = () => eliminarEgresoComp(...key);
    tdAcc.appendChild(bDel);
  });
}



function renderTablaIngresos(mesKey) {
  const tbody      = document.querySelector('#tablaIngresos tbody');
  tbody.innerHTML  = '';

  const tipoSel    = document.getElementById('filtroIngresosTipo').value;
  const subtipoSel = document.getElementById('filtroIngresosSubtipo').value;

  // Para cada servicio…
  services.forEach(serv => {
    // ① Filtrar por Tipo:
    if (tipoSel === 'Matrícula' && serv.title !== 'Matrícula') return;
    if (tipoSel === 'Taller' && serv.title === 'Matrícula')    return;

    // ② Filtrar por Subtipo (nombre exacto del servicio)
    if (subtipoSel && serv.title !== subtipoSel) return;

    // ③ Recorrer niños
    serv.children.forEach(child => {
      if (!childIsActiveInMonth(child, mesKey)) return;

      const row = tbody.insertRow();

      // Nombre y tipo de servicio
      row.insertCell(0).textContent = child.name;
      row.insertCell(1).textContent = serv.title === 'Matrícula' ? 'Matrícula' : 'Taller';
      row.insertCell(2).textContent = serv.title;

      // Monto: parcial o total
      const parc = child.partialPayments?.[mesKey];
      const monto = parc != null ? parc : (child.total || 0);
      row.insertCell(3).textContent = `S/ ${monto.toFixed(2)}`;

      // Pagó Mensualidad
      const cellPago = row.insertCell(4);
      cellPago.style.textAlign = 'center';
      const btnPago = document.createElement('button');
      if (parc != null) {
        btnPago.textContent = 'Parcial';
        btnPago.style.backgroundColor = '#4a90e2';
      } else if (child.pagoPorMes?.[mesKey]) {
        btnPago.textContent = 'Sí';
        btnPago.style.backgroundColor = '#3BB273';
      } else {
        btnPago.textContent = 'No';
        btnPago.style.backgroundColor = '#E74C3C';
      }
      Object.assign(btnPago.style, {
        color:        '#fff',
        border:       'none',
        borderRadius: '6px',
        padding:      '8px 14px',
        fontWeight:   '600'
      });
      cellPago.appendChild(btnPago);

      // — FIN de la fila —
    });
  });

  // Si después de todo no hay filas:
  if (!tbody.hasChildNodes()) {
    const row = tbody.insertRow();
    const cell = row.insertCell(0);
    cell.colSpan = 5;
    cell.textContent = 'No hay ingresos para mostrar';
    cell.style.textAlign = 'center';
    cell.style.padding = '12px';
  }
}


/* -------------------------------------------------
   EDITAR EGRESO  – carga el registro en el formulario
   -------------------------------------------------*/
function editarEgreso(id){
  const eg = finanzasData.egresos.find(e => e.id === id);
  if (!eg) return;                // seguridad

  editingEgresoId = id;           // <<<  usa la única variable global

  document.getElementById('egresoNombre').value    = eg.nombre;
  document.getElementById('egresoTipo').value      = eg.tipo;
  document.getElementById('egresoSubtipo').value   = eg.subtipo;
  document.getElementById('egresoCantidad').value  = eg.cantidad;
  document.getElementById('egresoDescuento').value = eg.descuento || 0;
}

function agregarEgreso(){
  const nombre    = document.getElementById('egresoNombre').value.trim();
  const tipo      = document.getElementById('egresoTipo').value;
  const subtipo   = document.getElementById('egresoSubtipo').value;
  const cantidad  = parseFloat(document.getElementById('egresoCantidad').value);
  const descuento = parseFloat(document.getElementById('egresoDescuento').value) || 0;

  if(!nombre || !tipo || !subtipo || isNaN(cantidad)){
    alert("Completa todos los campos del egreso");
    return;
  }

  /* Mes / Año visibles en el combo del módulo Finanzas */
  const [aStr, mStr] = document.getElementById('finanzasMes').value.split('-');
  const anio = +aStr, mes = +mStr;

  if(editingEgresoId !== null){                // ---- EDITAR ----
    const eg = finanzasData.egresos.find(e => e.id === editingEgresoId);
    if(eg){
      Object.assign(eg,{ nombre, tipo, subtipo, cantidad, descuento, anio, mes });
    }
    editingEgresoId = null;                    // reset
  }else{                                       // ---- NUEVO ----
    finanzasData.egresos.push({
      id: nextEgresoId++,
      nombre, tipo, subtipo, cantidad, descuento, anio, mes
    });
  }

  /* limpia formulario */
  ['egresoNombre','egresoTipo','egresoSubtipo','egresoCantidad','egresoDescuento']
    .forEach(id => document.getElementById(id).value = '');

  renderFinanzas();      // refresca tablas/gráficos
  saveFinanzasData();    // guarda en Firebase
}


function actualizarGraficosFinanzas() {
  const mesSeleccionado = document.getElementById('finanzasMes').value;

  // ── Pie Total Mensual (Pagado / Falta) ─────────────────────────
  const brutoEsperado = calcularIngresosBrutoEsperado(mesSeleccionado);
  const brutoTotales  = calcularIngresosBrutosTotales(mesSeleccionado);
  const faltante      = Math.max(brutoEsperado - brutoTotales, 0);

  const ctxTotal = document
    .getElementById('chartFinanzasCircular')
    .getContext('2d');
  if (window.chartFinanzasCircular && typeof window.chartFinanzasCircular.destroy === 'function') {
    window.chartFinanzasCircular.destroy();
  }
  window.chartFinanzasCircular = new Chart(ctxTotal, {
    type: 'pie',
    data: {
      labels: ['Pagado', 'Falta'],
      datasets: [{
        data: [brutoTotales, faltante],
        backgroundColor: ['#3BB273', '#E74C3C']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // ── Pie Egresos (Fijos / Variables) ────────────────────────────
  const egresosThisMonth = finanzasData.egresos.filter(e =>
    `${e.anio}-${String(e.mes).padStart(2,'0')}` === mesSeleccionado
  );
  const totalFijos     = calcularEgresosTipo(egresosThisMonth, 'Fijo');
  const totalVariables = calcularEgresosTipo(egresosThisMonth, 'Variable');

  const ctxEgrPie = document
    .getElementById('chartEgresosCircular')
    .getContext('2d');
  if (window.chartEgresosCircular && typeof window.chartEgresosCircular.destroy === 'function') {
    window.chartEgresosCircular.destroy();
  }
  window.chartEgresosCircular = new Chart(ctxEgrPie, {
    type: 'pie',
    data: {
      labels: ['Fijos', 'Variables'],
      datasets: [{
        data: [totalFijos, totalVariables],
        backgroundColor: ['#4a90e2', '#f1c40f']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // ── Pie Ingresos (Matrícula / Taller) ───────────────────────────
  let ingresosMat = 0, ingresosTal = 0;
  services.forEach(serv => {
    serv.children.forEach(ch => {
      if (!childIsActiveInMonth(ch, mesSeleccionado)) return;
      const parc = ch.partialPayments?.[mesSeleccionado];
      if (parc != null) {
        if (serv.title === 'Matrícula') ingresosMat += parc;
        else                             ingresosTal += parc;
      } else if (ch.pagoPorMes?.[mesSeleccionado]) {
        if (serv.title === 'Matrícula') ingresosMat += ch.total || 0;
        else                             ingresosTal += ch.total || 0;
      }
    });
  });

  const ctxIngPie = document
    .getElementById('chartIngresosCircular')
    .getContext('2d');
  if (window.chartIngresosCircular && typeof window.chartIngresosCircular.destroy === 'function') {
    window.chartIngresosCircular.destroy();
  }
  window.chartIngresosCircular = new Chart(ctxIngPie, {
    type: 'pie',
    data: {
      labels: ['Matrícula', 'Taller'],
      datasets: [{
        data: [ingresosMat, ingresosTal],
        backgroundColor: ['#3BB273', '#f1c40f']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // ── Línea Ingresos Netos Totales ───────────────────────────────
  const datNetos = obtenerLineal('netoTotales');
  const ctxLineNet = document
    .getElementById('chartFinanzasLinealTotal')
    .getContext('2d');
  if (window.chartFinanzasLinealTotal && typeof window.chartFinanzasLinealTotal.destroy === 'function') {
    window.chartFinanzasLinealTotal.destroy();
  }
  window.chartFinanzasLinealTotal = new Chart(ctxLineNet, {
    type: 'line',
    data: {
      labels: datNetos.labels,
      datasets: [{
        label: 'Ingresos Netos Totales',
        data: datNetos.datos,
        borderColor: '#3BB273',
        backgroundColor: 'rgba(59,178,115,0.2)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // ── Línea Ingresos Netos (por separado) ───────────────────────
  const datIngresos = obtenerLineal('netoTotales');
  const ctxLineIng = document
    .getElementById('chartIngresosLineal')
    .getContext('2d');
  if (window.chartIngresosLineal && typeof window.chartIngresosLineal.destroy === 'function') {
    window.chartIngresosLineal.destroy();
  }
  window.chartIngresosLineal = new Chart(ctxLineIng, {
    type: 'line',
    data: {
      labels: datIngresos.labels,
      datasets: [{
        label: 'Ingresos Netos',
        data: datIngresos.datos,
        borderColor: '#3BB273',
        backgroundColor: 'rgba(59,178,115,0.2)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // ── Línea Egresos Totales ──────────────────────────────────────
  const datEgresos = obtenerLineal('egresosTotales');
  const ctxLineEgr = document
    .getElementById('chartEgresosLineal')
    .getContext('2d');
  if (window.chartEgresosLineal && typeof window.chartEgresosLineal.destroy === 'function') {
    window.chartEgresosLineal.destroy();
  }
  window.chartEgresosLineal = new Chart(ctxLineEgr, {
    type: 'line',
    data: {
      labels: datEgresos.labels,
      datasets: [{
        label: 'Egresos Totales',
        data: datEgresos.datos,
        borderColor: '#E74C3C',
        backgroundColor: 'rgba(231,76,60,0.2)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}



function openTabFinanzas(tabName){
  if(tabName==='Total'   && !currentUser.permisos.finanzasTotal   ){ alert("No tienes permiso."); return; }
  if(tabName==='Egresos' && !currentUser.permisos.finanzasEgresos ){ alert("No tienes permiso."); return; }
  if(tabName==='Ingresos'&& !currentUser.permisos.finanzasIngresos){ alert("No tienes permiso."); return; }

  withLoader(()=>{     /* transición */
    ['contentFinanzasTotal','contentFinanzasEgresos','contentFinanzasIngresos']
      .forEach(id => document.getElementById(id).classList.remove('activeTabContent'));
    ['tabFinanzasTotal','tabFinanzasEgresos','tabFinanzasIngresos']
      .forEach(id => document.getElementById(id).classList.remove('activeTab'));

    if(tabName==='Total'){
      document.getElementById('contentFinanzasTotal').classList.add('activeTabContent');
      document.getElementById('tabFinanzasTotal').classList.add('activeTab');
    }else if(tabName==='Egresos'){
      document.getElementById('contentFinanzasEgresos').classList.add('activeTabContent');
      document.getElementById('tabFinanzasEgresos').classList.add('activeTab');
    }else{
      document.getElementById('contentFinanzasIngresos').classList.add('activeTabContent');
      document.getElementById('tabFinanzasIngresos').classList.add('activeTab');
    }
  });
}


function initFinanzasRealTime(){
  const docRef = doc(db,"data","finanzas");
  onSnapshot(docRef,(docSnap)=>{
    if(docSnap.exists()){
      updatingFromFirestore = true;             // ← ❶ encendemos el flag
      finanzasData = docSnap.data();
      renderFinanzas();                         // ← ❷
      updatingFromFirestore = false;            // ← ❸ lo apagamos
    }
  });
}

  /**************************************************************
   * FICHA INFORMATIVA (Ya existente)
   **************************************************************/
  let currentFichaChild = null;
  function openFicha(childObj) {
    currentFichaChild = childObj;
    document.getElementById('matriculasContainer').classList.remove('activeContainer');
    screenStack.push("ficha");
    document.getElementById('fichaInformativaPanel').style.display = 'block';
    renderFicha(childObj);
  }
  function renderFicha(ch) {
    const cont = document.getElementById('fichaContent');
    cont.innerHTML = '';
    if (!ch.ficha) ch.ficha = {};
    if (!ch.hasOwnProperty('fichaCompleta')) ch.fichaCompleta = false;
    if (ch.fichaCompleta) {
      const h3 = document.createElement('h3');
      h3.textContent = "Ficha Informativa (Completada)";
      cont.appendChild(h3);
      cont.innerHTML += createFichaResumenHTML(ch.ficha);
      const btnEd = document.createElement('button');
      btnEd.className = 'finish-btn';
      btnEd.textContent = 'Editar';
      btnEd.onclick = () => {
        ch.fichaCompleta = false;
        renderFicha(ch);
      };
      cont.appendChild(btnEd);
      const btnBack = document.createElement('button');
      btnBack.className = 'finish-btn';
      btnBack.style.marginLeft = '10px';
      btnBack.textContent = 'Regresar';
      btnBack.onclick = goBackFicha;
      cont.appendChild(btnBack);
// Botón para descargar Word
const btnDescargarWord = document.createElement('button');
btnDescargarWord.className = 'finish-btn';
btnDescargarWord.style.marginLeft = '10px';
btnDescargarWord.textContent = 'Descargar Word';
btnDescargarWord.onclick = () => descargarFichaWord(ch);
cont.appendChild(btnDescargarWord);

    } else {
      createFichaForm(ch, cont);
    }
  }
  function createFichaResumenHTML(f) {
    let html = "<ul>";
    for (const key in f) {
      if (f.hasOwnProperty(key)) {
        html += `<li><strong>${key}:</strong> ${f[key]}</li>`;
      }
    }
    html += "</ul>";
    return html;
  }
  function createFichaForm(ch, container) {
    const sec1 = document.createElement('div');
    sec1.className = 'subsection';
    let h4_1 = document.createElement('h4');
    h4_1.textContent = "Sección 1: Datos del Niño";
    sec1.appendChild(h4_1);
    sec1.appendChild(makeField("DNI", "dni", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Nombres y Apellidos", "nomApeNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Fecha de Nacimiento (día/mes/año)", "fechaNacNino", "date", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Lugar de Nacimiento", "lugarNacNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Edad (en años)", "edadNino", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Sexo", "sexoNino", "select", ch.ficha, { required: true, options: ["Masculino", "Femenino", "Otro"] }));
    sec1.appendChild(makeField("Religión", "religionNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tipo de Parto (Normal / Cesárea)", "tipoParto", "select", ch.ficha, { required: true, options: ["Normal", "Cesárea"] }));
    sec1.appendChild(makeField("Dirección", "direccionNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Nro. de Hermanos", "nroHermanos", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Teléfono (principal)", "telPrincipal", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Teléfono(s) de Emergencia", "telEmergencia", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Centro Médico en caso de urgencia", "centroMedico", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Número de Seguro", "numSeguro", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tipo de Seguro", "tipoSeguro", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("¿Con quién o quiénes vive el menor?", "conQuienVive", "select", ch.ficha, {
      required: true,
      options: ["Solo el Padre", "Solo la Madre", "Ambos Padres", "Apoderado"]
    }));
    container.appendChild(sec1);
    const sec2 = document.createElement('div');
    sec2.className = 'subsection';
    let hh2 = document.createElement('h4');
    hh2.textContent = "Sección 2: Datos del Padre";
    sec2.appendChild(hh2);
    sec2.appendChild(makeField("Apellidos y Nombres", "apellidosPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("DNI", "dniPadre", "number", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Fecha de Nacimiento", "fechaNacPadre", "date", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Religión", "religionPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Estado Civil", "estadoCivilPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Grado de Instrucción", "gradoInstrPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Ocupación", "ocupPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Teléfono", "telPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Correo Electrónico", "emailPadre", "text", ch.ficha, { required: true }));
    container.appendChild(sec2);
    const sec3 = document.createElement('div');
    sec3.className = 'subsection';
    let hh3 = document.createElement('h4');
    hh3.textContent = "Sección 3: Datos de la Madre";
    sec3.appendChild(hh3);
    sec3.appendChild(makeField("Apellidos y Nombres", "apellidosMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("DNI", "dniMadre", "number", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Fecha de Nacimiento", "fechaNacMadre", "date", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Religión", "religionMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Estado Civil", "estadoCivilMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Grado de Instrucción", "gradoInstrMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Ocupación", "ocupMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Teléfono", "telMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Correo Electrónico", "emailMadre", "text", ch.ficha, { required: true }));
    container.appendChild(sec3);
    const sec4 = document.createElement('div');
    sec4.className = 'subsection';
    let hh4 = document.createElement('h4');
    hh4.textContent = "Sección 4: Datos del Apoderado";
    sec4.appendChild(hh4);
    sec4.appendChild(makeField("Apellidos y Nombres", "apellidosApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("DNI", "dniApod", "number", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Fecha de Nacimiento", "fechaNacApod", "date", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Religión", "religionApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Estado Civil", "estadoCivilApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Grado de Instrucción", "gradoInstrApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Ocupación", "ocupApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Teléfono", "telApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Correo Electrónico", "emailApod", "text", ch.ficha, { required: true }));
    container.appendChild(sec4);
    const sec5 = document.createElement('div');
    sec5.className = 'subsection';
    let hh5 = document.createElement('h4');
    hh5.textContent = "Sección 5: Desarrollo";
    sec5.appendChild(hh5);
    sec5.appendChild(makeField("Complicaciones Durante el Parto (Sí / No), especificar", "complicParto", "text", ch.ficha, { required: true }));
    sec5.appendChild(makeField("Desarrollo Motriz", "desarrolloMotriz", "text", ch.ficha, { required: true }));
    sec5.appendChild(makeField("¿Ya levanta la cabeza?", "levantaCabeza", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec5.appendChild(makeField("¿Se sienta?", "seSienta", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec5.appendChild(makeField("¿Gatea?", "gatea", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec5.appendChild(makeField("¿Se para?", "sePara", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec5.appendChild(makeField("¿Camina?", "camina", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec5.appendChild(makeField("¿Controla esfínteres?", "controlaEsfinteres", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec5.appendChild(makeField("¿Ya dijo sus primeras palabras?", "primerasPalabras", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec5.appendChild(makeField("¿Ya habla con fluidez?", "hablaFluidez", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    container.appendChild(sec5);
    const sec6 = document.createElement('div');
    sec6.className = 'subsection';
    let hh6 = document.createElement('h4');
    hh6.textContent = "Sección 6: Salud";
    sec6.appendChild(hh6);
    sec6.appendChild(makeField("¿Sufre de alguna enfermedad(es) (Sí/No)?", "enfermedades", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec6.appendChild(makeField("Alergias (Sí/No)", "alergias", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: Varicela", "vacunaVaricela", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: Sarampión", "vacunaSarampion", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: COVID", "vacunaCOVID", "select", ch.ficha, { required: true, options: ["Sí", "No"] }));
    sec6.appendChild(makeField("Tipo de Sangre", "tipoSangre", "text", ch.ficha, { required: true }));
    container.appendChild(sec6);
    let vive = ch.ficha.conQuienVive || '';
    if (vive === "Solo el Padre") {
      sec3.style.display = 'none';
      sec4.style.display = 'none';
    } else if (vive === "Solo la Madre") {
      sec2.style.display = 'none';
      sec4.style.display = 'none';
    } else if (vive === "Ambos Padres") {
      sec4.style.display = 'none';
    } else if (vive === "Apoderado") {
      sec2.style.display = 'none';
      sec3.style.display = 'none';
    }
    const btnFinish = document.createElement('button');
    btnFinish.className = 'finish-btn';
    btnFinish.textContent = 'Guardar';
    btnFinish.onclick = () => {
      let missing = checkFichaCompleta(ch);
      if (missing.length > 0) {
        alert("Faltan campos:\n- " + missing.join("\n- "));
        return;
      }
      ch.fichaCompleta = true;
      saveToFirebaseServices();
      renderFicha(ch);
    };
    container.appendChild(btnFinish);
  }
  function makeField(labelText, key, fieldType, fichaObj, opts) {
    const div = document.createElement('div');
    div.className = 'form-field';
    const lab = document.createElement('label');
    lab.textContent = labelText;
    div.appendChild(lab);
    let input;
    if (fieldType === "select") {
      input = document.createElement('select');
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = '-- Selecciona --';
      input.appendChild(emptyOption);
      (opts.options || []).forEach(o => {
        let op = document.createElement('option');
        op.value = o;
        op.textContent = o;
        input.appendChild(op);
      });
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    } else if (fieldType === "date") {
      input = document.createElement('input');
      input.type = 'date';
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    } else if (fieldType === "number") {
      input = document.createElement('input');
      input.type = 'text';
      input.value = fichaObj[key] || '';
      input.oninput = (e) => {
        e.target.value = e.target.value.replace(/[^\d]/g, '');
        fichaObj[key] = e.target.value;
      };
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    }
    div.appendChild(input);
    if (opts?.required) input.dataset.required = "true";
    input.dataset.key = key;
    return div;
  }
  function checkFichaCompleta(ch) {
    let missing = [];
    let f = ch.ficha;
    let sec1 = ["dni", "nomApeNino", "fechaNacNino", "lugarNacNino", "edadNino", "sexoNino", "religionNino", "tipoParto", "direccionNino", "nroHermanos", "telPrincipal", "telEmergencia", "centroMedico", "numSeguro", "tipoSeguro"];
    let sec5 = ["complicParto", "desarrolloMotriz", "levantaCabeza", "seSienta", "gatea", "sePara", "camina", "controlaEsfinteres", "primerasPalabras", "hablaFluidez"];
    let sec6 = ["enfermedades", "alergias", "vacunaVaricela", "vacunaSarampion", "vacunaCOVID", "tipoSangre"];
    let needed = [...sec1, ...sec5, ...sec6];
    if (f.conQuienVive === "Apoderado") {
      let sec4 = ["apellidosApod", "dniApod", "fechaNacApod", "religionApod", "estadoCivilApod", "gradoInstrApod", "ocupApod", "telApod", "emailApod"];
      needed.push(...sec4);
    }
    needed.forEach(k => {
      if (!f[k] || f[k].toString().trim() === '') {
        missing.push(k);
      }
    });
    return missing;
  }

  /**************************************************************
   * FUNCIONES ADMIN MATRÍCULAS
   **************************************************************/
  async function initMatriculas(){
    await loadFromFirebaseServices();
    sanitizeVariantIds();
    ensureMatriculaService();
    monthlyPaymentCheckAllServices();
  initSelectorMes('filtroMesMatriculas');
    renderMatriculasList();
  }
function monthlyPaymentCheckAllServices() {
  const currentYM = getYearMonth(); // e.g. "2025-06"

  services.forEach(serv => {
    serv.children.forEach(ch => {
      const prevYM = ch.lastPagoCheck || currentYM;

      if (prevYM !== currentYM) {
        const paidFull = !!ch.pagoPorMes?.[prevYM];
        const paidPartial = ch.partialPayments?.[prevYM];

        if (paidFull) {
          // Nada que hacer: pagó completo
        } else if (paidPartial != null) {
          // Registro deuda
          const owed = Math.max((ch.total || 0) - paidPartial, 0);
          if (!ch.deudaPorMes) ch.deudaPorMes = {};
          ch.deudaPorMes[prevYM] = owed;
        } else {
          // No pagó nada
          ch.pensionesAtrasadas = (ch.pensionesAtrasadas || 0) + 1;
        }
      }

      // Inicializar estado pago mes actual si no existía
      if (ch.pagoPorMes?.[currentYM] === undefined) {
        if (!ch.pagoPorMes) ch.pagoPorMes = {};
        ch.pagoPorMes[currentYM] = false;
      }

      ch.lastPagoCheck = currentYM;
    });
  });

  saveToFirebaseServices();
}
function filterMatriculasBySearch(){
  matriculasSearchTerm = document
      .getElementById("matriculasSearch")
      .value.trim()
      .toLowerCase();
  renderMatriculasList();        // vuelve a pintar con el filtro
}


function filterChildren(){
  childrenSearchTerm = document.getElementById("childrenSearch").value
                          .trim()
                          .toLowerCase();
  const serv   = services.find(s => s.id === editingServiceId);
  const mesSel = document.getElementById('servicesMes').value || getYearMonth();
  if(serv) renderChildrenTable(serv.children, mesSel);
}

  function eliminarSubtipo() {
  const sel = document.getElementById('egresoSubtipo');
  const subtipoSeleccionado = sel.value;
  if(!subtipoSeleccionado) {
    alert("Selecciona un subtipo para eliminar");
    return;
  }
  if(confirm(`¿Seguro que deseas eliminar el subtipo "${subtipoSeleccionado}"?`)) {
    // Elimina el subtipo del array
    subtiposEgresos = subtiposEgresos.filter(st => st !== subtipoSeleccionado);
    cargarSubtiposEgresos();
    saveFinanzasData(); // Guarda la lista actualizada en Firebase
  }
}

function renderMatriculasList(){
  const matServ = services.find(s => s.title === 'Matrícula');
  if(!matServ) return;

  const mesKey = document.getElementById('filtroMesMatriculas').value || getYearMonth();
  const tbody  = document.getElementById('tbodyMatriculas');
  tbody.innerHTML = '';

  /* 1️⃣ — filtramos primero */
  const alumnos = matServ.children
    .filter(ch => childIsActiveInMonth(ch, mesKey))
    .filter(ch => {
      if(!matriculasSearchTerm) return true;
      const fullName = (ch.lastname + ' ' + ch.name).toLowerCase();
      return fullName.includes(matriculasSearchTerm);
    });

  /* 2️⃣ — pintamos con el resultado filtrado */
  alumnos.forEach(ch => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = `${ch.lastname} ${ch.name}`;
    row.insertCell(1).textContent = getVariantName(ch.variantId) || '';

    /* ——— Botón Ficha ——— */
    const cellF = row.insertCell(2);
    const btnF  = document.createElement('button');
    btnF.className = 'ficha-btn';
    btnF.style.backgroundColor = ch.fichaCompleta ? '#3BB273' : '#E74C3C';
btnF.style.color           = '#fff';
    btnF.textContent = 'Ficha Informativa';
    btnF.onclick = () => openFicha(ch);
    cellF.appendChild(btnF);

    /* ——— Pagó Pensión ——— */
    const cellP  = row.insertCell(3);
    const pagado = !!ch.pagoPorMes?.[mesKey];
    const btnP   = document.createElement('button');
    btnP.className = 'pension-btn';
    btnP.style.backgroundColor = pagado ? '#3BB273' : '#E74C3C';
btnP.style.color           = '#fff';
    btnP.textContent = pagado ? 'Sí' : 'No';
    btnP.onclick = () => {
      if(!ch.pagoPorMes) ch.pagoPorMes = {};
      ch.pagoPorMes[mesKey] = !pagado;
      saveToFirebaseServices();
      renderMatriculasList();
    };
    cellP.appendChild(btnP);

    /* ——— Atrasos ——— */
    const cellA = row.insertCell(4);
    const inputA = document.createElement('input');
    inputA.type  = 'number';
    inputA.style.width = '60px';
    inputA.value = ch.pensionesAtrasadas || 0;
    inputA.onchange = () => {
      ch.pensionesAtrasadas = parseInt(inputA.value) || 0;
      saveToFirebaseServices();
    };
    cellA.appendChild(inputA);
  });
}

/* ==========================================================
   Filtro de la tabla de Matrículas
   ========================================================== */
function filtrarMatriculas () {
  /* servicio “Matrícula” */
  const matServ = services.find(s => s.title === 'Matrícula');
  if (!matServ) return;

  const mesKey      = document.getElementById('filtroMesMatriculas').value || getYearMonth();
  const valAno      = document.getElementById('filtroAno').value;          // 1,2,3,4,5 ó ""
  const valPension  = document.getElementById('filtroPension').value;      // "SI","NO" ó ""

  /* ------------ filtros ---------------- */
  let arr = matServ.children.filter(ch => childIsActiveInMonth(ch, mesKey));

  if (valAno) {                       // año escolar
    arr = arr.filter(ch => getVariantName(ch.variantId) === valAno);
  }

  if (valPension === 'SI') {          // adeudan pensión
    arr = arr.filter(ch => !ch.pagoPorMes?.[mesKey] || (ch.pensionesAtrasadas > 0));
  } else if (valPension === 'NO') {   // al día
    arr = arr.filter(ch =>  ch.pagoPorMes?.[mesKey] && (ch.pensionesAtrasadas === 0));
  }

  /* ------------ pintamos la tabla --------------- */
  const tbody = document.getElementById('tbodyMatriculas');
  tbody.innerHTML = '';

  arr.forEach(ch => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = `${ch.lastname} ${ch.name}`;
    row.insertCell(1).textContent = getVariantName(ch.variantId) || '';

    /* — Ficha Informativa — */
    const cellF = row.insertCell(2);
    const btnF  = document.createElement('button');
    btnF.className           = 'ficha-btn';
    btnF.style.backgroundColor = ch.fichaCompleta ? '#3BB273' : '#E74C3C';
    btnF.textContent         = 'Ficha Informativa';
    btnF.onclick             = () => openFicha(ch);
    cellF.appendChild(btnF);

    /* — Pagó pensión mesKey — */
    const cellP   = row.insertCell(3);
    const pagado  = !!ch.pagoPorMes?.[mesKey];
    const btnP    = document.createElement('button');
    btnP.className           = 'pension-btn';
    btnP.style.backgroundColor = pagado ? '#3BB273' : '#E74C3C';
    btnP.textContent         = pagado ? 'Sí' : 'No';
    btnP.onclick = () => {
      if (!ch.pagoPorMes) ch.pagoPorMes = {};
      ch.pagoPorMes[mesKey] = !pagado;
      saveToFirebaseServices();
      filtrarMatriculas();           // refrescar vista
    };
    cellP.appendChild(btnP);

    /* — Pensiones atrasadas — */
    const cellA = row.insertCell(4);
    const inputA = document.createElement('input');
    inputA.type        = 'number';
    inputA.style.width = '60px';
    inputA.value       = ch.pensionesAtrasadas || 0;
    inputA.onchange = () => {
      ch.pensionesAtrasadas = parseInt(inputA.value) || 0;
      saveToFirebaseServices();
    };
    cellA.appendChild(inputA);
  });
}

async function loadUsersFromFirebase(){
  try{
    const snap = await getDocs(collection(db,'users'));
    users = snap.docs.map(d => ({ username:d.id, ...d.data() }));
  }catch(err){
    console.error('[Firestore] error leyendo usuarios:', err);
    users = [];   // evita undefined
  }
}
async function goToUsers(){
  if(!currentUser || currentUser.username !== "renatozepi"){
    alert("Solo el administrador principal puede gestionar usuarios.");
    return;
  }
  await withLoader(async ()=>{
    // Oculta todo lo anterior
    document.querySelectorAll('.app-container')
            .forEach(c => c.classList.remove('activeContainer'));
    document.getElementById('landingPage').classList.add('hidden');

    // Muestra Users
    const uc = document.getElementById('usersContainer');
    uc.style.removeProperty('display');   // ⬅️  quita display:none inline
    uc.classList.add('activeContainer');

    screenStack.push('users');

    // Carga y muestra
    await loadUsersFromFirebase();
    showUsersList();
    openTabUsers('UsersMain');
  });
}
function descargarFichaWord(ch) {
  const year = new Date().getFullYear();
  const fileName = `Ficha Informativa_${year}_${ch.name}_${ch.lastname}.doc`;
  const f = ch.ficha || {};

  // Construimos el contenido con TODAS las secciones de la ficha
  const contentHtml = `
    <h1 style="text-align:center;">Ficha Informativa</h1>
    <h2 style="text-align:center;">${ch.lastname} ${ch.name} - Año: ${year}</h2>
    <hr>

    <!-- Definimos el estilo para evitar cortes de página internos -->
    <style>
      .avoid-page-break {
        page-break-inside: avoid;
      }
    </style>

    <!-- Sección 1: Datos del Niño -->
    <div class="avoid-page-break">
      <h3>Sección 1: Datos del Niño</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>DNI</strong></td><td>${f.dni || ''}</td></tr>
        <tr><td><strong>Nombres y Apellidos</strong></td><td>${f.nomApeNino || ''}</td></tr>
        <tr><td><strong>Fecha de Nacimiento</strong></td><td>${f.fechaNacNino || ''}</td></tr>
        <tr><td><strong>Lugar de Nacimiento</strong></td><td>${f.lugarNacNino || ''}</td></tr>
        <tr><td><strong>Edad</strong></td><td>${f.edadNino || ''}</td></tr>
        <tr><td><strong>Sexo</strong></td><td>${f.sexoNino || ''}</td></tr>
        <tr><td><strong>Religión</strong></td><td>${f.religionNino || ''}</td></tr>
        <tr><td><strong>Tipo de Parto</strong></td><td>${f.tipoParto || ''}</td></tr>
        <tr><td><strong>Dirección</strong></td><td>${f.direccionNino || ''}</td></tr>
        <tr><td><strong>Nro. de Hermanos</strong></td><td>${f.nroHermanos || ''}</td></tr>
        <tr><td><strong>Tel. Principal</strong></td><td>${f.telPrincipal || ''}</td></tr>
        <tr><td><strong>Tel. Emergencia</strong></td><td>${f.telEmergencia || ''}</td></tr>
        <tr><td><strong>Centro Médico</strong></td><td>${f.centroMedico || ''}</td></tr>
        <tr><td><strong>Número de Seguro</strong></td><td>${f.numSeguro || ''}</td></tr>
        <tr><td><strong>Tipo de Seguro</strong></td><td>${f.tipoSeguro || ''}</td></tr>
        <tr><td><strong>¿Con quién vive?</strong></td><td>${f.conQuienVive || ''}</td></tr>
      </table>
    </div>
    <br>

    <!-- Sección 2: Datos del Padre -->
    <div class="avoid-page-break">
      <h3>Sección 2: Datos del Padre</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Apellidos y Nombres</strong></td><td>${f.apellidosPadre || ''}</td></tr>
        <tr><td><strong>DNI</strong></td><td>${f.dniPadre || ''}</td></tr>
        <tr><td><strong>Fecha Nac.</strong></td><td>${f.fechaNacPadre || ''}</td></tr>
        <tr><td><strong>Religión</strong></td><td>${f.religionPadre || ''}</td></tr>
        <tr><td><strong>Estado Civil</strong></td><td>${f.estadoCivilPadre || ''}</td></tr>
        <tr><td><strong>Grado Instrucción</strong></td><td>${f.gradoInstrPadre || ''}</td></tr>
        <tr><td><strong>Ocupación</strong></td><td>${f.ocupPadre || ''}</td></tr>
        <tr><td><strong>Teléfono</strong></td><td>${f.telPadre || ''}</td></tr>
        <tr><td><strong>Email</strong></td><td>${f.emailPadre || ''}</td></tr>
      </table>
    </div>
    <br>
    <p style="text-align:center;"><em>‎‎‎‎‎‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎</em></p>
    <!-- Sección 3: Datos de la Madre -->
    <div class="avoid-page-break">
      <h3>Sección 3: Datos de la Madre</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Apellidos y Nombres</strong></td><td>${f.apellidosMadre || ''}</td></tr>
        <tr><td><strong>DNI</strong></td><td>${f.dniMadre || ''}</td></tr>
        <tr><td><strong>Fecha Nac.</strong></td><td>${f.fechaNacMadre || ''}</td></tr>
        <tr><td><strong>Religión</strong></td><td>${f.religionMadre || ''}</td></tr>
        <tr><td><strong>Estado Civil</strong></td><td>${f.estadoCivilMadre || ''}</td></tr>
        <tr><td><strong>Grado Instrucción</strong></td><td>${f.gradoInstrMadre || ''}</td></tr>
        <tr><td><strong>Ocupación</strong></td><td>${f.ocupMadre || ''}</td></tr>
        <tr><td><strong>Teléfono</strong></td><td>${f.telMadre || ''}</td></tr>
        <tr><td><strong>Email</strong></td><td>${f.emailMadre || ''}</td></tr>
      </table>
    </div>
    <br>

    <!-- Sección 4: Datos del Apoderado -->
    <div class="avoid-page-break">
      <h3>Sección 4: Datos del Apoderado</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Apellidos y Nombres</strong></td><td>${f.apellidosApod || ''}</td></tr>
        <tr><td><strong>DNI</strong></td><td>${f.dniApod || ''}</td></tr>
        <tr><td><strong>Fecha Nac.</strong></td><td>${f.fechaNacApod || ''}</td></tr>
        <tr><td><strong>Religión</strong></td><td>${f.religionApod || ''}</td></tr>
        <tr><td><strong>Estado Civil</strong></td><td>${f.estadoCivilApod || ''}</td></tr>
        <tr><td><strong>Grado Instrucción</strong></td><td>${f.gradoInstrApod || ''}</td></tr>
        <tr><td><strong>Ocupación</strong></td><td>${f.ocupApod || ''}</td></tr>
        <tr><td><strong>Teléfono</strong></td><td>${f.telApod || ''}</td></tr>
        <tr><td><strong>Email</strong></td><td>${f.emailApod || ''}</td></tr>
      </table>
    </div>
    <br>

    <!-- Sección 5: Desarrollo -->
    <div class="avoid-page-break">
      <h3>Sección 5: Desarrollo</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Complicaciones Parto</strong></td><td>${f.complicParto || ''}</td></tr>
        <tr><td><strong>Desarrollo Motriz</strong></td><td>${f.desarrolloMotriz || ''}</td></tr>
        <tr><td><strong>Levanta Cabeza</strong></td><td>${f.levantaCabeza || ''}</td></tr>
        <tr><td><strong>Se Sienta</strong></td><td>${f.seSienta || ''}</td></tr>
        <tr><td><strong>Gatea</strong></td><td>${f.gatea || ''}</td></tr>
        <tr><td><strong>Se Para</strong></td><td>${f.sePara || ''}</td></tr>
        <tr><td><strong>Camina</strong></td><td>${f.camina || ''}</td></tr>
        <tr><td><strong>Controla Esfínteres</strong></td><td>${f.controlaEsfinteres || ''}</td></tr>
        <tr><td><strong>Primeras Palabras</strong></td><td>${f.primerasPalabras || ''}</td></tr>
        <tr><td><strong>Habla con Fluidez</strong></td><td>${f.hablaFluidez || ''}</td></tr>
      </table>
    </div>
    <br>
    <p style="text-align:center;"><em>‎‎‎‎‎‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎‎ ‎ ‎ ‎</em></p>
    <!-- Sección 6: Salud -->
    <div class="avoid-page-break">
      <h3>Sección 6: Salud</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Enfermedades</strong></td><td>${f.enfermedades || ''}</td></tr>
        <tr><td><strong>Alergias</strong></td><td>${f.alergias || ''}</td></tr>
        <tr><td><strong>Vacuna Varicela</strong></td><td>${f.vacunaVaricela || ''}</td></tr>
        <tr><td><strong>Vacuna Sarampión</strong></td><td>${f.vacunaSarampion || ''}</td></tr>
        <tr><td><strong>Vacuna COVID</strong></td><td>${f.vacunaCOVID || ''}</td></tr>
        <tr><td><strong>Tipo de Sangre</strong></td><td>${f.tipoSangre || ''}</td></tr>
      </table>
    </div>
    <br>


  `;

  // Armamos el HTML final:
  const preHtml = `
    <html>
    <head>
      <meta charset="UTF-8"/>
      <title>Ficha Informativa</title>
    </head>
    <body style="font-family:Arial, sans-serif; line-height:1.4; margin:20px;">
  `;
  const postHtml = `</body></html>`;
  const fullHtml = preHtml + contentHtml + postHtml;

  // Creamos un Blob con type "application/msword"
  const blob = new Blob([fullHtml], { type: "application/msword" });
  const url = URL.createObjectURL(blob);

  // Forzamos la descarga
  const link = document.createElement('a');
  link.href = url;
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // Liberamos el URL blob
  URL.revokeObjectURL(url);
}

function showUsersList(){
  const cont = document.getElementById('usersList');
  cont.innerHTML = '';

  if(!users.length){
    cont.innerHTML = '<p style="text-align:center; margin:12px 0;">(Sin usuarios registrados)</p>';
    return;
  }

  users.forEach(u => {
    const div = document.createElement('div');
    div.className = 'user-item';
    div.innerHTML = `
      <span>${u.username}</span>
      <div>
        <button onclick="editUser('${u.username}')">Editar Permisos</button>
        ${u.username !== 'renatozepi'
          ? `<button style="margin-left:6px" onclick="deleteUser('${u.username}')">Eliminar</button>`
          : '' }
      </div>`;
    cont.appendChild(div);
  });
}
async function deleteUser(username) {
  if(!confirm(`¿Estás seguro de eliminar el usuario "${username}"?`)) return;
  try {
    await deleteDoc(doc(db, "users", username));
    alert("Usuario eliminado");
    // Recargar la lista
    await loadUsersFromFirebase();
    showUsersList();
  } catch (error) {
    console.error("Error eliminando usuario:", error);
    alert("Error al eliminar usuario");
  }
}
async function saveUserToFirebase(userObj) {
  // userObj es un objeto con { username, password, permisos: {...} }
  const docRef = doc(db, "users", userObj.username);
  await setDoc(docRef, userObj, { merge: true });
}
async function crearUser(){
  const userName = document.getElementById('newUserName').value.trim();
  const userPass = document.getElementById('newUserPass').value;
  if(!userName || !userPass){
    alert("Completa el nombre de usuario y la contraseña.");
    return;
  }

  // Permisos por defecto, todos false
  const defaultPerms = {
    macros:false, macrosNinos:false,
    services:false, servicesVariants:false, servicesChildren:false,
    matriculas:false,
    finanzas:false, finanzasTotal:false, finanzasEgresos:false, finanzasIngresos:false
  };

  const newUser = {
    username: userName,
    password: userPass,
    permisos: defaultPerms
  };

  await saveUserToFirebase(newUser);
  alert("Usuario creado!");
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserPass').value = '';
  await loadUsersFromFirebase();
  showUsersList();
}
function editUser(username){
  editingUsername = username;
  openTabUsers('EditUser');
  const u = users.find(x => x.username === username);
  if(!u) return;
  document.getElementById('currentUserTitle').textContent = u.username;

  const p = u.permisos || {};
  document.getElementById('permMacros').checked           = !!p.macros;
  document.getElementById('permMacrosNinos').checked      = !!p.macrosNinos;
  document.getElementById('permServices').checked         = !!p.services;
  document.getElementById('permServicesVariants').checked = !!p.servicesVariants;
  document.getElementById('permServicesChildren').checked = !!p.servicesChildren;
  document.getElementById('permMatriculas').checked       = !!p.matriculas;
  document.getElementById('permFinanzas').checked         = !!p.finanzas;
  document.getElementById('permFinanzasTotal').checked    = !!p.finanzasTotal;
  document.getElementById('permFinanzasEgresos').checked  = !!p.finanzasEgresos;
  document.getElementById('permFinanzasIngresos').checked = !!p.finanzasIngresos;
}

async function guardarPermisosUsuario(){
  if(!editingUsername) return;
  const idx = users.findIndex(x => x.username === editingUsername);
  if(idx < 0) return;
  const u = users[idx];

  u.permisos.macros            = document.getElementById('permMacros').checked;
  u.permisos.macrosNinos       = document.getElementById('permMacrosNinos').checked;
  u.permisos.services          = document.getElementById('permServices').checked;
  u.permisos.servicesVariants  = document.getElementById('permServicesVariants').checked;
  u.permisos.servicesChildren  = document.getElementById('permServicesChildren').checked;
  u.permisos.matriculas        = document.getElementById('permMatriculas').checked;
  u.permisos.finanzas          = document.getElementById('permFinanzas').checked;
  u.permisos.finanzasTotal     = document.getElementById('permFinanzasTotal').checked;
  u.permisos.finanzasEgresos   = document.getElementById('permFinanzasEgresos').checked;
  u.permisos.finanzasIngresos  = document.getElementById('permFinanzasIngresos').checked;

  await saveUserToFirebase(u);
  alert("Permisos actualizados!");
  openTabUsers('UsersMain');
  showUsersList();
}
/* =========================================================
   USERS – cambio crítico: SIN loader anidado
   ========================================================= */
function openTabUsers(tabName){
  /* 1. limpiar estados */
  ['contentUsersMain','contentEditUser']
    .forEach(id => document.getElementById(id).classList.remove('activeTabContent'));
  ['tabUsersMain','tabEditUser']
    .forEach(id => document.getElementById(id).classList.remove('activeTab'));

  /* 2. activar el panel solicitado */
  if(tabName === 'EditUser'){
    document.getElementById('contentEditUser').classList.add('activeTabContent');
    document.getElementById('tabEditUser').classList.add('activeTab');
  }else{
    document.getElementById('contentUsersMain').classList.add('activeTabContent');
    document.getElementById('tabUsersMain').classList.add('activeTab');
  }
}


function initEgresosFilters() {
  // 1. Llenar el select de Tipo:
  const selectTipo = document.getElementById("filtroEgresosTipo");
  selectTipo.innerHTML = `
    <option value="">(Todos)</option>
    <option value="Fijo">Fijo</option>
    <option value="Variable">Variable</option>
  `;

  // 2. Llenar el select de Subtipo con lo que tengas en subtiposEgresos:
  const selectSubtipo = document.getElementById("filtroEgresosSubtipo");
  selectSubtipo.innerHTML = `<option value="">(Todos)</option>`;
  subtiposEgresos.forEach(st => {
    const opt = document.createElement("option");
    opt.value = st;
    opt.textContent = st;
    selectSubtipo.appendChild(opt);
  });
}
function initIngresosFilters() {
  // 1) El <select> de tipo: Matrícula / Taller
  const selectTipo = document.getElementById("filtroIngresosTipo");
  selectTipo.innerHTML = `
    <option value="">(Todos)</option>
    <option value="Matrícula">Matrícula</option>
    <option value="Taller">Taller</option>
  `;

  // 2) El <select> de "subtipo" será en realidad el nombre del servicio
  //    (que no sea "Matrícula").

  const selectSubtipo = document.getElementById("filtroIngresosSubtipo");
  selectSubtipo.innerHTML = `<option value="">(Todos)</option>`;

  // Recolectamos nombres de talleres (services que no sean 'Matrícula')
  const workshopNames = new Set();
  services.forEach(s => {
    if (s.title !== "Matrícula") {
      workshopNames.add(s.title);
    }
  });

  // Agregamos como opciones
  workshopNames.forEach(tallerName => {
    const opt = document.createElement("option");
    opt.value = tallerName;        // ej. "Danza", "Música"
    opt.textContent = tallerName;
    selectSubtipo.appendChild(opt);
  });
}

function filtrarEgresos() {
  // Si quieres re-renderizar solo la parte de egresos:
  // Recalcamos que "renderFinanzas()" ya llama a "renderTablaEgresos(...)"
  // y lo filtra. Por eso, con solo "renderFinanzas()" basta.
  renderFinanzas();
}
function filtrarIngresos() {
  // Igualmente, "renderFinanzas()" llama a "renderTablaIngresos(mesSeleccionado)"
  // y aplica el filtro. 
  renderFinanzas();
}






  /**************************************************************
   * EXPOSE FUNCTIONS TO GLOBAL (after DOMContentLoaded)
   **************************************************************/
/* =========================================================
   ENTER universal  – versión ampliada
   ========================================================= */
document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;

  const el  = e.target;
  const tag = el.tagName;
  if (tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT') return;

  /* contenedor lógico del formulario o zona de búsqueda */
  const container = el.closest(
    '.form-section, .finanzas-form, .create-macro, .create-service,' +
    '.children-search, .matriculas-search'
  );

  /* 1. si dentro hay un botón “principal”, dispararlo */
  if (container){
    const selectors = [
      'button[id^="btn"]',
      'button[type="button"]',
      'button:not([type])',
      '.listo-btn',
      '.matriculas-btn'
    ].join(', ');
    const btn = container.querySelector(selectors);
    if (btn){
      e.preventDefault();   // evitamos submit / beep
      btn.click();
      return;
    }
  }

  /* 2. si no hay botón → enfocar siguiente input visible */
  if (container){
    const focusables = Array.from(container.querySelectorAll('input, select, textarea'))
      .filter(n => !n.disabled && n.offsetParent);
    const idx = focusables.indexOf(el);
    if (idx > -1 && idx < focusables.length - 1){
      e.preventDefault();
      focusables[idx + 1].focus();
    }
  }
}, true);

   
   document.addEventListener('DOMContentLoaded', () => {
    window.goToMacros = goToMacros;
    window.goToServices = goToServices;
    window.goToMatriculas = goToMatriculas;
    window.goToFinanzas = goToFinanzas;
    window.goBack = goBack;
    window.goBackFicha = goBackFicha;
    window.openTabMacros = openTabMacros;
    window.crearMacro = crearMacro;
    window.agregarOguardarNino = agregarOguardarNino;
    window.agregarEgreso = agregarEgreso;
    window.generarTxt = generarTxt;
    window.guardarYVolver = guardarYVolver;
    window.openTabServices = openTabServices;
    window.openTabFinanzas = openTabFinanzas;
    window.crearService = crearService;
    window.agregarOguardarVariante = agregarOguardarVariante;
    window.doneVariants = doneVariants;
    window.agregarOguardarChild = agregarOguardarChild;
    window.doneChildren = doneChildren;
    window.filtrarMatriculas = filtrarMatriculas;
    window.initMatriculas = initMatriculas;
    window.renderMatriculasList = renderMatriculasList;
    window.agregarNuevoSubtipo = agregarNuevoSubtipo;
    window.cambiarMesFinanzas = cambiarMesFinanzas;
    window.eliminarSubtipo = eliminarSubtipo;
    window.currentUser = currentUser;
    window.goToUsers = goToUsers;
    window.crearUser = crearUser;
    window.guardarPermisosUsuario = guardarPermisosUsuario
    window.logout = logout
    window.filtrarEgresos = filtrarEgresos
    window.filtrarIngresos = filtrarIngresos
    window.filterChildren = filterChildren
    window.cambiarMesServices = cambiarMesServices
    window.cambiarMesMatriculas = cambiarMesMatriculas
    window.filterMatriculasBySearch = filterMatriculasBySearch;
    window.openDayPicker = openDayPicker;
    window.editUser   = editUser;
    window.deleteUser = deleteUser;
window.migrateLegacyProofs = migrateLegacyProofs;
window.migrateOldProofs    = migrateOldProofs;
  });
</script>
</body>
</html>
