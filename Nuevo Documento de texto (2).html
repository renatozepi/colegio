<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Men√∫ Principal</title>
  <!-- Fuente Poppins -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    /* =================== ESTILOS GENERALES =================== */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #e5efff;
      min-height: 100vh;
    }
    .hidden { display: none !important; }
    .active { display: block !important; }

    /* =================== LANDING PAGE =================== */
    #landingPage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #landingPage h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: #1a2e55;
    }
    .landing-buttons {
      display: flex;
      gap: 1rem;
    }
    .landing-buttons button {
      background-color: #f1c40f;
      color: #1a2e55;
      border: none;
      border-radius: 6px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    .landing-buttons button:hover {
      background-color: #1a2e55;
      color: #f1c40f;
    }

    /* =================== CONTENEDOR GENERAL =================== */
    .app-container {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding-bottom: 60px;
    }
    .activeContainer { display: block !important; }

    /* Bot√≥n Regresar */
    .bottom-left-btn {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background-color: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .bottom-left-btn:hover { background-color: #1a2e55; }

    /* =================== TABS =================== */
    .tabs {
      display: flex;
      background-color: #1a2e55;
      border-radius: 6px 6px 0 0;
    }
    .tab {
      flex: 1;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .tab:hover { background-color: #4a90e2; }
    .tab.activeTab { background-color: #4a90e2; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.activeTabContent { display: block; }

    /* =================== ESTILOS MACROS =================== */
    #macrosContainer .macros-list {
      display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;
    }
    #macrosContainer .macro-item {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    #macrosContainer .macro-item button {
      background: none; border: none; cursor: pointer; color: #4a90e2; font-weight: 600; margin-left: 10px;
    }
    #macrosContainer .macro-item button:hover { color: #1a2e55; }
    #macrosContainer .create-macro {
      display: flex; gap: 0.5rem; margin-top: 1rem; align-items: center;
    }
    #macrosContainer .create-macro input {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px;
      flex: 1; max-width: 300px;
    }
    #macrosContainer .create-macro button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #macrosContainer .create-macro button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    #macrosContainer .register-children-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    #macrosContainer .macro-title {
      font-size: 1.1rem; font-weight: 600; color: #4a90e2;
    }
    #macrosContainer .form-section {
      display: flex; flex-direction: column; max-width: 400px; gap: 0.5rem; margin-bottom: 1rem;
    }
    #macrosContainer .form-section label { font-weight: 600; }
    #macrosContainer .form-section input { border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; max-width: 220px; }
    #macrosContainer .child-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #macrosContainer .child-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #macrosContainer .child-table th,
    #macrosContainer .child-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    #macrosContainer .actions {
      margin-top: 1rem; display: flex; gap: 1rem;
    }
    #macrosContainer .actions button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #macrosContainer .actions button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }

    /* =================== ESTILOS SERVICES =================== */
    #servicesContainer .services-list {
      display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;
    }
    #servicesContainer .service-item {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    #servicesContainer .service-item button {
      background: none; border: none; cursor: pointer; color: #4a90e2; font-weight: 600; margin-left: 10px;
    }
    #servicesContainer .service-item button:hover { color: #1a2e55; }
    #servicesContainer .create-service {
      display: flex; gap: 0.5rem; margin-top: 1rem; align-items: center;
    }
    #servicesContainer .create-service input {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px;
      flex: 1; max-width: 300px;
    }
    #servicesContainer .create-service button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #servicesContainer .create-service button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    #servicesContainer .variants-form {
      display: flex; flex-direction: column; max-width: 400px; gap: 0.5rem; margin-top: 1rem;
    }
    #servicesContainer .days-container {
      display: flex; gap: 6px; margin: 6px 0;
    }
    .day-btn {
      background-color: #4a90e2; color: white; border: none; border-radius: 6px;
      padding: 6px 12px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
    }
    .day-btn.selected {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .variants-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #servicesContainer .variants-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .variants-table th, 
    #servicesContainer .variants-table td {
      border: 1px solid #ddd; padding: 8px;
    }
    #servicesContainer .children-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #servicesContainer .children-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .children-table th,
    #servicesContainer .children-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }

    /* =================== ESTILOS MATR√çCULAS =================== */
    #matriculasContainer .tabs-bar {
      background-color: #1a2e55;
      border-radius: 6px 6px 0 0;
      color: #fff;
      padding: 14px;
      font-weight: 600;
      font-size: 1rem;
    }
    #matriculasContainer .filter-section {
      margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;
    }
    #matriculasContainer .matriculas-list-table {
      width: 100%; border-collapse: collapse;
    }
    #matriculasContainer .matriculas-list-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #matriculasContainer .matriculas-list-table th,
    #matriculasContainer .matriculas-list-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    /* Ficha / Pensiones */
    .ficha-btn, .pension-btn {
      border: none;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 10px;
      outline: none;
    }

    /* =================== FICHA INFORMATIVA =================== */
    #fichaInformativaPanel {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding: 20px;
      padding-bottom: 60px; 
    }
    #fichaInformativaPanel h2 {
      margin-bottom: 1rem;
    }
    #fichaInformativaPanel .section-title {
      font-weight: 600; font-size: 1.1rem; margin-top: 1rem; color: #1a2e55;
    }
    .form-field {
      margin-bottom: 8px; display: flex; flex-direction: column; max-width: 400px;
    }
    .form-field label {
      font-weight: 600; margin-bottom: 2px;
    }
    .form-field input[type='text'],
    .form-field input[type='number'],
    .form-field textarea {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; max-width: 350px;
    }
    .form-field select, .form-field input[type='date'] {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; max-width: 200px;
    }
    .finish-btn {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; 
      padding: 8px 12px; font-weight: 600; cursor: pointer; margin-top: 1rem;
    }
    .finish-btn:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    .subsection {
      border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-top: 10px; 
    }
    .subsection h4 {
      margin-bottom: 5px;
    }
    .edit-section-btn {
      background: #4a90e2; color: #fff; border: none; border-radius: 6px; padding: 5px 8px; font-weight: 600; margin-left: 10px; cursor: pointer;
    }
    .edit-section-btn:hover {
      background-color: #1a2e55;
    }
  </style>
</head>
<body>

<!-- =================== LANDING PAGE =================== -->
<div id="landingPage">
  <h1>Bienvenid@, selecciona qu√© deseas administrar:</h1>
  <div class="landing-buttons">
    <button onclick="goToMacros()">Administrador de Macros</button>
    <button onclick="goToServices()">Administrador de Servicios</button>
    <button onclick="goToMatriculas()">Administrador de Matr√≠culas</button>
  </div>
</div>

<!-- =================== CONTENEDOR MACROS =================== -->
<div class="app-container" id="macrosContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabMacros" onclick="openTabMacros('Macros')">Administrador de Macros</div>
    <div class="tab" id="tabNinos" style="display:none;">Registrar Ni√±os</div>
  </div>
  <div class="tab-content activeTabContent" id="contentMacros">
    <h2>Administrador de Macros</h2>
    <p>Aqu√≠ puedes ver todas las macros, crear nuevas o gestionarlas.</p>
    <div class="macros-list" id="macrosList"></div>
    <div class="create-macro">
      <input type="text" id="tituloMacro" placeholder="T√≠tulo de la nueva macro..." />
      <button onclick="crearMacro()">Crear Macro</button>
    </div>
  </div>
  <div class="tab-content" id="contentNinos">
    <div class="register-children-header">
      <h2>Registrar Ni√±os</h2>
      <span class="macro-title" id="currentMacroTitle"></span>
    </div>
    <div class="form-section">
      <label>Nombre:</label>
      <input type="text" id="nombre" placeholder="Ej: ALESSA" />
      <label>Apellidos:</label>
      <input type="text" id="apellidos" placeholder="Ej: AGURTO HO" />
      <label>C√≥digo:</label>
      <div style="display:flex; align-items:center; gap:5px;">
        <span id="codigoFijo"></span>
        <input type="text" id="codigoRestante" placeholder="01" />
      </div>
      <label>Fecha:</label>
      <input type="date" id="fechaInscripcion" />
      <label>Importe:</label>
      <input type="number" id="importe" placeholder="Ej: 50.00" step="0.01" />
      <button onclick="agregarOguardarNino()" id="btnNinoPrincipal">Agregar Ni√±o</button>
    </div>
    <table class="child-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Apellidos</th>
          <th>C√≥digo</th>
          <th>Fecha</th>
          <th>Importe</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyNinos"></tbody>
    </table>
    <div class="actions">
      <button onclick="generarTxt()">Generar TXT</button>
      <button onclick="guardarYVolver()">Guardar y Volver</button>
    </div>
  </div>
</div>

<!-- =================== CONTENEDOR SERVICES =================== -->
<div class="app-container" id="servicesContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabServicesMain" onclick="openTabServices('ServicesMain')">Administrador de Servicios</div>
    <div class="tab" id="tabServicesVariants" style="display:none;">Creador de Variantes</div>
    <div class="tab" id="tabServicesChildren" style="display:none;">Administrar Ni√±os</div>
  </div>
  <div class="tab-content activeTabContent" id="contentServicesMain">
    <h2>Administrador de Servicios</h2>
    <p>Aqu√≠ puedes ver todos los servicios, crear nuevos o gestionarlos.</p>
    <div class="services-list" id="servicesList"></div>
    <div class="create-service">
      <input type="text" id="tituloService" placeholder="T√≠tulo del nuevo servicio..." />
      <button onclick="crearService()">Crear Servicio</button>
    </div>
  </div>
  <div class="tab-content" id="contentServicesVariants">
    <h2>Creador de Variantes</h2>
    <p id="currentServiceTitle" style="font-weight: 600; color:#4a90e2;"></p>
    <div class="variants-form">
      <label>Nombre de la variante:</label>
      <input type="text" id="variantName" placeholder="Ej: Ejemplo 1" />
      <label>Precio:</label>
      <input type="number" id="variantPrice" placeholder="Ej: 100.00" step="0.01" />
      <label>D√≠as de la semana:</label>
      <div class="days-container" id="daysContainer"></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div>
          <label>Hora de inicio:</label><br/>
          <input type="time" id="variantStart" />
        </div>
        <div>
          <label>Hora de t√©rmino:</label><br/>
          <input type="time" id="variantEnd" />
        </div>
      </div>
      <button style="margin-top:10px;" onclick="agregarOguardarVariante()" id="btnVariantPrincipal">Agregar Variante</button>
    </div>
    <table class="variants-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>D√≠as</th>
          <th>Precio</th>
          <th>Horario</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyVariants"></tbody>
    </table>
    <div class="actions">
      <button onclick="doneVariants()">Listo</button>
    </div>
  </div>
  <div class="tab-content" id="contentServicesChildren">
    <h2>Administrar Ni√±os</h2>
    <p id="currentServiceTitleChild" style="font-weight:600; color:#4a90e2;"></p>
    <div class="form-section">
      <label>Nombre:</label>
      <input type="text" id="childName" placeholder="Ej: JUAN" />
      <label>Apellidos:</label>
      <input type="text" id="childLastname" placeholder="Ej: PEREZ" />
      <label>Fecha Ingreso:</label>
      <input type="date" id="childDate" />
      <label id="labelVariantChild">Variante:</label>
      <select id="childVariantSelect">
        <!-- Llenado din√°mico -->
      </select>
      <button onclick="agregarOguardarChild()" id="btnChildPrincipal">Agregar Ni√±o</button>
    </div>
    <table class="children-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Apellidos</th>
          <th>Fecha</th>
          <th>Variante</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyChildren"></tbody>
    </table>
    <div class="actions">
      <button onclick="doneChildren()">Listo</button>
    </div>
  </div>
</div>

<!-- =================== CONTENEDOR MATR√çCULAS =================== -->
<div class="app-container" id="matriculasContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs-bar">Administrador de Matr√≠culas</div>
  <div class="filter-section">
    <label>A√±o:</label>
    <select id="filtroAno">
      <option value="">(Todos)</option>
      <option value="1">1 a√±o</option>
      <option value="2">2 a√±os</option>
      <option value="3">3 a√±os</option>
      <option value="4">4 a√±os</option>
      <option value="5">5 a√±os</option>
    </select>
    <label>Adeudan pensi√≥n:</label>
    <select id="filtroPension">
      <option value="">(Todos)</option>
      <option value="SI">S√≠</option>
      <option value="NO">No</option>
    </select>
    <button onclick="filtrarMatriculas()">Aplicar Filtro</button>
  </div>
  <table class="matriculas-list-table">
    <thead>
      <tr>
        <th>Apellidos y Nombres</th>
        <th>A√±o</th>
        <th>Ficha Informativa</th>
        <th>Pag√≥ Pensi√≥n</th>
        <th>Pensiones Atrasadas</th>
      </tr>
    </thead>
    <tbody id="tbodyMatriculas"></tbody>
  </table>
</div>

<!-- =================== FICHA INFORMATIVA =================== -->
<div id="fichaInformativaPanel">
  <button class="bottom-left-btn" onclick="goBackFicha()">Regresar</button>
  <h2>Ficha Informativa</h2>
  <div id="fichaContent" style="margin-bottom:30px;"></div>
</div>

<!-- =================== SCRIPT =================== -->
<script type="module">
  /*************************************************************
   * Firebase Initialization and Firestore Setup
   *************************************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

  // Tu configuraci√≥n de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCPSya0kEAydB8_WxEbei56KF36ZmJ1n7I",
    authDomain: "definitivo-4841f.firebaseapp.com",
    projectId: "definitivo-4841f",
    storageBucket: "definitivo-4841f.firebasestorage.app",
    messagingSenderId: "92662019661",
    appId: "1:92662019661:web:de3ccc7b6b5ae5e4134e04"
  };

  // Inicializar Firebase
  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  /*************************************************************
   * Global Variables and Screen Navigation
   *************************************************************/
  let screenStack = ["landing"];

  // Marcar como async para poder await cargar datos antes de proceder
  async function goToMacros(){
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('macrosContainer').classList.add('activeContainer');
    screenStack.push("macros");
    await initMacros();
  }
  async function goToServices(){
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('servicesContainer').classList.add('activeContainer');
    screenStack.push("services");
    await initServices();
  }
  async function goToMatriculas(){
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('matriculasContainer').classList.add('activeContainer');
    screenStack.push("matriculas");
    await initMatriculas();
  }
  function goBack(){
    screenStack.pop();
    const current = screenStack[screenStack.length-1];
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('macrosContainer')?.classList.remove('activeContainer');
    document.getElementById('servicesContainer')?.classList.remove('activeContainer');
    document.getElementById('matriculasContainer')?.classList.remove('activeContainer');
    if(current==="landing"){
      document.getElementById('landingPage').classList.remove('hidden');
    } else if(current==="macros"){
      document.getElementById('macrosContainer').classList.add('activeContainer');
    } else if(current==="services"){
      document.getElementById('servicesContainer').classList.add('activeContainer');
    } else if(current==="matriculas"){
      document.getElementById('matriculasContainer').classList.add('activeContainer');
      renderMatriculasList();
    }
  }
  function goBackFicha(){
    screenStack.pop();
    document.getElementById('fichaInformativaPanel').style.display = 'none';
    const curr = screenStack[screenStack.length - 1];
    if (curr === "matriculas") {
      document.getElementById('matriculasContainer').classList.add('activeContainer');
      renderMatriculasList();
    } else {
      goBack();
    }
  }

  /****************************************************
   * MACROS CODE (Con Firebase en lugar de localStorage)
   ****************************************************/
  let macros = [];
  let nextMacroId = 1;
  let nextAlumnoId = 1;
  let editingMacroId = null;
  let editingAlumnoId = null;
  let generateCount = 0;
  const anioActual = new Date().getFullYear();
  const anioDosDig = anioActual.toString().slice(-2);
  const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];

  async function loadFromFirebaseMacros(){
    try {
      const docRef = doc(db, "data", "macrosAlumnos");
      const docSnap = await getDoc(docRef);
      if(docSnap.exists()){
        const parsed = docSnap.data();
        macros = parsed.macros || [];
        nextMacroId = parsed.nextMacroId || 1;
        nextAlumnoId = parsed.nextAlumnoId || 1;
      } else {
        macros = [];
        nextMacroId = 1;
        nextAlumnoId = 1;
      }
    } catch(error){
      console.error("Error loading macros from Firebase:", error);
    }
  }
  async function saveToFirebaseMacros(){
    try {
      const docRef = doc(db, "data", "macrosAlumnos");
      const obj = { macros, nextMacroId, nextAlumnoId };
      await setDoc(docRef, obj, { merge: true });
      console.log("Macros data saved to Firebase");
    } catch(error){
      console.error("Error saving macros to Firebase:", error);
    }
  }
  async function initMacros() {
    await loadFromFirebaseMacros();
    mostrarMacros();
  }
  function mostrarMacros(){
    const container = document.getElementById('macrosList');
    container.innerHTML = '';
    macros.forEach(m => {
      const div = document.createElement('div');
      div.className = 'macro-item';
      const leftSpan = document.createElement('span');
      leftSpan.textContent = `${m.titulo} (Alumnos: ${m.alumnos.length})`;
      const rightDiv = document.createElement('div');
      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.onclick = () => editarMacro(m.id);
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Eliminar';
      btnDel.onclick = () => eliminarMacro(m.id);
      rightDiv.appendChild(btnEdit);
      rightDiv.appendChild(btnDel);
      div.appendChild(leftSpan);
      div.appendChild(rightDiv);
      container.appendChild(div);
    });
  }
  function crearMacro(){
    const titulo = document.getElementById('tituloMacro').value.trim();
    if(!titulo){
      alert('Ingresa un t√≠tulo para la macro');
      return;
    }
    const nueva = { id: nextMacroId++, titulo, alumnos: [] };
    macros.push(nueva);
    document.getElementById('tituloMacro').value = '';
    mostrarMacros();
    saveToFirebaseMacros();
    editarMacro(nueva.id);
  }
  function editarMacro(macroId){
    editingMacroId = macroId;
    const mac = macros.find(m => m.id === macroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    openTabMacros('Ninos');
    document.getElementById('currentMacroTitle').textContent = mac.titulo;
    mostrarAlumnosEnTablaMacros(mac.alumnos);
  }
  function eliminarMacro(macroId){
    if(!confirm('¬øSeguro de eliminar esta macro?')) return;
    macros = macros.filter(m => m.id !== macroId);
    mostrarMacros();
    saveToFirebaseMacros();
  }
  function mostrarAlumnosEnTablaMacros(arr){
    const tbody = document.getElementById('tbodyNinos');
    tbody.innerHTML = '';
    arr.forEach(al => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = al.nombre;
      row.insertCell(1).textContent = al.apellidos;
      row.insertCell(2).textContent = `CJ${anioDosDig}${al.codigoRestante}`;
      row.insertCell(3).textContent = al.fechaInscripcion;
      row.insertCell(4).textContent = al.importe.toFixed(2);
      const accCell = row.insertCell(5);
      const btnE = document.createElement('button');
      btnE.textContent = '‚úé';
      btnE.onclick = () => editarNinoMacros(al.id);
      accCell.appendChild(btnE);
      const btnD = document.createElement('button');
      btnD.textContent = 'üóëÔ∏è';
      btnD.style.marginLeft = '5px';
      btnD.onclick = () => eliminarAlumnoMacros(al.id);
      accCell.appendChild(btnD);
    });
  }
  function agregarOguardarNino(){
    if(!editingMacroId){
      alert('No hay una macro seleccionada.');
      return;
    }
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    const nombre = document.getElementById('nombre').value.trim().toUpperCase();
    const apellidos = document.getElementById('apellidos').value.trim().toUpperCase();
    const codigoRestante = document.getElementById('codigoRestante').value.trim().toUpperCase();
    const fechaInscripcion = document.getElementById('fechaInscripcion').value;
    const importe = parseFloat(document.getElementById('importe').value);
    if(!nombre || !apellidos || !codigoRestante || !fechaInscripcion || isNaN(importe)){
      alert('Completa todos los campos');
      return;
    }
    if(editingAlumnoId === null){
      const nuevo = {
        id: nextAlumnoId++,
        nombre,
        apellidos,
        codigoRestante,
        fechaInscripcion,
        importe
      };
      mac.alumnos.push(nuevo);
    } else {
      const idx = mac.alumnos.findIndex(a => a.id === editingAlumnoId);
      if(idx >= 0){
        mac.alumnos[idx].nombre = nombre;
        mac.alumnos[idx].apellidos = apellidos;
        mac.alumnos[idx].codigoRestante = codigoRestante;
        mac.alumnos[idx].fechaInscripcion = fechaInscripcion;
        mac.alumnos[idx].importe = importe;
      }
      editingAlumnoId = null;
      document.getElementById('btnNinoPrincipal').textContent = 'Agregar Ni√±o';
    }
    document.getElementById('nombre').value = '';
    document.getElementById('apellidos').value = '';
    document.getElementById('codigoRestante').value = '';
    document.getElementById('fechaInscripcion').value = '';
    document.getElementById('importe').value = '';
    mostrarAlumnosEnTablaMacros(mac.alumnos);
    saveToFirebaseMacros();
  }
  function editarNinoMacros(alumnoId){
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac) return;
    const al = mac.alumnos.find(a => a.id === alumnoId);
    if(!al) return;
    editingAlumnoId = alumnoId;
    document.getElementById('nombre').value = al.nombre;
    document.getElementById('apellidos').value = al.apellidos;
    document.getElementById('codigoRestante').value = al.codigoRestante;
    document.getElementById('fechaInscripcion').value = al.fechaInscripcion;
    document.getElementById('importe').value = al.importe;
    document.getElementById('btnNinoPrincipal').textContent = 'Guardar Ni√±o';
  }
  function eliminarAlumnoMacros(alumnoId){
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac) return;
    mac.alumnos = mac.alumnos.filter(a => a.id !== alumnoId);
    mostrarAlumnosEnTablaMacros(mac.alumnos);
    saveToFirebaseMacros();
  }
  function guardarYVolver(){
    openTabMacros('Macros');
    mostrarMacros();
    saveToFirebaseMacros();
  }
  function generarTxt(){
    if(!editingMacroId){
      alert('No hay macro seleccionada.');
      return;
    }
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    generateCount++;
    const hoy = new Date();
    const fechaFact = hoy.getFullYear().toString() + String(hoy.getMonth()+1).padStart(2, '0') + String(hoy.getDate()).padStart(2, '0');
    const ruc = '00018176347';
    const moneda = 'PEN';
    const numeroClase = '000';
    const tipoActu = 'P';
    let cabecera = '01' + ruc + numeroClase + moneda + fechaFact + '001' + ' '.repeat(7) + tipoActu + ' '.repeat(322) + '\r\n';
    let contenido = cabecera;
    const anioSiguiente = hoy.getFullYear() + 1;
    const fechaBloqueo = `${anioSiguiente}0930`;
    let contadorRegistros = 0;
    let sumaMin = 0, sumaMax = 0;
    mac.alumnos.forEach(item => {
      const fechaObj = new Date(item.fechaInscripcion);
      const anio = fechaObj.getFullYear();
      const mesInicio = fechaObj.getMonth();
      const diaInscripcion = fechaObj.getDate();
      for(let m = mesInicio; m < 12; m++){
        const nombreCompleto = (item.apellidos + ' ' + item.nombre).substring(0,30).padEnd(30, ' ');
        const yy = anio.toString().slice(-2);
        const mesNombre = meses[m];
        let codigoConc = `0CJ${yy}${item.codigoRestante}${mesNombre}`.substring(0,40).padEnd(40, ' ');
        const mesStr = String(m+1).padStart(2, '0');
        const diaStr = String(diaInscripcion).padStart(2, '0');
        const fechaVenc = `${anio}${mesStr}${diaStr}`;
        const importeCentavos = Math.round(item.importe * 100);
        const importeStr = importeCentavos.toString().padStart(15, '0');
        sumaMin += importeCentavos;
        sumaMax += importeCentavos;
        let linea = '02' + nombreCompleto + codigoConc + ' '.repeat(8) + fechaVenc + fechaBloqueo + '0'.repeat(2)
          + importeStr + importeStr + '0'.repeat(180) + 'L000000000000000' + '\r\n';
        contenido += linea;
        contadorRegistros++;
      }
    });
    let linea03 = '03';
    linea03 += String(contadorRegistros).padStart(9, '0');
    linea03 += String(sumaMin).padStart(18, '0');
    linea03 += String(sumaMax).padStart(18, '0');
    linea03 += '0'.repeat(18);
    linea03 += ' '.repeat(295);
    contenido += linea03;
    const filename = `carga_bbva_${fechaFact}_${generateCount}.txt`;
    const blob = new Blob([contenido], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  function openTabMacros(tabName){
    document.getElementById('contentMacros').classList.remove('activeTabContent');
    document.getElementById('contentNinos').classList.remove('activeTabContent');
    document.getElementById('tabMacros').classList.remove('activeTab');
    document.getElementById('tabNinos').classList.remove('activeTab');
    if(tabName === 'Macros'){
      document.getElementById('contentMacros').classList.add('activeTabContent');
      document.getElementById('tabMacros').classList.add('activeTab');
    } else {
      document.getElementById('contentNinos').classList.add('activeTabContent');
      document.getElementById('tabNinos').classList.add('activeTab');
    }
  }

  /**************************************************************
   * ADMIN SERVICES
   **************************************************************/
  let services = [];
  let editingVariantId = null;
  let nextServiceId = 1;
  let nextVariantId = 1;
  let nextServiceChildId = 1;
  let serviceCheckDone = false; 
  let MATRICULA_ID = null;
  let editingServiceId = null;
  let editingServiceChildId = null;
  // editingVariantId ya se declar√≥ en macros
  async function loadFromFirebaseServices(){
    try {
      const docRef = doc(db, "data", "servicesData");
      const docSnap = await getDoc(docRef);
      if(docSnap.exists()){
        const parsed = docSnap.data();
        services = parsed.services || [];
        nextServiceId = parsed.nextServiceId || 1;
        nextVariantId = parsed.nextVariantId || 1;
        nextServiceChildId = parsed.nextServiceChildId || 1;
      } else {
        services = [];
        nextServiceId = 1;
        nextVariantId = 1;
        nextServiceChildId = 1;
      }
    } catch(error){
      console.error("Error loading services from Firebase:", error);
    }
  }
  async function saveToFirebaseServices(){
    try {
      const docRef = doc(db, "data", "servicesData");
      const obj = { services, nextServiceId, nextVariantId, nextServiceChildId };
      await setDoc(docRef, obj, { merge: true });
      console.log("Services data saved to Firebase");
    } catch(error){
      console.error("Error saving services to Firebase:", error);
    }
  }
  async function initServices(){
    await loadFromFirebaseServices();
    ensureMatriculaService();
    showServicesList();
    setupDaysButtons();
  }
  function ensureMatriculaService(){
    if(serviceCheckDone) return;
    serviceCheckDone = true;
    let mat = services.find(s => s.title === 'Matr√≠cula');
    if(!mat){
      mat = {
        id: nextServiceId++,
        title: 'Matr√≠cula',
        variants: [],
        children: []
      };
      services.unshift(mat);
      for(let i = 1; i <= 5; i++){
        const v = {
          id: nextVariantId++,
          name: i.toString(),
          price: 480,
          days: ['LUN','MAR','MIE','JUE','VIE'],
          start: '07:30',
          end: '13:00'
        };
        mat.variants.push(v);
      }
      saveToFirebaseServices();
    }
    MATRICULA_ID = mat.id;
  }
  function openTabServices(tabName){
    document.getElementById('contentServicesMain').classList.remove('activeTabContent');
    document.getElementById('contentServicesVariants').classList.remove('activeTabContent');
    document.getElementById('contentServicesChildren').classList.remove('activeTabContent');
    document.getElementById('tabServicesMain').classList.remove('activeTab');
    document.getElementById('tabServicesVariants').classList.remove('activeTab');
    document.getElementById('tabServicesChildren').classList.remove('activeTab');
    if(tabName === 'ServicesMain'){
      document.getElementById('contentServicesMain').classList.add('activeTabContent');
      document.getElementById('tabServicesMain').classList.add('activeTab');
    } else if(tabName === 'ServicesVariants'){
      document.getElementById('contentServicesVariants').classList.add('activeTabContent');
      document.getElementById('tabServicesVariants').classList.add('activeTab');
    } else {
      document.getElementById('contentServicesChildren').classList.add('activeTabContent');
      document.getElementById('tabServicesChildren').classList.add('activeTab');
    }
  }
  function showServicesList(){
    const container = document.getElementById('servicesList');
    container.innerHTML = '';
    services.sort((a, b) => {
      if(a.title === 'Matr√≠cula') return -1;
      if(b.title === 'Matr√≠cula') return 1;
      return 0;
    });
    services.forEach(s => {
      const div = document.createElement('div');
      div.className = 'service-item';
      const leftSpan = document.createElement('span');
      leftSpan.textContent = `${s.title} (Variantes: ${s.variants.length}) (Ni√±os: ${s.children.length})`;
      const rightDiv = document.createElement('div');
      if(s.title !== 'Matr√≠cula'){
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Editar';
        btnEdit.onclick = () => editService(s.id);
        rightDiv.appendChild(btnEdit);
      }
      const btnMat = document.createElement('button');
      btnMat.textContent = 'Administrar Ni√±os';
      btnMat.onclick = () => openServiceChildren(s.id);
      rightDiv.appendChild(btnMat);
      if(s.title !== 'Matr√≠cula'){
        const btnDel = document.createElement('button');
        btnDel.textContent = 'Eliminar';
        btnDel.onclick = () => deleteService(s.id);
        rightDiv.appendChild(btnDel);
      }
      div.appendChild(leftSpan);
      div.appendChild(rightDiv);
      container.appendChild(div);
    });
  }
  function crearService(){
    const title = document.getElementById('tituloService').value.trim();
    if(!title){
      alert('Ingresa un t√≠tulo para el servicio');
      return;
    }
    if(title === 'Matr√≠cula'){
      alert('Ya existe "Matr√≠cula"');
      return;
    }
    const newService = { id: nextServiceId++, title, variants: [], children: [] };
    services.push(newService);
    document.getElementById('tituloService').value = '';
    showServicesList();
    saveToFirebaseServices();
    editService(newService.id);
  }
  function editService(serviceId){
    const serv = services.find(s => s.id === serviceId);
    if(!serv) return;
    if(serv.title === 'Matr√≠cula'){
      alert('No se puede editar el servicio "Matr√≠cula"');
      return;
    }
    editingServiceId = serviceId;
    openTabServices('ServicesVariants');
    document.getElementById('tabServicesVariants').style.display = 'block';
    document.getElementById('currentServiceTitle').textContent = serv.title;
    clearVariantForm();
    renderVariantsTable(serv.variants);
  }
  function deleteService(serviceId){
    if(!confirm('¬øSeguro de eliminar este servicio?')) return;
    services = services.filter(s => s.id !== serviceId);
    showServicesList();
    saveToFirebaseServices();
  }
  /* Variants logic */
  function setupDaysButtons(){
    const dayLabels = ['LUN','MAR','MIE','JUE','VIE'];
    const container = document.getElementById('daysContainer');
    container.innerHTML = '';
    dayLabels.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'day-btn';
      btn.textContent = d;
      btn.onclick = () => btn.classList.toggle('selected');
      container.appendChild(btn);
    });
  }
  function clearVariantForm(){
    editingVariantId = null;
    document.getElementById('variantName').value = '';
    document.getElementById('variantPrice').value = '';
    document.getElementById('variantStart').value = '';
    document.getElementById('variantEnd').value = '';
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('btnVariantPrincipal').textContent = 'Agregar Variante';
  }
  function agregarOguardarVariante(){
    if(!editingServiceId){
      alert('No hay servicio seleccionado.');
      return;
    }
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv){
      alert('Servicio no encontrado');
      return;
    }
    const name = document.getElementById('variantName').value.trim();
    const price = parseFloat(document.getElementById('variantPrice').value);
    const startT = document.getElementById('variantStart').value;
    const endT = document.getElementById('variantEnd').value;
    const selectedDays = [];
    document.querySelectorAll('.day-btn.selected').forEach(btn => selectedDays.push(btn.textContent));
    if(!name || isNaN(price) || !startT || !endT){
      alert('Completa todos los campos de la variante');
      return;
    }
    if(editingVariantId === null){
      const newVar = {
        id: nextVariantId++,
        name,
        price,
        days: selectedDays,
        start: startT,
        end: endT
      };
      serv.variants.push(newVar);
    } else {
      const idx = serv.variants.findIndex(v => v.id === editingVariantId);
      if(idx >= 0){
        serv.variants[idx].name = name;
        serv.variants[idx].price = price;
        serv.variants[idx].days = selectedDays;
        serv.variants[idx].start = startT;
        serv.variants[idx].end = endT;
      }
      editingVariantId = null;
      document.getElementById('btnVariantPrincipal').textContent = 'Agregar Variante';
    }
    clearVariantForm();
    renderVariantsTable(serv.variants);
    saveToFirebaseServices();
  }
  function renderVariantsTable(arr){
    const tbody = document.getElementById('tbodyVariants');
    tbody.innerHTML = '';
    arr.forEach(v => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = v.name;
      row.insertCell(1).textContent = v.days.join(', ');
      row.insertCell(2).textContent = `S/${v.price}`;
      row.insertCell(3).textContent = `${v.start} - ${v.end}`;
      const accCell = row.insertCell(4);
      const btnEd = document.createElement('button');
      btnEd.textContent = 'editar';
      btnEd.onclick = () => editVariant(v.id);
      accCell.appendChild(btnEd);
      const btnDel = document.createElement('button');
      btnDel.textContent = ' x ';
      btnDel.style.marginLeft = '5px';
      btnDel.onclick = () => deleteVariant(v.id);
      accCell.appendChild(btnDel);
    });
  }
  function editVariant(variantId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    const vr = serv.variants.find(v => v.id === variantId);
    if(!vr) return;
    editingVariantId = variantId;
    document.getElementById('variantName').value = vr.name;
    document.getElementById('variantPrice').value = vr.price;
    document.getElementById('variantStart').value = vr.start;
    document.getElementById('variantEnd').value = vr.end;
    document.querySelectorAll('.day-btn').forEach(btn => {
      if(vr.days.includes(btn.textContent)) btn.classList.add('selected');
      else btn.classList.remove('selected');
    });
    document.getElementById('btnVariantPrincipal').textContent = 'Guardar Variante';
  }
  function deleteVariant(variantId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    serv.variants = serv.variants.filter(v => v.id !== variantId);
    renderVariantsTable(serv.variants);
    saveToFirebaseServices();
  }
  function doneVariants(){
    openTabServices('ServicesMain');
    showServicesList();
    saveToFirebaseServices();
  }
  /* Administrar Ni√±os */
  function openServiceChildren(serviceId){
    editingServiceId = serviceId;
    const serv = services.find(s => s.id === serviceId);
    if(!serv) return;
    openTabServices('ServicesChildren');
    document.getElementById('tabServicesChildren').style.display = 'block';
    document.getElementById('currentServiceTitleChild').textContent = serv.title;
    clearChildForm();
    renderChildrenTable(serv.children);
    const lab = document.getElementById('labelVariantChild');
    if(serv.title === 'Matr√≠cula') lab.textContent = 'A√±o';
    else lab.textContent = 'Variante';
    const sel = document.getElementById('childVariantSelect');
    sel.innerHTML = '';
    if(serv.variants.length === 0){
      const opt = document.createElement('option');
      opt.text = 'Sin variantes';
      sel.add(opt);
      sel.disabled = true;
    } else if(serv.variants.length === 1){
      sel.disabled = true;
      const v = serv.variants[0];
      const opt = document.createElement('option');
      opt.value = v.id;
      opt.textContent = v.name;
      sel.add(opt);
    } else {
      sel.disabled = false;
      serv.variants.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.name;
        sel.appendChild(opt);
      });
    }
  }
  function clearChildForm(){
    editingServiceChildId = null;
    document.getElementById('childName').value = '';
    document.getElementById('childLastname').value = '';
    document.getElementById('childDate').value = '';
    document.getElementById('btnChildPrincipal').textContent = 'Agregar Ni√±o';
  }
  function renderChildrenTable(arr){
    const tbody = document.getElementById('tbodyChildren');
    tbody.innerHTML = '';
    const serv = services.find(s => s.id === editingServiceId);
    arr.forEach(ch => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = ch.name;
      row.insertCell(1).textContent = ch.lastname;
      row.insertCell(2).textContent = ch.date;
      const variant = serv.variants.find(v => v.id === ch.variantId);
      row.insertCell(3).textContent = variant ? variant.name : 'Sin variante';
      const accCell = row.insertCell(4);
      const btnEd = document.createElement('button');
      btnEd.textContent = '‚úé';
      btnEd.onclick = () => editServiceChild(ch.id);
      accCell.appendChild(btnEd);
      const btnDel = document.createElement('button');
      btnDel.textContent = 'üóëÔ∏è';
      btnDel.style.marginLeft = '5px';
      btnDel.onclick = () => deleteServiceChild(ch.id);
      accCell.appendChild(btnDel);
    });
  }
  function agregarOguardarChild(){
    if(!editingServiceId){
      alert('No hay servicio seleccionado');
      return;
    }
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    const name = document.getElementById('childName').value.trim().toUpperCase();
    const lastname = document.getElementById('childLastname').value.trim().toUpperCase();
    const dateIn = document.getElementById('childDate').value;
    const sel = document.getElementById('childVariantSelect');
    let variantId = null;
    if(sel.options.length === 1 && !sel.disabled){
      variantId = parseInt(sel.options[0].value);
    } else if(!sel.disabled){
      variantId = parseInt(sel.value);
    } else if(sel.disabled && serv.variants.length === 1){
      variantId = serv.variants[0].id;
    }
    if(!name || !lastname || !dateIn){
      alert('Completa todos los campos');
      return;
    }
    if(editingServiceChildId === null){
      const nuevo = {
        id: nextServiceChildId++,
        name,
        lastname,
        date: dateIn,
        variantId,
        ficha: {},
        fichaCompleta: false,
        pagoPension: false,
        pensionesAtrasadas: 0,
        lastPagoCheck: getYearMonth()
      };
      serv.children.push(nuevo);
    } else {
      const idx = serv.children.findIndex(c => c.id === editingServiceChildId);
      if(idx >= 0){
        serv.children[idx].name = name;
        serv.children[idx].lastname = lastname;
        serv.children[idx].date = dateIn;
        serv.children[idx].variantId = variantId;
      }
      editingServiceChildId = null;
      document.getElementById('btnChildPrincipal').textContent = 'Agregar Ni√±o';
    }
    clearChildForm();
    renderChildrenTable(serv.children);
    saveToFirebaseServices();
  }
  function editServiceChild(childId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    const ch = serv.children.find(c => c.id === childId);
    if(!ch) return;
    editingServiceChildId = childId;
    document.getElementById('childName').value = ch.name;
    document.getElementById('childLastname').value = ch.lastname;
    document.getElementById('childDate').value = ch.date;
    document.getElementById('btnChildPrincipal').textContent = 'Guardar Ni√±o';
    const sel = document.getElementById('childVariantSelect');
    if(!sel.disabled && ch.variantId) sel.value = ch.variantId;
  }
  function deleteServiceChild(childId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    serv.children = serv.children.filter(c => c.id !== childId);
    renderChildrenTable(serv.children);
    saveToFirebaseServices();
  }
  function doneChildren(){
    openTabServices('ServicesMain');
    showServicesList();
    saveToFirebaseServices();
  }
  function getVariantName(varId){
    if(!varId) return null;
    for(const s of services){
      const fv = s.variants.find(v => v.id === varId);
      if(fv) return fv.name;
    }
    return null;
  }
  function getYearMonth(){
    const d = new Date();
    return d.getFullYear().toString() + '-' + String(d.getMonth()+1).padStart(2, '0');
  }

  /**************************************************************
   * FICHA INFORMATIVA
   **************************************************************/
  let currentFichaChild = null;
  function openFicha(childObj) {
    currentFichaChild = childObj;
    document.getElementById('matriculasContainer').classList.remove('activeContainer');
    screenStack.push("ficha");
    document.getElementById('fichaInformativaPanel').style.display = 'block';
    renderFicha(childObj);
  }
  function renderFicha(ch) {
    const cont = document.getElementById('fichaContent');
    cont.innerHTML = '';
    if (!ch.ficha) ch.ficha = {};
    if (!ch.hasOwnProperty('fichaCompleta')) ch.fichaCompleta = false;
    if (ch.fichaCompleta) {
      const h3 = document.createElement('h3');
      h3.textContent = "Ficha Informativa (Completada)";
      cont.appendChild(h3);
      // Mostrar todas las respuestas iterando sobre el objeto ficha
      cont.innerHTML += createFichaResumenHTML(ch.ficha);
      const btnEd = document.createElement('button');
      btnEd.className = 'finish-btn';
      btnEd.textContent = 'Editar';
      btnEd.onclick = () => {
        ch.fichaCompleta = false;
        renderFicha(ch);
      };
      cont.appendChild(btnEd);
      const btnBack = document.createElement('button');
      btnBack.className = 'finish-btn';
      btnBack.style.marginLeft = '10px';
      btnBack.textContent = 'Regresar';
      btnBack.onclick = goBackFicha;
      cont.appendChild(btnBack);
    } else {
      createFichaForm(ch, cont);
    }
  }
  function createFichaResumenHTML(f) {
    let html = "<ul>";
    for (const key in f) {
      if (f.hasOwnProperty(key)) {
        html += `<li><strong>${key}:</strong> ${f[key]}</li>`;
      }
    }
    html += "</ul>";
    return html;
  }
  function createFichaForm(ch, container) {
    // Secci√≥n 1
    const sec1 = document.createElement('div');
    sec1.className = 'subsection';
    let h4_1 = document.createElement('h4');
    h4_1.textContent = "Secci√≥n 1: Datos del Ni√±o";
    sec1.appendChild(h4_1);
    sec1.appendChild(makeField("DNI", "dni", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Nombres y Apellidos", "nomApeNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Fecha de Nacimiento (d√≠a/mes/a√±o)", "fechaNacNino", "date", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Lugar de Nacimiento", "lugarNacNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Edad (en a√±os)", "edadNino", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Sexo", "sexoNino", "select", ch.ficha, { required: true, options: ["Masculino", "Femenino", "Otro"] }));
    sec1.appendChild(makeField("Religi√≥n", "religionNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tipo de Parto (Normal / Ces√°rea)", "tipoParto", "select", ch.ficha, { required: true, options: ["Normal", "Ces√°rea"] }));
    sec1.appendChild(makeField("Direcci√≥n", "direccionNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Nro. de Hermanos", "nroHermanos", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tel√©fono (principal)", "telPrincipal", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tel√©fono(s) de Emergencia", "telEmergencia", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Centro M√©dico en caso de urgencia", "centroMedico", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("N√∫mero de Seguro", "numSeguro", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tipo de Seguro", "tipoSeguro", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("¬øCon qui√©n o qui√©nes vive el menor?", "conQuienVive", "select", ch.ficha, {
      required: true,
      options: ["Solo el Padre", "Solo la Madre", "Ambos Padres", "Apoderado"]
    }));
    container.appendChild(sec1);
    // Secci√≥n 2 (Padre)
    const sec2 = document.createElement('div');
    sec2.className = 'subsection';
    let hh2 = document.createElement('h4');
    hh2.textContent = "Secci√≥n 2: Datos del Padre";
    sec2.appendChild(hh2);
    sec2.appendChild(makeField("Apellidos y Nombres", "apellidosPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("DNI", "dniPadre", "number", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Fecha de Nacimiento", "fechaNacPadre", "date", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Religi√≥n", "religionPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Estado Civil", "estadoCivilPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Grado de Instrucci√≥n", "gradoInstrPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Ocupaci√≥n", "ocupPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Tel√©fono", "telPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Correo Electr√≥nico", "emailPadre", "text", ch.ficha, { required: true }));
    container.appendChild(sec2);
    // Secci√≥n 3 (Madre)
    const sec3 = document.createElement('div');
    sec3.className = 'subsection';
    let hh3 = document.createElement('h4');
    hh3.textContent = "Secci√≥n 3: Datos de la Madre";
    sec3.appendChild(hh3);
    sec3.appendChild(makeField("Apellidos y Nombres", "apellidosMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("DNI", "dniMadre", "number", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Fecha de Nacimiento", "fechaNacMadre", "date", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Religi√≥n", "religionMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Estado Civil", "estadoCivilMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Grado de Instrucci√≥n", "gradoInstrMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Ocupaci√≥n", "ocupMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Tel√©fono", "telMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Correo Electr√≥nico", "emailMadre", "text", ch.ficha, { required: true }));
    container.appendChild(sec3);
    // Secci√≥n 4 (Apoderado)
    const sec4 = document.createElement('div');
    sec4.className = 'subsection';
    let hh4 = document.createElement('h4');
    hh4.textContent = "Secci√≥n 4: Datos del Apoderado";
    sec4.appendChild(hh4);
    sec4.appendChild(makeField("Apellidos y Nombres", "apellidosApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("DNI", "dniApod", "number", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Fecha de Nacimiento", "fechaNacApod", "date", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Religi√≥n", "religionApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Estado Civil", "estadoCivilApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Grado de Instrucci√≥n", "gradoInstrApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Ocupaci√≥n", "ocupApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Tel√©fono", "telApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Correo Electr√≥nico", "emailApod", "text", ch.ficha, { required: true }));
    container.appendChild(sec4);
    // Secci√≥n 5: Desarrollo
    const sec5 = document.createElement('div');
    sec5.className = 'subsection';
    let hh5 = document.createElement('h4');
    hh5.textContent = "Secci√≥n 5: Desarrollo";
    sec5.appendChild(hh5);
    sec5.appendChild(makeField("Complicaciones Durante el Parto (S√≠ / No), especificar", "complicParto", "text", ch.ficha, { required: true }));
    sec5.appendChild(makeField("Desarrollo Motriz", "desarrolloMotriz", "text", ch.ficha, { required: true }));
    sec5.appendChild(makeField("¬øYa levanta la cabeza?", "levantaCabeza", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øSe sienta?", "seSienta", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øGatea?", "gatea", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øSe para?", "sePara", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øCamina?", "camina", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øControla esf√≠nteres?", "controlaEsfinteres", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øYa dijo sus primeras palabras?", "primerasPalabras", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øYa habla con fluidez?", "hablaFluidez", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    container.appendChild(sec5);
    // Secci√≥n 6: Salud
    const sec6 = document.createElement('div');
    sec6.className = 'subsection';
    let hh6 = document.createElement('h4');
    hh6.textContent = "Secci√≥n 6: Salud";
    sec6.appendChild(hh6);
    sec6.appendChild(makeField("¬øSufre de alguna enfermedad(es) (S√≠/No)?", "enfermedades", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Alergias (S√≠/No)", "alergias", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: Varicela", "vacunaVaricela", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: Sarampi√≥n", "vacunaSarampion", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: COVID", "vacunaCOVID", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Tipo de Sangre", "tipoSangre", "text", ch.ficha, { required: true }));
    container.appendChild(sec6);
    let vive = ch.ficha.conQuienVive || '';
    if (vive === "Solo el Padre") {
      sec3.style.display = 'none';
      sec4.style.display = 'none';
    } else if (vive === "Solo la Madre") {
      sec2.style.display = 'none';
      sec4.style.display = 'none';
    } else if (vive === "Ambos Padres") {
      sec4.style.display = 'none';
    } else if (vive === "Apoderado") {
      sec2.style.display = 'none';
      sec3.style.display = 'none';
    }
    const btnFinish = document.createElement('button');
    btnFinish.className = 'finish-btn';
    btnFinish.textContent = 'Guardar';
    btnFinish.onclick = () => {
      let missing = checkFichaCompleta(ch);
      if (missing.length > 0) {
        alert("Faltan campos:\n- " + missing.join("\n- "));
        return;
      }
      ch.fichaCompleta = true;
      // Guarda los cambios de ficha en el servicio (si corresponde) en Firestore
      saveToFirebaseServices();
      renderFicha(ch);
    };
    container.appendChild(btnFinish);
  }
  function makeField(labelText, key, fieldType, fichaObj, opts) {
    const div = document.createElement('div');
    div.className = 'form-field';
    const lab = document.createElement('label');
    lab.textContent = labelText;
    div.appendChild(lab);
    let input;
    if (fieldType === "select") {
      input = document.createElement('select');
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = '-- Selecciona --';
      input.appendChild(emptyOption);
      (opts.options || []).forEach(o => {
        let op = document.createElement('option');
        op.value = o;
        op.textContent = o;
        input.appendChild(op);
      });
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    } else if (fieldType === "date") {
      input = document.createElement('input');
      input.type = 'date';
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    } else if (fieldType === "number") {
      input = document.createElement('input');
      input.type = 'text';
      input.value = fichaObj[key] || '';
      input.oninput = (e) => {
        e.target.value = e.target.value.replace(/[^\d]/g, '');
        fichaObj[key] = e.target.value;
      };
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    }
    div.appendChild(input);
    if (opts?.required) input.dataset.required = "true";
    input.dataset.key = key;
    return div;
  }
  function checkFichaCompleta(ch) {
    let missing = [];
    let f = ch.ficha;
    let sec1 = ["dni", "nomApeNino", "fechaNacNino", "lugarNacNino", "edadNino", "sexoNino", "religionNino", "tipoParto", "direccionNino", "nroHermanos", "telPrincipal", "telEmergencia", "centroMedico", "numSeguro", "tipoSeguro"];
    let sec5 = ["complicParto", "desarrolloMotriz", "levantaCabeza", "seSienta", "gatea", "sePara", "camina", "controlaEsfinteres", "primerasPalabras", "hablaFluidez"];
    let sec6 = ["enfermedades", "alergias", "vacunaVaricela", "vacunaSarampion", "vacunaCOVID", "tipoSangre"];
    let needed = [...sec1, ...sec5, ...sec6];
    if (f.conQuienVive === "Apoderado") {
      let sec4 = ["apellidosApod", "dniApod", "fechaNacApod", "religionApod", "estadoCivilApod", "gradoInstrApod", "ocupApod", "telApod", "emailApod"];
      needed.push(...sec4);
    }
    needed.forEach(k => {
      if (!f[k] || f[k].toString().trim() === '') {
        missing.push(k);
      }
    });
    return missing;
  }

  /**************************************************************
   * FUNCIONES ADMIN MATR√çCULAS
   **************************************************************/
  async function initMatriculas(){
    await loadFromFirebaseServices();
    ensureMatriculaService();
    monthlyPensionCheck();
    renderMatriculasList();
  }
  function monthlyPensionCheck(){
  const matServ = services.find(s => s.title === 'Matr√≠cula');
  if(!matServ) return;

  const currentYM = getYearMonth();
  matServ.children.forEach(ch => {
    if(ch.lastPagoCheck && ch.lastPagoCheck !== currentYM){
      if(!ch.pagoPension){
        ch.pensionesAtrasadas = (ch.pensionesAtrasadas || 0) + 1;
      }
      ch.pagoPension = false;
      ch.lastPagoCheck = currentYM;
    }
  });
  saveToFirebaseServices();
 }
  function renderMatriculasList(){
    const matServ = services.find(s => s.title === 'Matr√≠cula');
    if(!matServ) return;
    const tbody = document.getElementById('tbodyMatriculas');
    tbody.innerHTML = '';
    matServ.children.forEach(ch => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = `${ch.lastname} ${ch.name}`;
      row.insertCell(1).textContent = getVariantName(ch.variantId) || '';
      // Ficha Informativa
      const cellF = row.insertCell(2);
      const btnF = document.createElement('button');
      btnF.className = 'ficha-btn';
      btnF.style.fontWeight = '600';
      btnF.style.borderRadius = '8px';
      btnF.style.backgroundColor = ch.fichaCompleta ? '#3BB273' : '#E74C3C';
      btnF.style.color = '#fff';
      btnF.textContent = 'Ficha Informativa';
      btnF.onclick = () => openFicha(ch);
      cellF.appendChild(btnF);
      // Pago Pensi√≥n
      const cellP = row.insertCell(3);
      const btnP = document.createElement('button');
      btnP.className = 'pension-btn';
      btnP.style.fontWeight = '600';
      btnP.style.borderRadius = '8px';
      btnP.style.color = '#fff';
      btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
      btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
      btnP.onclick = () => {
        ch.pagoPension = !ch.pagoPension;
        btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
        btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
        saveToFirebaseServices();
      };
      cellP.appendChild(btnP);
      // Pensiones Atrasadas
      const cellA = row.insertCell(4);
      const inputA = document.createElement('input');
      inputA.type = 'number';
      inputA.style.width = '60px';
      inputA.value = ch.pensionesAtrasadas || 0;
      inputA.onchange = () => {
        ch.pensionesAtrasadas = parseInt(inputA.value) || 0;
        saveToFirebaseServices();
      };
      cellA.appendChild(inputA);
    });
  }
  function filtrarMatriculas(){
    const valAno = document.getElementById('filtroAno').value;
    const valPension = document.getElementById('filtroPension').value;
    const matServ = services.find(s => s.title === 'Matr√≠cula');
    if(!matServ) return;
    let arr = [...matServ.children];
    if(valAno){
      // Suponiendo que el campo variantId almacena el a√±o (ajusta seg√∫n tu l√≥gica)
      arr = arr.filter(ch => getVariantName(ch.variantId) === valAno);
    }
    if(valPension === 'SI'){
      arr = arr.filter(ch => (!ch.pagoPension || ch.pensionesAtrasadas > 0));
    } else if(valPension === 'NO'){
      arr = arr.filter(ch => (ch.pagoPension && ch.pensionesAtrasadas === 0));
    }
    const tbody = document.getElementById('tbodyMatriculas');
    tbody.innerHTML = '';
    arr.forEach(ch => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = `${ch.lastname} ${ch.name}`;
      row.insertCell(1).textContent = getVariantName(ch.variantId) || '';
      const cellF = row.insertCell(2);
      const btnF = document.createElement('button');
      btnF.className = 'ficha-btn';
      btnF.style.fontWeight = '600';
      btnF.style.borderRadius = '8px';
      btnF.style.backgroundColor = ch.fichaCompleta ? '#3BB273' : '#E74C3C';
      btnF.style.color = '#fff';
      btnF.textContent = 'Ficha Informativa';
      btnF.onclick = () => openFicha(ch);
      cellF.appendChild(btnF);
      const cellP = row.insertCell(3);
      const btnP = document.createElement('button');
      btnP.className = 'pension-btn';
      btnP.style.fontWeight = '600';
      btnP.style.borderRadius = '8px';
      btnP.style.color = '#fff';
      btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
      btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
      btnP.onclick = () => {
        ch.pagoPension = !ch.pagoPension;
        btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
        btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
        saveToFirebaseServices();
      };
      cellP.appendChild(btnP);
      const cellA = row.insertCell(4);
      const inputA = document.createElement('input');
      inputA.type = 'number';
      inputA.style.width = '60px';
      inputA.value = ch.pensionesAtrasadas || 0;
      inputA.onchange = () => {
        ch.pensionesAtrasadas = parseInt(inputA.value) || 0;
        saveToFirebaseServices();
      };
      cellA.appendChild(inputA);
    });
  }

  /**************************************************************
   * EXPOSE FUNCTIONS TO GLOBAL (after DOMContentLoaded)
   **************************************************************/
  document.addEventListener('DOMContentLoaded', () => {
    window.goToMacros = goToMacros;
    window.goToServices = goToServices;
    window.goToMatriculas = goToMatriculas;
    window.goBack = goBack;
    window.goBackFicha = goBackFicha;
    window.openTabMacros = openTabMacros;
    window.crearMacro = crearMacro;
    window.agregarOguardarNino = agregarOguardarNino;
    window.generarTxt = generarTxt;
    window.guardarYVolver = guardarYVolver;
    window.openTabServices = openTabServices;
    window.crearService = crearService;
    window.agregarOguardarVariante = agregarOguardarVariante;
    window.doneVariants = doneVariants;
    window.agregarOguardarChild = agregarOguardarChild;
    window.doneChildren = doneChildren;
    window.filtrarMatriculas = filtrarMatriculas;
    window.initMatriculas = initMatriculas;
    window.renderMatriculasList = renderMatriculasList;
  });
</script>
</body>
</html>
