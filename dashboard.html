<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Men√∫ Principal</title>
  <!-- Fuente Poppins -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Chart.js (para gr√°ficos en el men√∫ de Finanzas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* =================== ESTILOS GENERALES =================== */
#logoutContainer {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 9999;
}

#logoutContainer button {
  background-color: #f1c40f;
  color: #1a2e55;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: background-color 0.2s ease;
}

#logoutContainer button:hover {
  box-shadow: 0 4px 7px rgba(0, 0, 0, 0.2);
}
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #e5efff;
      min-height: 100vh;
    }
    .hidden { display: none !important; }
    .active { display: block !important; }



    /* =================== LANDING PAGE =================== */
    #landingPage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #landingPage h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: #1a2e55;
    }
    .landing-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .landing-buttons button {
      background-color: #f1c40f;
      color: #1a2e55;
      border: none;
      border-radius: 6px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    .landing-buttons button:hover {
      background-color: #1a2e55;
      color: #f1c40f;
    }

    /* =================== CONTENEDOR GENERAL =================== */
    .app-container {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding-bottom: 60px;
    }
    .activeContainer { display: block !important; }

    /* Bot√≥n Regresar */
    .bottom-left-btn {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background-color: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .bottom-left-btn:hover { background-color: #1a2e55; }

    /* =================== TABS =================== */
    .tabs {
      display: flex;
      background-color: #1a2e55;
      border-radius: 6px 6px 0 0;
    }
    .tab {
      flex: 1;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .tab:hover { background-color: #4a90e2; }
    .tab.activeTab { background-color: #4a90e2; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.activeTabContent { display: block; }


    /* =================== ESTILOS MACROS =================== */
    #macrosContainer .macros-list {
      display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;
    }
    #macrosContainer .macro-item {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    #macrosContainer .macro-item button {
      background: none; border: none; cursor: pointer; color: #4a90e2; font-weight: 600; margin-left: 10px;
    }
    #macrosContainer .macro-item button:hover { color: #1a2e55; }
    #macrosContainer .create-macro {
      display: flex; gap: 0.5rem; margin-top: 1rem; align-items: center;
    }
    #macrosContainer .create-macro input {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px;
      flex: 1; max-width: 300px;
    }
    #macrosContainer .create-macro button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #macrosContainer .create-macro button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    #macrosContainer .register-children-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    #macrosContainer .macro-title {
      font-size: 1.1rem; font-weight: 600; color: #4a90e2;
    }
    #macrosContainer .form-section {
      display: flex; flex-direction: column; max-width: 400px; gap: 0.5rem; margin-bottom: 1rem;
    }
    #macrosContainer .form-section label { font-weight: 600; }
    #macrosContainer .form-section input { border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; max-width: 220px; }
    #macrosContainer .child-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #macrosContainer .child-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #macrosContainer .child-table th,
    #macrosContainer .child-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    #macrosContainer .actions {
      margin-top: 1rem; display: flex; gap: 1rem;
    }
    #macrosContainer .actions button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #macrosContainer .actions button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }

    /* =================== ESTILOS SERVICES =================== */
    #servicesContainer .services-list {
      display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;
    }
    #servicesContainer .service-item {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    #servicesContainer .service-item button {
      background: none; border: none; cursor: pointer; color: #4a90e2; font-weight: 600; margin-left: 10px;
    }
    #servicesContainer .service-item button:hover { color: #1a2e55; }
    #servicesContainer .create-service {
      display: flex; gap: 0.5rem; margin-top: 1rem; align-items: center;
    }
    #servicesContainer .create-service input {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px;
      flex: 1; max-width: 300px;
    }
    #servicesContainer .create-service button {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; cursor: pointer;
    }
    #servicesContainer .create-service button:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    #servicesContainer .variants-form {
      display: flex; flex-direction: column; max-width: 400px; gap: 0.5rem; margin-top: 1rem;
    }
    #servicesContainer .days-container {
      display: flex; gap: 6px; margin: 6px 0;
    }
    .day-btn {
      background-color: #4a90e2; color: white; border: none; border-radius: 6px;
      padding: 6px 12px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
    }
    .day-btn.selected {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .variants-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #servicesContainer .variants-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .variants-table th, 
    #servicesContainer .variants-table td {
      border: 1px solid #ddd; padding: 8px;
    }
    #servicesContainer .children-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    #servicesContainer .children-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #servicesContainer .children-table th,
    #servicesContainer .children-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }

    /* =================== ESTILOS MATR√çCULAS =================== */
    #matriculasContainer .tabs-bar {
      background-color: #1a2e55;
      border-radius: 6px 6px 0 0;
      color: #fff;
      padding: 14px;
      font-weight: 600;
      font-size: 1rem;
    }
    #matriculasContainer .filter-section {
      margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;
    }
    #matriculasContainer .matriculas-list-table {
      width: 100%; border-collapse: collapse;
    }
    #matriculasContainer .matriculas-list-table thead {
      background-color: #f1c40f; color: #1a2e55;
    }
    #matriculasContainer .matriculas-list-table th,
    #matriculasContainer .matriculas-list-table td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    /* Ficha / Pensiones */
    .ficha-btn, .pension-btn {
      border: none;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 10px;
      outline: none;
    }


    /* =================== FICHA INFORMATIVA =================== */
    #fichaInformativaPanel {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding: 20px;
      padding-bottom: 60px; 
    }
    #fichaInformativaPanel h2 {
      margin-bottom: 1rem;
    }
    #fichaInformativaPanel .section-title {
      font-weight: 600; font-size: 1.1rem; margin-top: 1rem; color: #1a2e55;
    }
    .form-field {
      margin-bottom: 8px; display: flex; flex-direction: column; max-width: 400px;
    }
    .form-field label {
      font-weight: 600; margin-bottom: 2px;
    }
    .form-field input[type='text'],
    .form-field input[type='number'],
    .form-field textarea {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; max-width: 350px;
    }
    .form-field select, .form-field input[type='date'] {
      border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; max-width: 200px;
    }
    .finish-btn {
      background-color: #f1c40f; color: #1a2e55; border: none; border-radius: 6px; 
      padding: 8px 12px; font-weight: 600; cursor: pointer; margin-top: 1rem;
    }
    .finish-btn:hover {
      background-color: #1a2e55; color: #f1c40f;
    }
    .subsection {
      border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-top: 10px; 
    }
    .subsection h4 {
      margin-bottom: 5px;
    }
    .edit-section-btn {
      background: #4a90e2; color: #fff; border: none; border-radius: 6px; padding: 5px 8px; font-weight: 600; margin-left: 10px; cursor: pointer;
    }
    .edit-section-btn:hover {
      background-color: #1a2e55;
    }

    /* =================== ESTILOS ADMIN FINANZAS =================== */
    /* Contenedor para Finanzas */
    #finanzasContainer {
      display: none;
      background-color: #fff;
      width: 85%;
      max-width: 1100px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px auto;
      position: relative;
      padding-bottom: 60px;
    }
    /* Fin de pesta√±as: se reutiliza la clase .tabs, .tab y .tab-content */

    /* Selector de mes (dropdown) en finanzas */
    .finanzas-header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 20px;
      background-color: #f9f9f9;
    }
    .finanzas-header label {
      margin-right: 10px;
      font-weight: 600;
      color: #1a2e55;
    }
    .finanzas-header select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    /* Tarjetas (cajas) para Total Mensual */
    .finanzas-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    .finanzas-card {
      background-color: #f1c40f;
      color: #1a2e55;
      border-radius: 6px;
      padding: 15px;
      flex: 1 1 calc(33.333% - 20px);
      text-align: center;
      min-width: 250px;
    }
    .finanzas-card h3 {
      margin: 0;
      font-size: 1.2rem;
    }
    .finanzas-card p {
      margin: 5px 0 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    /* Indicador de porcentaje */
    .finanzas-indicador {
      margin-top: 20px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }
    /* Formularios y tablas en Egresos e Ingresos */
    .finanzas-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .finanzas-form input, .finanzas-form select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      flex: 1;
      min-width: 150px;
    }
    .finanzas-form button {
      background-color: #f1c40f;
      color: #1a2e55;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .finanzas-form button:hover {
      background-color: #1a2e55;
      color: #f1c40f;
    }
    .finanzas-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .finanzas-table th, .finanzas-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .finanzas-table thead {
      background-color: #f1c40f;
      color: #1a2e55;
    }
    /* Placeholder para gr√°ficos */
    .chart-container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px;
    }
  </style>
</head>
<body>
  <div id="logoutContainer" style="position:absolute; top:15px; right:15px;">
    <button onclick="logout()" style="background-color:#f1c40f; border:none; border-radius:6px; padding:8px; font-weight:600; cursor:pointer;">
      Cerrar Sesi√≥n
    </button>
  </div>
<!-- =================== LANDING PAGE =================== -->
<div id="landingPage">
  <h1>Bienvenid@, selecciona qu√© deseas administrar:</h1>
  <div class="landing-buttons">
    <!-- Agregamos id a cada bot√≥n -->
    <button id="btnMacros" onclick="goToMacros()">Administrador de Macros</button>
    <button id="btnServices" onclick="goToServices()">Administrador de Servicios</button>
    <button id="btnMatriculas" onclick="goToMatriculas()">Administrador de Matr√≠culas</button>
    <button id="btnFinanzas" onclick="goToFinanzas()">Administrador de Finanzas</button>
    <button id="btnUsers" onclick="goToUsers()">Administrador de Usuarios</button>
  </div>
</div>

<!-- =================== CONTENEDOR MACROS =================== -->
<div class="app-container" id="macrosContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabMacros" onclick="openTabMacros('Macros')">Administrador de Macros</div>
    <div class="tab" id="tabNinos" style="display:none;">Registrar Ni√±os</div>
  </div>
  <div class="tab-content activeTabContent" id="contentMacros">
    <h2>Administrador de Macros</h2>
    <p>Aqu√≠ puedes ver todas las macros, crear nuevas o gestionarlas.</p>
    <div class="macros-list" id="macrosList"></div>
    <div class="create-macro">
      <input type="text" id="tituloMacro" placeholder="T√≠tulo de la nueva macro..." />
      <button onclick="crearMacro()">Crear Macro</button>
    </div>
  </div>
  <div class="tab-content" id="contentNinos">
    <div class="register-children-header">
      <h2>Registrar Ni√±os</h2>
      <span class="macro-title" id="currentMacroTitle"></span>
    </div>
    <div class="form-section">
      <label>Nombre:</label>
      <input type="text" id="nombre" placeholder="Ej: ALESSA" />
      <label>Apellidos:</label>
      <input type="text" id="apellidos" placeholder="Ej: AGURTO HO" />
      <label>C√≥digo:</label>
      <div style="display:flex; align-items:center; gap:5px;">
        <span id="codigoFijo"></span>
        <input type="text" id="codigoRestante" placeholder="01" />
      </div>
      <label>Fecha:</label>
      <input type="date" id="fechaInscripcion" />
      <label>Importe:</label>
      <input type="number" id="importe" placeholder="Ej: 50.00" step="0.01" />
      <button onclick="agregarOguardarNino()" id="btnNinoPrincipal">Agregar Ni√±o</button>
    </div>
    <table class="child-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Apellidos</th>
          <th>C√≥digo</th>
          <th>Fecha</th>
          <th>Importe</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyNinos"></tbody>
    </table>
    <div class="actions">
      <button onclick="generarTxt()">Generar TXT</button>
      <button onclick="guardarYVolver()">Guardar y Volver</button>
    </div>
  </div>
</div>

<!-- =================== CONTENEDOR SERVICES =================== -->
<div class="app-container" id="servicesContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabServicesMain" onclick="openTabServices('ServicesMain')">Administrador de Servicios</div>
    <div class="tab" id="tabServicesVariants" style="display:none;">Creador de Variantes</div>
    <div class="tab" id="tabServicesChildren" style="display:none;">Administrar Ni√±os</div>
  </div>
  <div class="tab-content activeTabContent" id="contentServicesMain">
    <h2>Administrador de Servicios</h2>
    <p>Aqu√≠ puedes ver todos los servicios, crear nuevos o gestionarlos.</p>
    <div class="services-list" id="servicesList"></div>
    <div class="create-service">
      <input type="text" id="tituloService" placeholder="T√≠tulo del nuevo servicio..." />
      <button onclick="crearService()">Crear Servicio</button>
    </div>
  </div>
  <div class="tab-content" id="contentServicesVariants">
    <h2>Creador de Variantes</h2>
    <p id="currentServiceTitle" style="font-weight: 600; color:#4a90e2;"></p>
    <div class="variants-form">
      <label>Nombre de la variante:</label>
      <input type="text" id="variantName" placeholder="Ej: Ejemplo 1" />
      <label>Precio:</label>
      <input type="number" id="variantPrice" placeholder="Ej: 100.00" step="0.01" />
      <label>D√≠as de la semana:</label>
      <div class="days-container" id="daysContainer"></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div>
          <label>Hora de inicio:</label><br/>
          <input type="time" id="variantStart" />
        </div>
        <div>
          <label>Hora de t√©rmino:</label><br/>
          <input type="time" id="variantEnd" />
        </div>
      </div>
      <button style="margin-top:10px;" onclick="agregarOguardarVariante()" id="btnVariantPrincipal">Agregar Variante</button>
    </div>
    <table class="variants-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>D√≠as</th>
          <th>Precio</th>
          <th>Horario</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyVariants"></tbody>
    </table>
    <div class="actions">
      <button onclick="doneVariants()">Listo</button>
    </div>
  </div>
<div class="tab-content" id="contentServicesChildren">
  <h2>Administrar Ni√±os</h2>
  <p id="currentServiceTitleChild" style="font-weight:600; color:#4a90e2;"></p>
  <div class="form-section">
    <label>Nombre:</label>
    <input type="text" id="childName" placeholder="Ej: JUAN" />
    <label>Apellidos:</label>
    <input type="text" id="childLastname" placeholder="Ej: PEREZ" />
    <label>Fecha Ingreso:</label>
    <input type="date" id="childDate" />
    <label id="labelVariantChild">Variante:</label>
    <select id="childVariantSelect">
      <!-- Llenado din√°mico -->
    </select>
    <button onclick="agregarOguardarChild()" id="btnChildPrincipal">Agregar Ni√±o</button>
  </div>
  <table class="children-table">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Apellidos</th>
        <th>Fecha</th>
        <th>Variante</th>
        <!-- Aqu√≠ agregamos las nuevas columnas: -->
        <th>Pag√≥ Pensi√≥n</th>
        <th>Pensiones Atrasadas</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbodyChildren"></tbody>
  </table>
  <div class="actions">
    <button onclick="doneChildren()">Listo</button>
  </div>
</div>

</div>

<!-- =================== CONTENEDOR MATR√çCULAS =================== -->
<div class="app-container" id="matriculasContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs-bar">Administrador de Matr√≠culas</div>
  <div class="filter-section">
    <label>A√±o:</label>
    <select id="filtroAno">
      <option value="">(Todos)</option>
      <option value="1">1 a√±o</option>
      <option value="2">2 a√±os</option>
      <option value="3">3 a√±os</option>
      <option value="4">4 a√±os</option>
      <option value="5">5 a√±os</option>
    </select>
    <label>Adeudan pensi√≥n:</label>
    <select id="filtroPension">
      <option value="">(Todos)</option>
      <option value="SI">S√≠</option>
      <option value="NO">No</option>
    </select>
    <button onclick="filtrarMatriculas()">Aplicar Filtro</button>
  </div>
  <table class="matriculas-list-table">
    <thead>
      <tr>
        <th>Apellidos y Nombres</th>
        <th>A√±o</th>
        <th>Ficha Informativa</th>
        <th>Pag√≥ Pensi√≥n</th>
        <th>Pensiones Atrasadas</th>
      </tr>
    </thead>
    <tbody id="tbodyMatriculas"></tbody>
  </table>
</div>

<!-- =================== CONTENEDOR FINANZAS =================== -->
<div class="app-container" id="finanzasContainer">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabFinanzasTotal" onclick="openTabFinanzas('Total')">Total Mensual</div>
    <div class="tab" id="tabFinanzasEgresos" onclick="openTabFinanzas('Egresos')">Egresos</div>
    <div class="tab" id="tabFinanzasIngresos" onclick="openTabFinanzas('Ingresos')">Ingresos</div>
  </div>
  <!-- Encabezado con selector de mes -->
  <div class="finanzas-header">
    <label for="finanzasMes">Mes:</label>
    <select id="finanzasMes" onchange="cambiarMesFinanzas()">
      <!-- Opciones generadas din√°micamente -->
    </select>
  </div>
  <!-- Contenido de cada subpanel -->
  <div class="tab-content activeTabContent" id="contentFinanzasTotal">
    <h2>Administrador de Finanzas - Total Mensual</h2>
    <!-- Secci√≥n superior con gr√°ficos y total central (placeholders) -->
  <div style="display: flex; justify-content: center; align-items: center; height: 10%;">
      <div class="chart-container">
        <canvas id="chartFinanzasCircular"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartFinanzasLinealTotal"></canvas>
      </div>
    </div>
    <!-- Tarjetas de indicadores en 2 filas (m√°ximo 3 por fila) -->
    <div class="finanzas-cards">
      <div class="finanzas-card">
        <h3>Egresos Variables</h3>
        <p id="egresosVariables">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Egresos Fijos</h3>
        <p id="egresosFijos">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Egresos Totales</h3>
        <p id="egresosTotales">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Brutos Esperados</h3>
        <p id="ingresosBrutosEsperados">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Netos Esperados</h3>
        <p id="ingresosNetosEsperados">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Brutos Totales</h3>
        <p id="ingresosBrutosTotales">S/ 0.00</p>
      </div>
      <div class="finanzas-card">
        <h3>Ingresos Netos Totales</h3>
        <p id="ingresosNetosTotales">S/ 0.00</p>
      </div>
    </div>
    <!-- Indicador de variaci√≥n respecto al mes anterior -->
    <div class="finanzas-indicador" id="indicadorVariacion">
      <!-- Se mostrar√° algo como: +10% o -5% -->
      Variaci√≥n: +0%
    </div>
  </div>
  <div class="tab-content" id="contentFinanzasEgresos">
    <h2>Administrador de Finanzas - Egresos</h2>
    <!-- Gr√°ficos para egresos -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
      <div class="chart-container">
        <canvas id="chartEgresosLineal"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartEgresosCircular"></canvas>
      </div>
    </div>

<div class="finanzas-form" style="margin-bottom:10px;">

  <!-- Filtro de Egresos -->
  <label>Filtrar Tipo:</label>
  <select id="filtroEgresosTipo"></select>

  <label>Filtrar Subtipo:</label>
  <select id="filtroEgresosSubtipo"></select>

  <button onclick="filtrarEgresos()">Aplicar</button>
</div>

    <!-- Formulario para agregar egresos -->
    <div class="finanzas-form">
      <input type="text" id="egresoNombre" placeholder="Nombre del egreso" />
      <select id="egresoTipo">
        <option value="">-- Selecciona Tipo --</option>
        <option value="Fijo">Fijo</option>
        <option value="Variable">Variable</option>
      </select>
      <select id="egresoSubtipo">
        <!-- Opciones de subtipos, se pueden editar -->
        <option value="">-- Selecciona Subtipo --</option>
      </select>
      <button type="button" onclick="agregarNuevoSubtipo()">+</button>
      <button type="button" onclick="eliminarSubtipo()">-</button>
      <input type="number" id="egresoCantidad" placeholder="Cantidad" step="0.01" />
      <input type="number" id="egresoDescuento" placeholder="Descuento" step="0.01" />
      <button onclick="agregarEgreso()">Agregar</button>
    </div>
    <!-- Tabla de egresos -->
    <table class="finanzas-table" id="tablaEgresos">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Subtipo</th>
          <th>Cantidad</th>
          <th>Descuento</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filas generadas din√°micamente -->
      </tbody>
    </table>
  </div>
<div class="tab-content" id="contentFinanzasIngresos">
  <h2>Administrador de Finanzas - Ingresos</h2>
<!-- NUEVA SECCI√ìN DE FILTROS PARA INGRESOS -->
    <!-- Gr√°ficos para ingresos -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
      <div class="chart-container">
        <canvas id="chartIngresosLineal"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartIngresosCircular"></canvas>
      </div>
    </div>
  <div class="finanzas-form" style="margin-bottom:10px;">
    <label>Filtrar Tipo:</label>
    <select id="filtroIngresosTipo"></select>

    <label>Filtrar Subtipo:</label>
    <select id="filtroIngresosSubtipo"></select>

    <button onclick="filtrarIngresos()">Aplicar</button>
  </div>
  <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
    <div class="finanzas-card">
      <h3>Total Bruto Esperado</h3>
      <p id="ingresosBruto">S/ 0.00</p> <!-- Cambiamos id e texto -->
    </div>
    <div class="finanzas-card">
      <h3>Total Neto</h3>
      <p id="ingresosNetos">S/ 0.00</p>
    </div>
  </div>
    <!-- Tabla de ingresos (solo visualizaci√≥n) -->
    <table class="finanzas-table" id="tablaIngresos">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Subtipo</th>
          <th>Total</th>
          <th>Pag√≥ Mensualidad</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filas generadas din√°micamente -->
      </tbody>
    </table>

  </div>
</div>
<!-- =================== CONTENEDOR USERS =================== -->
<div class="app-container" id="usersContainer" style="display:none;">
  <button class="bottom-left-btn" onclick="goBack()">Regresar</button>
  <div class="tabs">
    <div class="tab activeTab" id="tabUsersMain" onclick="openTabUsers('UsersMain')">Usuarios</div>
    <!-- Ocultamos la pesta√±a de Editar Usuario por defecto -->
    <div class="tab" id="tabEditUser" style="display:none;" onclick="openTabUsers('EditUser')">Editar Usuario</div>
  </div>

  <!-- Contenido pesta√±a principal: lista y creaci√≥n de usuarios -->
  <div class="tab-content activeTabContent" id="contentUsersMain">
    <h2>Administrador de Usuarios</h2>
    <div id="usersList" style="margin-top:10px;"></div>

    <h3 style="margin-top:20px;">Crear nuevo usuario</h3>
    <div style="display:flex; gap:10px; align-items:center;">
      <input type="text" id="newUserName" placeholder="Usuario" />
      <input type="password" id="newUserPass" placeholder="Contrase√±a" />
      <button onclick="crearUser()">Crear</button>
    </div>
  </div>

  <!-- Contenido pesta√±a para editar un usuario -->
  <div class="tab-content" id="contentEditUser">
    <h2 id="currentUserTitle"></h2>
    <p>Define los permisos para el usuario</p>
    <div style="display:flex; flex-direction:column; gap:6px;">
      <label><input type="checkbox" id="permMacros"/> Macros</label>
      <label><input type="checkbox" id="permMacrosNinos"/> Macros - Ni√±os</label>
      <label><input type="checkbox" id="permServices"/> Servicios</label>
      <label><input type="checkbox" id="permServicesVariants"/> Servicios - Variantes</label>
      <label><input type="checkbox" id="permServicesChildren"/> Servicios - Ni√±os</label>
      <label><input type="checkbox" id="permMatriculas"/> Matr√≠culas</label>
      <label><input type="checkbox" id="permFinanzas"/> Finanzas</label>
      <label style="margin-left:20px;"><input type="checkbox" id="permFinanzasTotal"/> - Total</label>
      <label style="margin-left:20px;"><input type="checkbox" id="permFinanzasEgresos"/> - Egresos</label>
      <label style="margin-left:20px;"><input type="checkbox" id="permFinanzasIngresos"/> - Ingresos</label>
    </div>
    <button style="margin-top:10px;" onclick="guardarPermisosUsuario()">Guardar Permisos</button>
  </div>
</div>

<!-- =================== FICHA INFORMATIVA =================== -->
<div id="fichaInformativaPanel">
  <button class="bottom-left-btn" onclick="goBackFicha()">Regresar</button>
  <h2>Ficha Informativa</h2>
  <div id="fichaContent" style="margin-bottom:30px;"></div>
</div>

<!-- Coloca esto al inicio del bloque de <script> en tu dashboard -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    getDocs,
    deleteDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCPSya0kEAydB8_WxEbei56KF36ZmJ1n7I",
    authDomain: "definitivo-4841f.firebaseapp.com",
    projectId: "definitivo-4841f",
    storageBucket: "definitivo-4841f.firebasestorage.app",
    messagingSenderId: "92662019661",
    appId: "1:92662019661:web:de3ccc7b6b5ae5e4134e04"
  };

  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  // Recuperar usuario y permisos del localStorage
let currentUser = {
  username: localStorage.getItem("usuario"),
  permisos: JSON.parse(localStorage.getItem("permisos") || "{}")
};

if (!currentUser.username) {
  window.location.href = "login.html";
} else {
  // Ya tengo currentUser, as√≠ que aplico permisos:
  applyPermissionsToMenus();
}

  /*************************************************************
   * Global Variables and Screen Navigation
   *************************************************************/
  let screenStack = ["landing"];
  let users = [];
  let editingUsername = null;
  let subtiposEgresos = ["Planilla", "Agua", "Luz", "Internet"]; 

async function goToMacros() {
  // Verificar permiso (si lo deseas)
  if (!currentUser || !currentUser.permisos.macros) {
    alert("No tienes permiso para acceder a Macros.");
    return;
  }
  // Ya no necesitamos ocultar el loginPage, porque no existe en el dashboard
  document.getElementById('landingPage').classList.add('hidden');
  document.getElementById('macrosContainer').classList.add('activeContainer');
  
  // Carga de datos y dem√°s
  await initMacros();
}

  async function loadFinanzasData() {
  try {
    const docRef = doc(db, "data", "finanzas");
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      finanzasData.egresos = data.egresos || [];
      // Si tienes almacenados los subtipos tambi√©n:
      subtiposEgresos = data.subtipos || subtiposEgresos;
    }
  } catch (error) {
    console.error("Error loading finanzas data:", error);
  }
}

async function saveFinanzasData() {
  try {
    const docRef = doc(db, "data", "finanzas");
    const data = {
      egresos: finanzasData.egresos,
      subtipos: subtiposEgresos
    };
    await setDoc(docRef, data, { merge: true });
    console.log("Finanzas data saved to Firebase");
  } catch (error) {
    console.error("Error saving finanzas data:", error);
  }
}

async function goToServices(){
  if(!currentUser || !currentUser.permisos.services){
    alert("No tienes permiso para acceder a Servicios.");
    return;
  }
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('servicesContainer').classList.add('activeContainer');
    screenStack.push("services");
    await initServices();
  }
async function goToMatriculas(){
  if(!currentUser || !currentUser.permisos.matriculas){
    alert("No tienes permiso para acceder a Matr√≠culas.");
    return;
  }
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('matriculasContainer').classList.add('activeContainer');
    screenStack.push("matriculas");
    await initMatriculas();
  }
async function goToFinanzas() {
  if (!currentUser || !currentUser.permisos.finanzas) {
    alert("No tienes permiso para acceder a Finanzas.");
    return;
  }
  document.getElementById('landingPage').classList.add('hidden');
  document.getElementById('finanzasContainer').classList.add('activeContainer');
  screenStack.push("finanzas");

  await loadFromFirebaseServices();
  await initFinanzas();

  // Suscripci√≥n en tiempo real
  initFinanzasRealTime();
}
function goBack() {
  screenStack.pop(); 
  // Saca la √∫ltima pantalla de la pila

  // Primero, ocultar/limpiar todos los contenedores
  document.getElementById('landingPage').classList.add('hidden');
  document.getElementById('macrosContainer').classList.remove('activeContainer');
  document.getElementById('servicesContainer').classList.remove('activeContainer');
  document.getElementById('matriculasContainer').classList.remove('activeContainer');
  document.getElementById('finanzasContainer').classList.remove('activeContainer');
  // IMPORTANTE: oculta tambi√©n el de Usuarios
  document.getElementById('usersContainer').style.display = 'none'; 
  // O document.getElementById('usersContainer').classList.remove('activeContainer');

  // Seg√∫n la √∫ltima pantalla en la pila, la muestras
  const current = screenStack[screenStack.length - 1] || "landing";
  if (current === "landing") {
    document.getElementById('landingPage').classList.remove('hidden');
  } else if (current === "macros") {
    document.getElementById('macrosContainer').classList.add('activeContainer');
  } else if (current === "services") {
    document.getElementById('servicesContainer').classList.add('activeContainer');
  } else if (current === "matriculas") {
    document.getElementById('matriculasContainer').classList.add('activeContainer');
  } else if (current === "finanzas") {
    document.getElementById('finanzasContainer').classList.add('activeContainer');
  } else if (current === "users") {
    document.getElementById('usersContainer').style.display = 'block';
  }
}


  function goBackFicha(){
    screenStack.pop();
    document.getElementById('fichaInformativaPanel').style.display = 'none';
    const curr = screenStack[screenStack.length - 1];
    if (curr === "matriculas") {
      document.getElementById('matriculasContainer').classList.add('activeContainer');
      renderMatriculasList();
    } else {
      goBack();
    }
  }
function calcularIngresosBrutoEsperado(mesSeleccionado) {
  let total = 0;
  services.forEach(serv => {
    serv.children.forEach(child => {
      if(child.mesRegistro === mesSeleccionado) {
        total += child.total || 0;
      }
    });
  });
  return total;
}
function calcularIngresosNetoEsperado(mesSeleccionado) {
  const brutoEsperado = calcularIngresosBrutoEsperado(mesSeleccionado);
  const totalEgresos = calcularEgresosTotales(
    finanzasData.egresos.filter(e => `${e.anio}-${String(e.mes).padStart(2, '0')}` === mesSeleccionado)
  );
  return brutoEsperado - totalEgresos;
}
function calcularIngresosBrutosTotales(mesSeleccionado) {
  let total = 0;
  services.forEach(serv => {
    serv.children.forEach(child => {
      if(child.mesRegistro === mesSeleccionado && child.pagoPension) {
        total += child.total || 0;
      }
    });
  });
  return total;
}

function calcularIngresosNetosTotales(mesSeleccionado) {
  const brutoTotales = calcularIngresosBrutosTotales(mesSeleccionado);
  const totalEgresos = calcularEgresosTotales(
    finanzasData.egresos.filter(e => `${e.anio}-${String(e.mes).padStart(2, '0')}` === mesSeleccionado)
  );
  return brutoTotales - totalEgresos;
}
async function attemptLogin(){
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;

  if(!username || !password){
    alert("Completa usuario y contrase√±a");
    return;
  }
  try {
    // Buscar doc en la colecci√≥n "users"
    const docRef = doc(db, "users", username);
    const docSnap = await getDoc(docRef);
    if(!docSnap.exists()){
      alert("Usuario no encontrado en la base de datos.");
      return;
    }
    const userData = docSnap.data();
    if(userData.password !== password){
      alert("Contrase√±a incorrecta.");
      return;
    }

    // Si coincide, login exitoso
    currentUser = {
      username: userData.username,
      permisos: userData.permisos || {}
    };

    // Oculta login, muestra landing
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('landingPage').classList.remove('hidden');

    // Muestra bot√≥n de logout
    document.getElementById('logoutContainer').style.display = 'block';

    // Aplica permisos en la interfaz
    applyPermissionsToMenus();

  } catch (err) {
    console.error("Error en login:", err);
    alert("Error al iniciar sesi√≥n.");
  }
}

function logout(){
  // Limpiar la variable actual y el almacenamiento local
  currentUser = null;
  localStorage.removeItem("usuario");
  localStorage.removeItem("permisos");

  // Ocultar todos los contenedores de la app
  document.getElementById('landingPage').classList.add('hidden');
  document.getElementById('macrosContainer').classList.remove('activeContainer');
  document.getElementById('servicesContainer').classList.remove('activeContainer');
  document.getElementById('matriculasContainer').classList.remove('activeContainer');
  document.getElementById('finanzasContainer').classList.remove('activeContainer');
  document.getElementById('usersContainer').style.display = 'none';

  // Ocultar el contenedor de logout
  document.getElementById('logoutContainer').style.display = 'none';

  // Redirigir al login
  window.location.href = "login.html";
}

function applyPermissionsToMenus() {
  // Si no hay usuario actual, no hacemos nada
  if (!currentUser) return;

  // Permisos del usuario actual
  const p = currentUser.permisos || {};

  // Muestra u oculta los botones del men√∫ principal
  // (Son los mismos botones que definimos con id en el HTML)
  document.getElementById('btnMacros').style.display     = p.macros      ? 'inline-block' : 'none';
  document.getElementById('btnServices').style.display   = p.services    ? 'inline-block' : 'none';
  document.getElementById('btnMatriculas').style.display = p.matriculas  ? 'inline-block' : 'none';
  document.getElementById('btnFinanzas').style.display   = p.finanzas    ? 'inline-block' : 'none';
  
  // Por ejemplo, "Administrador de Usuarios" solo lo ve un usuario espec√≠fico
  document.getElementById('btnUsers').style.display = (currentUser.username === "renatozepi") 
                                                      ? 'inline-block'
                                                      : 'none';

  // Si adem√°s quieres ocultar pesta√±as internas, puedes hacer algo similar:
  // Pesta√±a "Registrar Ni√±os" en Macros
  const tabNinos = document.getElementById('tabNinos');
  if (tabNinos) {
    // Se muestra solo si el usuario tiene el permiso "macrosNinos"
    tabNinos.style.display = p.macrosNinos ? 'block' : 'none';
  }

  // Pesta√±as de Finanzas
  const tabFinTotal = document.getElementById('tabFinanzasTotal');
  const tabFinEgresos = document.getElementById('tabFinanzasEgresos');
  const tabFinIngresos = document.getElementById('tabFinanzasIngresos');

  if (tabFinTotal) {
    tabFinTotal.style.display = p.finanzasTotal ? 'block' : 'none';
  }
  if (tabFinEgresos) {
    tabFinEgresos.style.display = p.finanzasEgresos ? 'block' : 'none';
  }
  if (tabFinIngresos) {
    tabFinIngresos.style.display = p.finanzasIngresos ? 'block' : 'none';
  }

  // As√≠ puedes controlar cualquier otro elemento que requiera permisos espec√≠ficos.
}



  /****************************************************
   * MACROS CODE (Con Firebase en lugar de localStorage)
   ****************************************************/
  let macros = [];
  let nextMacroId = 1;
  let nextAlumnoId = 1;
  let editingMacroId = null;
  let editingAlumnoId = null;
  let generateCount = 0;
  const anioActual = new Date().getFullYear();
  const anioDosDig = anioActual.toString().slice(-2);
  const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];

  async function loadFromFirebaseMacros(){
    try {
      const docRef = doc(db, "data", "macrosAlumnos");
      const docSnap = await getDoc(docRef);
      if(docSnap.exists()){
        const parsed = docSnap.data();
        macros = parsed.macros || [];
        nextMacroId = parsed.nextMacroId || 1;
        nextAlumnoId = parsed.nextAlumnoId || 1;
      } else {
        macros = [];
        nextMacroId = 1;
        nextAlumnoId = 1;
      }
    } catch(error){
      console.error("Error loading macros from Firebase:", error);
    }
  }
  async function saveToFirebaseMacros(){
    try {
      const docRef = doc(db, "data", "macrosAlumnos");
      const obj = { macros, nextMacroId, nextAlumnoId };
      await setDoc(docRef, obj, { merge: true });
      console.log("Macros data saved to Firebase");
    } catch(error){
      console.error("Error saving macros to Firebase:", error);
    }
  }
  async function initMacros() {
    await loadFromFirebaseMacros();
    mostrarMacros();
  }
  function mostrarMacros(){
    const container = document.getElementById('macrosList');
    container.innerHTML = '';
    macros.forEach(m => {
      const div = document.createElement('div');
      div.className = 'macro-item';
      const leftSpan = document.createElement('span');
      leftSpan.textContent = `${m.titulo} (Alumnos: ${m.alumnos.length})`;
      const rightDiv = document.createElement('div');
      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.onclick = () => editarMacro(m.id);
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Eliminar';
      btnDel.onclick = () => eliminarMacro(m.id);
      rightDiv.appendChild(btnEdit);
      rightDiv.appendChild(btnDel);
      div.appendChild(leftSpan);
      div.appendChild(rightDiv);
      container.appendChild(div);
    });
  }
  function crearMacro(){
    const titulo = document.getElementById('tituloMacro').value.trim();
    if(!titulo){
      alert('Ingresa un t√≠tulo para la macro');
      return;
    }
    const nueva = { id: nextMacroId++, titulo, alumnos: [] };
    macros.push(nueva);
    document.getElementById('tituloMacro').value = '';
    mostrarMacros();
    saveToFirebaseMacros();
    editarMacro(nueva.id);
  }
  function editarMacro(macroId){
    editingMacroId = macroId;
    const mac = macros.find(m => m.id === macroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    openTabMacros('Ninos');
    document.getElementById('currentMacroTitle').textContent = mac.titulo;
    mostrarAlumnosEnTablaMacros(mac.alumnos);
  }
  function eliminarMacro(macroId){
    if(!confirm('¬øSeguro de eliminar esta macro?')) return;
    macros = macros.filter(m => m.id !== macroId);
    mostrarMacros();
    saveToFirebaseMacros();
  }
  function mostrarAlumnosEnTablaMacros(arr){
    const tbody = document.getElementById('tbodyNinos');
    tbody.innerHTML = '';
    arr.forEach(al => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = al.nombre;
      row.insertCell(1).textContent = al.apellidos;
      row.insertCell(2).textContent = `CJ${anioDosDig}${al.codigoRestante}`;
      row.insertCell(3).textContent = al.fechaInscripcion;
      row.insertCell(4).textContent = al.importe.toFixed(2);
      const accCell = row.insertCell(5);
      const btnE = document.createElement('button');
      btnE.textContent = '‚úé';
      btnE.onclick = () => editarNinoMacros(al.id);
      accCell.appendChild(btnE);
      const btnD = document.createElement('button');
      btnD.textContent = 'üóëÔ∏è';
      btnD.style.marginLeft = '5px';
      btnD.onclick = () => eliminarAlumnoMacros(al.id);
      accCell.appendChild(btnD);
    });
  }
  function agregarOguardarNino(){
    if(!editingMacroId){
      alert('No hay una macro seleccionada.');
      return;
    }
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    const nombre = document.getElementById('nombre').value.trim().toUpperCase();
    const apellidos = document.getElementById('apellidos').value.trim().toUpperCase();
    const codigoRestante = document.getElementById('codigoRestante').value.trim().toUpperCase();
    const fechaInscripcion = document.getElementById('fechaInscripcion').value;
    const importe = parseFloat(document.getElementById('importe').value);
    if(!nombre || !apellidos || !codigoRestante || !fechaInscripcion || isNaN(importe)){
      alert('Completa todos los campos');
      return;
    }
    if(editingAlumnoId === null){
      const nuevo = {
        id: nextAlumnoId++,
        nombre,
        apellidos,
        codigoRestante,
        fechaInscripcion,
        importe
      };
      mac.alumnos.push(nuevo);
    } else {
      const idx = mac.alumnos.findIndex(a => a.id === editingAlumnoId);
      if(idx >= 0){
        mac.alumnos[idx].nombre = nombre;
        mac.alumnos[idx].apellidos = apellidos;
        mac.alumnos[idx].codigoRestante = codigoRestante;
        mac.alumnos[idx].fechaInscripcion = fechaInscripcion;
        mac.alumnos[idx].importe = importe;
      }
      editingAlumnoId = null;
      document.getElementById('btnNinoPrincipal').textContent = 'Agregar Ni√±o';
    }
    document.getElementById('nombre').value = '';
    document.getElementById('apellidos').value = '';
    document.getElementById('codigoRestante').value = '';
    document.getElementById('fechaInscripcion').value = '';
    document.getElementById('importe').value = '';
    mostrarAlumnosEnTablaMacros(mac.alumnos);
    saveToFirebaseMacros();
  }
  function editarNinoMacros(alumnoId){
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac) return;
    const al = mac.alumnos.find(a => a.id === alumnoId);
    if(!al) return;
    editingAlumnoId = alumnoId;
    document.getElementById('nombre').value = al.nombre;
    document.getElementById('apellidos').value = al.apellidos;
    document.getElementById('codigoRestante').value = al.codigoRestante;
    document.getElementById('fechaInscripcion').value = al.fechaInscripcion;
    document.getElementById('importe').value = al.importe;
    document.getElementById('btnNinoPrincipal').textContent = 'Guardar Ni√±o';
  }
  function eliminarAlumnoMacros(alumnoId){
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac) return;
    mac.alumnos = mac.alumnos.filter(a => a.id !== alumnoId);
    mostrarAlumnosEnTablaMacros(mac.alumnos);
    saveToFirebaseMacros();
  }
  function guardarYVolver(){
    openTabMacros('Macros');
    mostrarMacros();
    saveToFirebaseMacros();
  }
  function generarTxt(){
    if(!editingMacroId){
      alert('No hay macro seleccionada.');
      return;
    }
    const mac = macros.find(m => m.id === editingMacroId);
    if(!mac){
      alert('Macro no encontrada');
      return;
    }
    generateCount++;
    const hoy = new Date();
    const fechaFact = hoy.getFullYear().toString() + String(hoy.getMonth()+1).padStart(2, '0') + String(hoy.getDate()).padStart(2, '0');
    const ruc = '00018176347';
    const moneda = 'PEN';
    const numeroClase = '000';
    const tipoActu = 'P';
    let cabecera = '01' + ruc + numeroClase + moneda + fechaFact + '001' + ' '.repeat(7) + tipoActu + ' '.repeat(322) + '\r\n';
    let contenido = cabecera;
    const anioSiguiente = hoy.getFullYear() + 1;
    const fechaBloqueo = `${anioSiguiente}0930`;
    let contadorRegistros = 0;
    let sumaMin = 0, sumaMax = 0;
    mac.alumnos.forEach(item => {
      const fechaObj = new Date(item.fechaInscripcion);
      const anio = fechaObj.getFullYear();
      const mesInicio = fechaObj.getMonth();
      const diaInscripcion = fechaObj.getDate();
      for(let m = mesInicio; m < 12; m++){
        const nombreCompleto = (item.apellidos + ' ' + item.nombre).substring(0,30).padEnd(30, ' ');
        const yy = anio.toString().slice(-2);
        const mesNombre = meses[m];
        let codigoConc = `0CJ${yy}${item.codigoRestante}${mesNombre}`.substring(0,40).padEnd(40, ' ');
        const mesStr = String(m+1).padStart(2, '0');
        const diaStr = String(diaInscripcion).padStart(2, '0');
        const fechaVenc = `${anio}${mesStr}${diaStr}`;
        const importeCentavos = Math.round(item.importe * 100);
        const importeStr = importeCentavos.toString().padStart(15, '0');
        sumaMin += importeCentavos;
        sumaMax += importeCentavos;
        let linea = '02' + nombreCompleto + codigoConc + ' '.repeat(8) + fechaVenc + fechaBloqueo + '0'.repeat(2)
          + importeStr + importeStr + '0'.repeat(180) + 'L000000000000000' + '\r\n';
        contenido += linea;
        contadorRegistros++;
      }
    });
    let linea03 = '03';
    linea03 += String(contadorRegistros).padStart(9, '0');
    linea03 += String(sumaMin).padStart(18, '0');
    linea03 += String(sumaMax).padStart(18, '0');
    linea03 += '0'.repeat(18);
    linea03 += ' '.repeat(295);
    contenido += linea03;
    const filename = `carga_bbva_${fechaFact}_${generateCount}.txt`;
    const blob = new Blob([contenido], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
function openTabMacros(tabName) {
  // 1) Validar permisos antes de desactivar nada
  if (tabName === 'Macros') {
    // Necesita permisos.macros
    if (!currentUser.permisos.macros) {
      alert("No tienes permiso para la pesta√±a principal de Macros.");
      return;
    }
  } else if (tabName === 'Ninos') {
    // Necesita permisos.macrosNinos
    if (!currentUser.permisos.macrosNinos) {
      alert("No tienes permiso para la pesta√±a 'Registrar Ni√±os'.");
      return;
    }
  }

  // 2) Si pas√≥ la validaci√≥n, quitamos las clases de todas las pesta√±as
  document.getElementById('contentMacros').classList.remove('activeTabContent');
  document.getElementById('contentNinos').classList.remove('activeTabContent');
  document.getElementById('tabMacros').classList.remove('activeTab');
  document.getElementById('tabNinos').classList.remove('activeTab');

  // 3) Activamos la pesta√±a solicitada
  if (tabName === 'Macros') {
    document.getElementById('contentMacros').classList.add('activeTabContent');
    document.getElementById('tabMacros').classList.add('activeTab');
  } else if (tabName === 'Ninos') {
    document.getElementById('contentNinos').classList.add('activeTabContent');
    document.getElementById('tabNinos').classList.add('activeTab');
  }
}

  /**************************************************************
   * ADMIN SERVICES
   **************************************************************/
  let services = [];
  let editingVariantId = null;
  let nextServiceId = 1;
  let nextVariantId = 1;
  let nextServiceChildId = 1;
  let serviceCheckDone = false; 
  let MATRICULA_ID = null;
  let editingServiceId = null;
  let editingServiceChildId = null;
  async function loadFromFirebaseServices(){
    try {
      const docRef = doc(db, "data", "servicesData");
      const docSnap = await getDoc(docRef);
      if(docSnap.exists()){
        const parsed = docSnap.data();
        services = parsed.services || [];
        nextServiceId = parsed.nextServiceId || 1;
        nextVariantId = parsed.nextVariantId || 1;
        nextServiceChildId = parsed.nextServiceChildId || 1;
      } else {
        services = [];
        nextServiceId = 1;
        nextVariantId = 1;
        nextServiceChildId = 1;
      }
    } catch(error){
      console.error("Error loading services from Firebase:", error);
    }
  }
  async function saveToFirebaseServices(){
    try {
      const docRef = doc(db, "data", "servicesData");
      const obj = { services, nextServiceId, nextVariantId, nextServiceChildId };
      await setDoc(docRef, obj, { merge: true });
      console.log("Services data saved to Firebase");
    } catch(error){
      console.error("Error saving services to Firebase:", error);
    }
  }
  async function initServices(){
    await loadFromFirebaseServices();
    ensureMatriculaService();
    showServicesList();
    setupDaysButtons();
  }
  function ensureMatriculaService(){
    if(serviceCheckDone) return;
    serviceCheckDone = true;
    let mat = services.find(s => s.title === 'Matr√≠cula');
    if(!mat){
      mat = {
        id: nextServiceId++,
        title: 'Matr√≠cula',
        variants: [],
        children: []
      };
      services.unshift(mat);
      for(let i = 1; i <= 5; i++){
        const v = {
          id: nextVariantId++,
          name: i.toString(),
          price: 480,
          days: ['LUN','MAR','MIE','JUE','VIE'],
          start: '07:30',
          end: '13:00'
        };
        mat.variants.push(v);
      }
      saveToFirebaseServices();
    }
    MATRICULA_ID = mat.id;
  }
function openTabServices(tabName) {
  // 1) Validar antes de quitar clases
  if (tabName === 'ServicesMain') {
    if (!currentUser.permisos.services) {
      alert("No tienes permiso para la pesta√±a principal de Servicios.");
      return;
    }
  } else if (tabName === 'ServicesVariants') {
    if (!currentUser.permisos.servicesVariants) {
      alert("No tienes permiso para 'Creador de Variantes'.");
      return;
    }
  } else if (tabName === 'ServicesChildren') {
    if (!currentUser.permisos.servicesChildren) {
      alert("No tienes permiso para 'Administrar Ni√±os' en Servicios.");
      return;
    }
  }

  // 2) Quitar clases de todas las pesta√±as
  document.getElementById('contentServicesMain').classList.remove('activeTabContent');
  document.getElementById('contentServicesVariants').classList.remove('activeTabContent');
  document.getElementById('contentServicesChildren').classList.remove('activeTabContent');
  document.getElementById('tabServicesMain').classList.remove('activeTab');
  document.getElementById('tabServicesVariants').classList.remove('activeTab');
  document.getElementById('tabServicesChildren').classList.remove('activeTab');

  // 3) Agregar la que corresponde
  if (tabName === 'ServicesMain') {
    document.getElementById('contentServicesMain').classList.add('activeTabContent');
    document.getElementById('tabServicesMain').classList.add('activeTab');
  } else if (tabName === 'ServicesVariants') {
    document.getElementById('contentServicesVariants').classList.add('activeTabContent');
    document.getElementById('tabServicesVariants').classList.add('activeTab');
  } else if (tabName === 'ServicesChildren') {
    document.getElementById('contentServicesChildren').classList.add('activeTabContent');
    document.getElementById('tabServicesChildren').classList.add('activeTab');
  }
}


  function showServicesList(){
    const container = document.getElementById('servicesList');
    container.innerHTML = '';
    services.sort((a, b) => {
      if(a.title === 'Matr√≠cula') return -1;
      if(b.title === 'Matr√≠cula') return 1;
      return 0;
    });
    services.forEach(s => {
      const div = document.createElement('div');
      div.className = 'service-item';
      const leftSpan = document.createElement('span');
      leftSpan.textContent = `${s.title} (Variantes: ${s.variants.length}) (Ni√±os: ${s.children.length})`;
      const rightDiv = document.createElement('div');
      if(s.title !== 'Matr√≠cula'){
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Editar';
        btnEdit.onclick = () => editService(s.id);
        rightDiv.appendChild(btnEdit);
      }
      const btnMat = document.createElement('button');
      btnMat.textContent = 'Administrar Ni√±os';
      btnMat.onclick = () => openServiceChildren(s.id);
      rightDiv.appendChild(btnMat);
      if(s.title !== 'Matr√≠cula'){
        const btnDel = document.createElement('button');
        btnDel.textContent = 'Eliminar';
        btnDel.onclick = () => deleteService(s.id);
        rightDiv.appendChild(btnDel);
      }
      div.appendChild(leftSpan);
      div.appendChild(rightDiv);
      container.appendChild(div);
    });
  }
function crearService() {
  // 1. Verificar si el usuario tiene permiso general para crear servicios
  if (!currentUser.permisos.services) {
    alert("No tienes permiso para crear servicios.");
    return;
  }

  // 2. (Opcional) Verificar tambi√©n si deseas que S√ç o S√ç tenga permisos 
  //    de 'servicesVariants' para poder crear el servicio.
  if (!currentUser.permisos.servicesVariants) {
    alert("No tienes permiso para el creador de variantes, no se crear√° el servicio.");
    return; 
  }

  // 3. Si pasa las validaciones, ahora s√≠ se crea
  const title = document.getElementById('tituloService').value.trim();
  if (!title) {
    alert('Ingresa un t√≠tulo para el servicio');
    return;
  }
  if (title === 'Matr√≠cula') {
    alert('Ya existe "Matr√≠cula"');
    return;
  }

  const newService = {
    id: nextServiceId++,
    title,
    variants: [],
    children: []
  };
  services.push(newService);

  document.getElementById('tituloService').value = '';
  showServicesList();
  saveToFirebaseServices();

  // 4. Finalmente, abrimos la pesta√±a de Variantes
  //    (ya sabemos que s√≠ tiene permiso)
  editService(newService.id);
}

function editService(serviceId) {
  const serv = services.find(s => s.id === serviceId);
  if (!serv) return;

  // Verificar permiso "servicesVariants" (o el que quieras).
  if (!currentUser.permisos.servicesVariants) {
    alert("No tienes permiso para editar variantes de un servicio.");
    return; 
  }

  // Si S√ç tiene permiso, seguimos
  editingServiceId = serviceId;
  openTabServices('ServicesVariants'); // Aqu√≠ s√≠ se abrir√° la pesta√±a
  document.getElementById('currentServiceTitle').textContent = serv.title;
  clearVariantForm();
  renderVariantsTable(serv.variants);
}
  function deleteService(serviceId){
    if(!confirm('¬øSeguro de eliminar este servicio?')) return;
    services = services.filter(s => s.id !== serviceId);
    showServicesList();
    saveToFirebaseServices();
  }
  /* Variants logic */
  function setupDaysButtons(){
    const dayLabels = ['LUN','MAR','MIE','JUE','VIE'];
    const container = document.getElementById('daysContainer');
    container.innerHTML = '';
    dayLabels.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'day-btn';
      btn.textContent = d;
      btn.onclick = () => btn.classList.toggle('selected');
      container.appendChild(btn);
    });
  }
  function clearVariantForm(){
    editingVariantId = null;
    document.getElementById('variantName').value = '';
    document.getElementById('variantPrice').value = '';
    document.getElementById('variantStart').value = '';
    document.getElementById('variantEnd').value = '';
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('btnVariantPrincipal').textContent = 'Agregar Variante';
  }
  function agregarOguardarVariante(){
    if(!editingServiceId){
      alert('No hay servicio seleccionado.');
      return;
    }
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv){
      alert('Servicio no encontrado');
      return;
    }
    const name = document.getElementById('variantName').value.trim();
    const price = parseFloat(document.getElementById('variantPrice').value);
    const startT = document.getElementById('variantStart').value;
    const endT = document.getElementById('variantEnd').value;
    const selectedDays = [];
    document.querySelectorAll('.day-btn.selected').forEach(btn => selectedDays.push(btn.textContent));
    if(!name || isNaN(price) || !startT || !endT){
      alert('Completa todos los campos de la variante');
      return;
    }
    if(editingVariantId === null){
      const newVar = {
        id: nextVariantId++,
        name,
        price,
        days: selectedDays,
        start: startT,
        end: endT
      };
      serv.variants.push(newVar);
    } else {
      const idx = serv.variants.findIndex(v => v.id === editingVariantId);
      if(idx >= 0){
        serv.variants[idx].name = name;
        serv.variants[idx].price = price;
        serv.variants[idx].days = selectedDays;
        serv.variants[idx].start = startT;
        serv.variants[idx].end = endT;
      }
      editingVariantId = null;
      document.getElementById('btnVariantPrincipal').textContent = 'Agregar Variante';
    }
    clearVariantForm();
    renderVariantsTable(serv.variants);
    saveToFirebaseServices();
  }
  function renderVariantsTable(arr){
    const tbody = document.getElementById('tbodyVariants');
    tbody.innerHTML = '';
    arr.forEach(v => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = v.name;
      row.insertCell(1).textContent = v.days.join(', ');
      row.insertCell(2).textContent = `S/${v.price}`;
      row.insertCell(3).textContent = `${v.start} - ${v.end}`;
      const accCell = row.insertCell(4);
      const btnEd = document.createElement('button');
      btnEd.textContent = 'editar';
      btnEd.onclick = () => editVariant(v.id);
      accCell.appendChild(btnEd);
      const btnDel = document.createElement('button');
      btnDel.textContent = ' x ';
      btnDel.style.marginLeft = '5px';
      btnDel.onclick = () => deleteVariant(v.id);
      accCell.appendChild(btnDel);
    });
  }
  function editVariant(variantId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    const vr = serv.variants.find(v => v.id === variantId);
    if(!vr) return;
    editingVariantId = variantId;
    document.getElementById('variantName').value = vr.name;
    document.getElementById('variantPrice').value = vr.price;
    document.getElementById('variantStart').value = vr.start;
    document.getElementById('variantEnd').value = vr.end;
    document.querySelectorAll('.day-btn').forEach(btn => {
      if(vr.days.includes(btn.textContent)) btn.classList.add('selected');
      else btn.classList.remove('selected');
    });
    document.getElementById('btnVariantPrincipal').textContent = 'Guardar Variante';
  }
  function deleteVariant(variantId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    serv.variants = serv.variants.filter(v => v.id !== variantId);
    renderVariantsTable(serv.variants);
    saveToFirebaseServices();
  }
  function doneVariants(){
    openTabServices('ServicesMain');
    showServicesList();
    saveToFirebaseServices();
  }
  /* Administrar Ni√±os */
  function openServiceChildren(serviceId){
    editingServiceId = serviceId;
    const serv = services.find(s => s.id === serviceId);
    if(!serv) return;
    openTabServices('ServicesChildren');
    document.getElementById('tabServicesChildren').style.display = 'block';
    document.getElementById('currentServiceTitleChild').textContent = serv.title;
    clearChildForm();
    renderChildrenTable(serv.children);
    const lab = document.getElementById('labelVariantChild');
    if(serv.title === 'Matr√≠cula') lab.textContent = 'A√±o';
    else lab.textContent = 'Variante';
    const sel = document.getElementById('childVariantSelect');
    sel.innerHTML = '';
    if(serv.variants.length === 0){
      const opt = document.createElement('option');
      opt.text = 'Sin variantes';
      sel.add(opt);
      sel.disabled = true;
    } else if(serv.variants.length === 1){
      sel.disabled = true;
      const v = serv.variants[0];
      const opt = document.createElement('option');
      opt.value = v.id;
      opt.textContent = v.name;
      sel.add(opt);
    } else {
      sel.disabled = false;
      serv.variants.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.name;
        sel.appendChild(opt);
      });
    }
  }
  function clearChildForm(){
    editingServiceChildId = null;
    document.getElementById('childName').value = '';
    document.getElementById('childLastname').value = '';
    document.getElementById('childDate').value = '';
    document.getElementById('btnChildPrincipal').textContent = 'Agregar Ni√±o';
  }
function renderChildrenTable(arr) {
  const tbody = document.getElementById('tbodyChildren');
  tbody.innerHTML = '';
  const serv = services.find(s => s.id === editingServiceId);
  if (!serv) return;

  arr.forEach(ch => {
    const row = tbody.insertRow();

    // Columna 1: Nombre
    row.insertCell(0).textContent = ch.name;

    // Columna 2: Apellidos
    row.insertCell(1).textContent = ch.lastname;

    // Columna 3: Fecha
    row.insertCell(2).textContent = ch.date;

    // Columna 4: Variante
    const variant = serv.variants.find(v => v.id === ch.variantId);
    row.insertCell(3).textContent = variant ? variant.name : 'Sin variante';

    // Columna 5: Pag√≥ Pensi√≥n (bot√≥n tipo S√≠ / No)
    const cellPension = row.insertCell(4);
    const btnP = document.createElement('button');
    btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
    btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
    btnP.style.color = '#fff';
    btnP.style.border = 'none';
    btnP.style.borderRadius = '6px';
    btnP.style.padding = '6px 10px';
    btnP.onclick = () => {
      // Toggle
      ch.pagoPension = !ch.pagoPension;
      btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
      btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
      // Guardamos cambios en Firebase
      saveToFirebaseServices();
    };
    cellPension.appendChild(btnP);

    // Columna 6: Pensiones Atrasadas (input type="number")
    const cellAtrasos = row.insertCell(5);
    const inputA = document.createElement('input');
    inputA.type = 'number';
    inputA.style.width = '60px';
    inputA.value = ch.pensionesAtrasadas || 0;
    inputA.onchange = () => {
      // Convertir a n√∫mero y asignar
      ch.pensionesAtrasadas = parseInt(inputA.value) || 0;
      saveToFirebaseServices();
    };
    cellAtrasos.appendChild(inputA);

    // Columna 7: Acciones (editar, eliminar, etc.)
    const accCell = row.insertCell(6);
    const btnEd = document.createElement('button');
    btnEd.textContent = '‚úé';
    btnEd.onclick = () => editServiceChild(ch.id);
    accCell.appendChild(btnEd);

    const btnDel = document.createElement('button');
    btnDel.textContent = 'üóëÔ∏è';
    btnDel.style.marginLeft = '5px';
    btnDel.onclick = () => deleteServiceChild(ch.id);
    accCell.appendChild(btnDel);
  });
}

  function agregarOguardarChild(){
    if(!editingServiceId){
      alert('No hay servicio seleccionado');
      return;
    }
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    const name = document.getElementById('childName').value.trim().toUpperCase();
    const lastname = document.getElementById('childLastname').value.trim().toUpperCase();
    const dateIn = document.getElementById('childDate').value;
    const sel = document.getElementById('childVariantSelect');
    let variantId = null;
    if(sel.options.length === 1 && !sel.disabled){
      variantId = parseInt(sel.options[0].value);
    } else if(!sel.disabled){
      variantId = parseInt(sel.value);
    } else if(sel.disabled && serv.variants.length === 1){
      variantId = serv.variants[0].id;
    }
    if(!name || !lastname || !dateIn){
      alert('Completa todos los campos');
      return;
    }
if(editingServiceChildId === null){
  let precio = 0;
  // Buscar la variante seleccionada seg√∫n variantId obtenido del select
  if(serv.variants && serv.variants.length > 0) {
    let variant = serv.variants.find(v => v.id === variantId);
    if(variant) {
      precio = variant.price; // Asigna el precio de la variante
    }
  }
  const nuevo = {
    id: nextServiceChildId++,
    name,
    lastname,
    date: dateIn,
    variantId,
    mesRegistro: getYearMonth(), // Guarda el mes en que se registr√≥
    total: precio,              // Aqu√≠ se asigna el precio obtenido
    ficha: {},
    fichaCompleta: false,
    pagoPension: false,         // Usaremos esta variable unificada para "Pag√≥ Pensi√≥n/Mensualidad"
    pensionesAtrasadas: 0,
    lastPagoCheck: getYearMonth()
  };
  serv.children.push(nuevo);
} else {
  // En el caso de editar, actualizamos tambi√©n el total:
  const idx = serv.children.findIndex(c => c.id === editingServiceChildId);
  if(idx >= 0){
    serv.children[idx].name = name;
    serv.children[idx].lastname = lastname;
    serv.children[idx].date = dateIn;
    serv.children[idx].variantId = variantId;
    let precio = 0;
    if(serv.variants && serv.variants.length > 0) {
      let variant = serv.variants.find(v => v.id === variantId);
      if(variant) {
        precio = variant.price;
      }
    }
    serv.children[idx].total = precio;
  }
  editingServiceChildId = null;
  document.getElementById('btnChildPrincipal').textContent = 'Agregar Ni√±o';
}

    clearChildForm();
    renderChildrenTable(serv.children);
    saveToFirebaseServices();
  }
  function editServiceChild(childId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    const ch = serv.children.find(c => c.id === childId);
    if(!ch) return;
    editingServiceChildId = childId;
    document.getElementById('childName').value = ch.name;
    document.getElementById('childLastname').value = ch.lastname;
    document.getElementById('childDate').value = ch.date;
    document.getElementById('btnChildPrincipal').textContent = 'Guardar Ni√±o';
    const sel = document.getElementById('childVariantSelect');
    if(!sel.disabled && ch.variantId) sel.value = ch.variantId;
  }
  function deleteServiceChild(childId){
    const serv = services.find(s => s.id === editingServiceId);
    if(!serv) return;
    serv.children = serv.children.filter(c => c.id !== childId);
    renderChildrenTable(serv.children);
    saveToFirebaseServices();
  }
  function doneChildren(){
    openTabServices('ServicesMain');
    showServicesList();
    saveToFirebaseServices();
  }
  function getVariantName(varId){
    if(!varId) return null;
    for(const s of services){
      const fv = s.variants.find(v => v.id === varId);
      if(fv) return fv.name;
    }
    return null;
  }
  function getYearMonth(){
    const d = new Date();
    return d.getFullYear().toString() + '-' + String(d.getMonth()+1).padStart(2, '0');
  }

  /**************************************************************
   * FINANZAS (NUEVO MEN√ö)
   **************************************************************/
  // Variables para finanzas
  let finanzasData = {
    egresos: [], // Array de objetos de egresos
    ingresos: [] // Se obtendr√°n de los registros de servicios (ni√±os)
  };
  // Se espera que cada registro de egreso tenga: id, nombre, tipo, subtipo, cantidad, descuento, mes, a√±o
  let nextEgresoId = 1;
  // Para simplificar, los ingresos se calcular√°n a partir de los datos ya almacenados en servicios

  // Inicializaci√≥n de opciones del selector de mes (por ejemplo, √∫ltimos 12 meses)
  function initSelectorMesFinanzas(){
    const select = document.getElementById('finanzasMes');
    select.innerHTML = '';
    const d = new Date();
    // Por defecto mostrar el mes actual y los 11 anteriores
    for(let i = 0; i < 12; i++){
      let fecha = new Date(d.getFullYear(), d.getMonth() - i, 1);
      let mes = fecha.getMonth() + 1;
      let anio = fecha.getFullYear();
      let option = document.createElement('option');
      option.value = `${anio}-${mes.toString().padStart(2,'0')}`;
      option.textContent = `${meses[fecha.getMonth()]} ${anio}`;
      select.appendChild(option);
    }
  }
  // Funci√≥n para cambiar de mes en Finanzas
  function cambiarMesFinanzas(){
    renderFinanzas();
  }
  function cargarSubtiposEgresos() {
  const sel = document.getElementById('egresoSubtipo');
  sel.innerHTML = '<option value="">-- Selecciona Subtipo --</option>';
  subtiposEgresos.forEach(st => {
    const opt = document.createElement('option');
    opt.value = st;
    opt.textContent = st;
    sel.appendChild(opt);
  });
  }
function agregarNuevoSubtipo() {
  const nuevo = prompt("Ingresa el nuevo subtipo de egreso:");
  if(nuevo && nuevo.trim() !== "") {
    subtiposEgresos.push(nuevo.trim());
    cargarSubtiposEgresos();
    document.getElementById('egresoSubtipo').value = nuevo.trim();
    saveFinanzasData(); // Guarda la lista actualizada de subtipos en Firebase
  }
}

  // Funci√≥n para inicializar Finanzas
async function initFinanzas() {
  initSelectorMesFinanzas();
  await loadFinanzasData();
  cargarSubtiposEgresos();

  // Llamada a ambos
  initEgresosFilters();    // <--- IMPORTANTE
  initIngresosFilters();

  renderFinanzas();
  actualizarGraficosFinanzas();
}




  // Renderiza la vista de Finanzas seg√∫n el mes seleccionado
function renderFinanzas(){
  const mesSeleccionado = document.getElementById('finanzasMes').value;
  // Filtrar egresos para el mes seleccionado
  const egresosFiltrados = finanzasData.egresos.filter(e => `${e.anio}-${String(e.mes).padStart(2, '0')}` === mesSeleccionado);

  // C√°lculos para egresos
  const totalEgresosVariables = calcularEgresosTipo(egresosFiltrados, "Variable");
  const totalEgresosFijos = calcularEgresosTipo(egresosFiltrados, "Fijo");
  const totalEgresos = calcularEgresosTotales(egresosFiltrados);

  // C√°lculos para ingresos
  const brutoEsperado = calcularIngresosBrutoEsperado(mesSeleccionado);
  const netoEsperado = calcularIngresosNetoEsperado(mesSeleccionado);
  const brutoTotales = calcularIngresosBrutosTotales(mesSeleccionado);
  const netoTotales = calcularIngresosNetosTotales(mesSeleccionado);

  // Actualiza las tarjetas
  document.getElementById('egresosVariables').textContent = "S/ " + totalEgresosVariables.toFixed(2);
  document.getElementById('egresosFijos').textContent = "S/ " + totalEgresosFijos.toFixed(2);
  document.getElementById('egresosTotales').textContent = "S/ " + totalEgresos.toFixed(2);
  document.getElementById('ingresosBrutosEsperados').textContent = "S/ " + brutoEsperado.toFixed(2);
  document.getElementById('ingresosNetosEsperados').textContent = "S/ " + netoEsperado.toFixed(2);
  document.getElementById('ingresosBrutosTotales').textContent = "S/ " + brutoTotales.toFixed(2);
  document.getElementById('ingresosNetosTotales').textContent = "S/ " + netoTotales.toFixed(2);
  // Tambi√©n podr√≠as asignar ingresosEsperados e ingresosNetos seg√∫n tu l√≥gica
  document.getElementById('ingresosBruto').textContent = "S/ " + brutoEsperado.toFixed(2);
  document.getElementById('ingresosNetos').textContent = "S/ " + netoTotales.toFixed(2);

  // Si deseas actualizar un indicador de variaci√≥n, por ejemplo:
  const variacion = netoTotales; // o alguna otra f√≥rmula
  const indicadorEl = document.getElementById('indicadorVariacion');
  indicadorEl.textContent = "Variaci√≥n: " + (variacion >= 0 ? "+" : "") + variacion.toFixed(2) + "%";
  if (variacion < 0) {
    indicadorEl.style.color = "red";
  } else {
    indicadorEl.style.color = "";
  }

  // Renderizar tablas y actualizar gr√°ficos (con tus funciones actuales)
  renderTablaEgresos(egresosFiltrados);
  renderTablaIngresos(mesSeleccionado);
  actualizarGraficosFinanzas();
}

  function calcularEgresosTipo(egresos, tipo){
    return egresos.filter(e => e.tipo === tipo).reduce((acc, e) => acc + (parseFloat(e.cantidad) - parseFloat(e.descuento || 0)), 0);
  }
  function calcularEgresosTotales(egresos){
    return egresos.reduce((acc, e) => acc + (parseFloat(e.cantidad) - parseFloat(e.descuento || 0)), 0);
  }
function renderTablaEgresos(egresos) {
  // 1) Tomar el valor del select
  const tipoSelect = document.getElementById("filtroEgresosTipo").value;
  const subtipoSelect = document.getElementById("filtroEgresosSubtipo").value;

  // 2) Filtrar localmente (solo afecta esta PC)
  let egresosFiltrados = egresos;
  if(tipoSelect) {
    egresosFiltrados = egresosFiltrados.filter(e => e.tipo === tipoSelect);
  }
  if(subtipoSelect) {
    egresosFiltrados = egresosFiltrados.filter(e => e.subtipo === subtipoSelect);
  }

  // 3) Pintar la tabla con egresosFiltrados
  const tbody = document.getElementById('tablaEgresos').querySelector('tbody');
  tbody.innerHTML = '';
  egresosFiltrados.forEach(e => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = e.nombre;
    row.insertCell(1).textContent = e.tipo;
    row.insertCell(2).textContent = e.subtipo;
    row.insertCell(3).textContent = e.cantidad;
    row.insertCell(4).textContent = e.descuento;
    row.insertCell(5).textContent = (parseFloat(e.cantidad) - parseFloat(e.descuento || 0)).toFixed(2);

    const accCell = row.insertCell(6);
    const btnEd = document.createElement('button');
    btnEd.textContent = 'Editar';
    btnEd.onclick = () => editarEgreso(e.id);
    accCell.appendChild(btnEd);

    const btnDel = document.createElement('button');
    btnDel.textContent = 'Eliminar';
    btnDel.style.marginLeft = '5px';
    btnDel.onclick = () => eliminarEgreso(e.id);
    accCell.appendChild(btnDel);
  });
}

function renderTablaIngresos(mesSeleccionado) {
  const tbody = document.getElementById('tablaIngresos').querySelector('tbody');
  tbody.innerHTML = '';

  // Tomamos valores del filtro
  const tipoSeleccionado = document.getElementById("filtroIngresosTipo").value;     // "" / "Matr√≠cula" / "Taller"
  const tallerSeleccionado = document.getElementById("filtroIngresosSubtipo").value; // "" / "Ingl√©s" / "M√∫sica" / etc.

  // Recorremos todos los servicios
  services.forEach(serv => {
    // 1) Verificamos si coincide el filtro de tipo
    //    "Matr√≠cula" => serv.title === "Matr√≠cula"
    //    "Taller" => serv.title !== "Matr√≠cula"
    //    "" => sin restricci√≥n
    if (tipoSeleccionado === "Matr√≠cula" && serv.title !== "Matr√≠cula") {
      return; // no coincide
    }
    if (tipoSeleccionado === "Taller" && serv.title === "Matr√≠cula") {
      return; // no coincide
    }

    // 2) Verificar si coincide el filtro de "tallerSeleccionado"
    //    (solo si no es vac√≠o)
    if (tallerSeleccionado && serv.title !== tallerSeleccionado) {
      return; // no coincide
    }

    // Ahora iteramos sus children (ingresos)
    serv.children.forEach(child => {
      if (child.mesRegistro === mesSeleccionado) {
        // Creamos una fila
        const row = tbody.insertRow();
        row.insertCell(0).textContent = child.name + " " + child.lastname;

        // Determinar si es "Matr√≠cula" o "Taller" para la columna 2
        const tipo = (serv.title === "Matr√≠cula") ? "Matr√≠cula" : "Taller";
        row.insertCell(1).textContent = tipo;

        // En la columna 3, el "Subtipo" = serv.title (para talleres),
        // si es "Matr√≠cula" la dejamos vac√≠a o pones "Sin taller"
        row.insertCell(2).textContent = (tipo === "Taller") ? serv.title : "";

        row.insertCell(3).textContent = "S/ " + (child.total || 0).toFixed(2);

        // Celda 5: Bot√≥n "Pag√≥ Mensualidad"
        const cellPago = row.insertCell(4);
        const btnPago = document.createElement('button');
        btnPago.textContent = child.pagoPension ? "S√≠" : "No";
        btnPago.style.backgroundColor = child.pagoPension ? "#3BB273" : "#E74C3C";
        btnPago.style.color = "#fff";
        btnPago.style.border = "none";
        btnPago.style.borderRadius = "6px";
        btnPago.style.padding = "6px 10px";
        btnPago.onclick = () => {
          child.pagoPension = !child.pagoPension;
          btnPago.textContent = child.pagoPension ? "S√≠" : "No";
          btnPago.style.backgroundColor = child.pagoPension ? "#3BB273" : "#E74C3C";
          saveToFirebaseServices();
          // Actualizar la tabla
          renderTablaIngresos(mesSeleccionado);
          renderFinanzas(); 
        };
        cellPago.appendChild(btnPago);
      }
    });
  });
}



  function agregarEgreso(){
  const nombre = document.getElementById('egresoNombre').value.trim();
  const tipo = document.getElementById('egresoTipo').value;
  const subtipo = document.getElementById('egresoSubtipo').value;
  const cantidad = document.getElementById('egresoCantidad').value;
  const descuento = document.getElementById('egresoDescuento').value;
  if(!nombre || !tipo || !subtipo || !cantidad){
    alert("Completa todos los campos del egreso");
    return;
  }
  const mesAnio = document.getElementById('finanzasMes').value.split('-');
  const anio = mesAnio[0];
  const mes = parseInt(mesAnio[1]);
  const nuevo = {
    id: nextEgresoId++,
    nombre,
    tipo,
    subtipo,
    cantidad,
    descuento: descuento || 0,
    anio: anio,
    mes: mes
  };
  finanzasData.egresos.push(nuevo);
  // Limpiar campos
  document.getElementById('egresoNombre').value = '';
  document.getElementById('egresoTipo').value = '';
  document.getElementById('egresoSubtipo').value = '';
  document.getElementById('egresoCantidad').value = '';
  document.getElementById('egresoDescuento').value = '';
  renderFinanzas();
  saveFinanzasData(); // Guarda en Firebase
}

  function editarEgreso(id){
    // Funci√≥n para editar egreso: se deben cargar los datos en el formulario y luego actualizar el registro.
    const egreso = finanzasData.egresos.find(e => e.id === id);
    if(!egreso) return;
    document.getElementById('egresoNombre').value = egreso.nombre;
    document.getElementById('egresoTipo').value = egreso.tipo;
    document.getElementById('egresoSubtipo').value = egreso.subtipo;
    document.getElementById('egresoCantidad').value = egreso.cantidad;
    document.getElementById('egresoDescuento').value = egreso.descuento;
    // Eliminar el registro para que al agregar se reescriba
    finanzasData.egresos = finanzasData.egresos.filter(e => e.id !== id);
  }
  function eliminarEgreso(id){
  if(!confirm("¬øEliminar egreso?")) return;
  finanzasData.egresos = finanzasData.egresos.filter(e => e.id !== id);
  renderFinanzas();
  saveFinanzasData(); // Aseg√∫rate de llamar a guardar datos en Firebase
}

  // Funciones para actualizar gr√°ficos (placeholders)
function actualizarGraficosFinanzas(){
// Obtener datos para Total Mensual
const mesSeleccionado = document.getElementById('finanzasMes').value;
const ingresosBrutosTotales = calcularIngresosBrutosTotales(mesSeleccionado);
const ingresosNetosEsperados = calcularIngresosNetoEsperado(mesSeleccionado);
const faltante = Math.max(ingresosNetosEsperados - ingresosNetosTotales, 0);

const ctxPastel = document.getElementById('chartFinanzasCircular').getContext('2d');
if (window.chartFinanzasCircular && typeof window.chartFinanzasCircular.destroy === 'function') {
  window.chartFinanzasCircular.destroy();
}
window.chartFinanzasCircular = new Chart(ctxPastel, {
  type: 'pie',
  data: {
    labels: ['Pagado', 'Falta'],
    datasets: [{
      data: [ingresosNetosTotales, faltante],
      backgroundColor: ['#3BB273', '#E74C3C']
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false
  }
});
const totalFijos = calcularEgresosTipo(
  finanzasData.egresos.filter(e => `${e.anio}-${String(e.mes).padStart(2,'0')}` === mesSeleccionado),
  "Fijo"
);
const totalVariables = calcularEgresosTipo(
  finanzasData.egresos.filter(e => `${e.anio}-${String(e.mes).padStart(2,'0')}` === mesSeleccionado),
  "Variable"
);
const ctxPastelEgresos = document.getElementById('chartEgresosCircular').getContext('2d');
if (window.chartEgresosCircular && typeof window.chartEgresosCircular.destroy === 'function') {
  window.chartEgresosCircular.destroy();
}
window.chartEgresosCircular = new Chart(ctxPastelEgresos, {
  type: 'pie',
  data: {
    labels: ['Fijos', 'Variables'],
    datasets: [{
      data: [totalFijos, totalVariables],
      backgroundColor: ['#4a90e2', '#f1c40f']
    }]
  },
  options: { responsive: true, maintainAspectRatio: false }
});
let ingresosMatricula = 0, ingresosTaller = 0;
services.forEach(serv => {
  serv.children.forEach(child => {
    if(child.mesRegistro === mesSeleccionado && child.pagoPension) {
      if(serv.title === "Matr√≠cula") {
        ingresosMatricula += child.total || 0;
      } else {
        ingresosTaller += child.total || 0;
      }
    }
  });
});
const ctxPastelIngresos = document.getElementById('chartIngresosCircular').getContext('2d');
if (window.chartIngresosCircular && typeof window.chartIngresosCircular.destroy === 'function') {
  window.chartIngresosCircular.destroy();
}
window.chartIngresosCircular = new Chart(ctxPastelIngresos, {
  type: 'pie',
  data: {
    labels: ['Matr√≠cula', 'Taller'],
    datasets: [{
      data: [ingresosMatricula, ingresosTaller],
      backgroundColor: ['#3BB273', '#f1c40f']
    }]
  },
  options: { responsive: true, maintainAspectRatio: false }
});

}
function obtenerDatosLinealIngresosNetos(){
  const labels = [];
  const datos = [];
  const d = new Date();
  // Ejemplo: √∫ltimos 12 meses
  for(let i = 11; i >= 0; i--){
    let fecha = new Date(d.getFullYear(), d.getMonth() - i, 1);
    let mes = fecha.getMonth() + 1;
    let anio = fecha.getFullYear();
    const key = `${anio}-${mes.toString().padStart(2, '0')}`;
    labels.push(`${meses[fecha.getMonth()]} ${anio}`);
    datos.push(calcularIngresosNetosTotales(key));
  }
  return { labels, datos };
}

const datosLineal = obtenerDatosLinealIngresosNetos();
const ctxLineal = document.getElementById('chartFinanzasLinealTotal').getContext('2d');
if (window.chartFinanzasLinealTotal && typeof window.chartFinanzasLinealTotal.destroy === 'function') {
  window.chartFinanzasLinealTotal.destroy();
}
window.chartFinanzasLinealTotal = new Chart(ctxLineal, {
  type: 'line',
  data: {
    labels: datosLineal.labels,
    datasets: [{
      label: 'Ingresos Netos Totales',
      data: datosLineal.datos,
      borderColor: '#3BB273',
      backgroundColor: 'rgba(59,178,115,0.2)'
    }]
  },
  options: { responsive: true, maintainAspectRatio: false }
});

const datosLinealIngresos = obtenerDatosLinealIngresosNetos(); // Reutilizando la funci√≥n definida para Total Mensual
const ctxLinealIngresos = document.getElementById('chartIngresosLineal').getContext('2d');
if (window.chartIngresosLineal && typeof window.chartIngresosLineal.destroy === 'function') {
  window.chartIngresosLineal.destroy();
}
window.chartIngresosLineal = new Chart(ctxLinealIngresos, {
  type: 'line',
  data: {
    labels: datosLinealIngresos.labels,
    datasets: [{
      label: 'Ingresos Netos Totales',
      data: datosLinealIngresos.datos,
      borderColor: '#3BB273',
      backgroundColor: 'rgba(59,178,115,0.2)'
    }]
  },
  options: { responsive: true, maintainAspectRatio: false }
});

function obtenerDatosLinealEgresos(){
  const labels = [];
  const datos = [];
  const d = new Date();
  for(let i = 11; i >= 0; i--){
    let fecha = new Date(d.getFullYear(), d.getMonth() - i, 1);
    let mes = fecha.getMonth() + 1;
    let anio = fecha.getFullYear();
    const key = `${anio}-${mes.toString().padStart(2, '0')}`;
    labels.push(`${meses[fecha.getMonth()]} ${anio}`);
    // Suma total de egresos para ese mes
    const egresosMes = finanzasData.egresos.filter(e => `${e.anio}-${String(e.mes).padStart(2,'0')}` === key);
    datos.push(calcularEgresosTotales(egresosMes));
  }
  return { labels, datos };
}

const datosLinealEgresos = obtenerDatosLinealEgresos();
const ctxLinealEgresos = document.getElementById('chartEgresosLineal').getContext('2d');
if (window.chartEgresosLineal && typeof window.chartEgresosLineal.destroy === 'function') {
  window.chartEgresosLineal.destroy();
}
window.chartEgresosLineal = new Chart(ctxLinealEgresos, {
  type: 'line',
  data: {
    labels: datosLinealEgresos.labels,
    datasets: [{
      label: 'Egresos Totales',
      data: datosLinealEgresos.datos,
      borderColor: '#E74C3C',
      backgroundColor: 'rgba(231,76,60,0.2)'
    }]
  },
  options: { responsive: true, maintainAspectRatio: false }
});

function openTabFinanzas(tabName) {
  // 1) Validar permisos
  if (tabName === 'Total') {
    if (!currentUser.permisos.finanzasTotal) {
      alert("No tienes permiso para 'Finanzas - Total Mensual'.");
      return;
    }
  } else if (tabName === 'Egresos') {
    if (!currentUser.permisos.finanzasEgresos) {
      alert("No tienes permiso para 'Finanzas - Egresos'.");
      return;
    }
  } else if (tabName === 'Ingresos') {
    if (!currentUser.permisos.finanzasIngresos) {
      alert("No tienes permiso para 'Finanzas - Ingresos'.");
      return;
    }
  }


  // 2) Quitar las clases de todas las pesta√±as de Finanzas
  document.getElementById('contentFinanzasTotal').classList.remove('activeTabContent');
  document.getElementById('contentFinanzasEgresos').classList.remove('activeTabContent');
  document.getElementById('contentFinanzasIngresos').classList.remove('activeTabContent');
  document.getElementById('tabFinanzasTotal').classList.remove('activeTab');
  document.getElementById('tabFinanzasEgresos').classList.remove('activeTab');
  document.getElementById('tabFinanzasIngresos').classList.remove('activeTab');

  // 3) Activar la pesta√±a correcta
  if (tabName === 'Total') {
    document.getElementById('contentFinanzasTotal').classList.add('activeTabContent');
    document.getElementById('tabFinanzasTotal').classList.add('activeTab');
  } else if (tabName === 'Egresos') {
    document.getElementById('contentFinanzasEgresos').classList.add('activeTabContent');
    document.getElementById('tabFinanzasEgresos').classList.add('activeTab');
  } else if (tabName === 'Ingresos') {
    document.getElementById('contentFinanzasIngresos').classList.add('activeTabContent');
    document.getElementById('tabFinanzasIngresos').classList.add('activeTab');
  }
}

function initFinanzasRealTime() {
  const docRef = doc(db, "data", "finanzas");
  onSnapshot(docRef, (docSnap) => {
    if (docSnap.exists()) {
      finanzasData = docSnap.data();
      // cada vez que hay un cambio, re-renderizas la parte de finanzas
      renderFinanzas();
    }
  });
}

  /**************************************************************
   * FICHA INFORMATIVA (Ya existente)
   **************************************************************/
  let currentFichaChild = null;
  function openFicha(childObj) {
    currentFichaChild = childObj;
    document.getElementById('matriculasContainer').classList.remove('activeContainer');
    screenStack.push("ficha");
    document.getElementById('fichaInformativaPanel').style.display = 'block';
    renderFicha(childObj);
  }
  function renderFicha(ch) {
    const cont = document.getElementById('fichaContent');
    cont.innerHTML = '';
    if (!ch.ficha) ch.ficha = {};
    if (!ch.hasOwnProperty('fichaCompleta')) ch.fichaCompleta = false;
    if (ch.fichaCompleta) {
      const h3 = document.createElement('h3');
      h3.textContent = "Ficha Informativa (Completada)";
      cont.appendChild(h3);
      cont.innerHTML += createFichaResumenHTML(ch.ficha);
      const btnEd = document.createElement('button');
      btnEd.className = 'finish-btn';
      btnEd.textContent = 'Editar';
      btnEd.onclick = () => {
        ch.fichaCompleta = false;
        renderFicha(ch);
      };
      cont.appendChild(btnEd);
      const btnBack = document.createElement('button');
      btnBack.className = 'finish-btn';
      btnBack.style.marginLeft = '10px';
      btnBack.textContent = 'Regresar';
      btnBack.onclick = goBackFicha;
      cont.appendChild(btnBack);
// Bot√≥n para descargar Word
const btnDescargarWord = document.createElement('button');
btnDescargarWord.className = 'finish-btn';
btnDescargarWord.style.marginLeft = '10px';
btnDescargarWord.textContent = 'Descargar Word';
btnDescargarWord.onclick = () => descargarFichaWord(ch);
cont.appendChild(btnDescargarWord);

    } else {
      createFichaForm(ch, cont);
    }
  }
  function createFichaResumenHTML(f) {
    let html = "<ul>";
    for (const key in f) {
      if (f.hasOwnProperty(key)) {
        html += `<li><strong>${key}:</strong> ${f[key]}</li>`;
      }
    }
    html += "</ul>";
    return html;
  }
  function createFichaForm(ch, container) {
    const sec1 = document.createElement('div');
    sec1.className = 'subsection';
    let h4_1 = document.createElement('h4');
    h4_1.textContent = "Secci√≥n 1: Datos del Ni√±o";
    sec1.appendChild(h4_1);
    sec1.appendChild(makeField("DNI", "dni", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Nombres y Apellidos", "nomApeNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Fecha de Nacimiento (d√≠a/mes/a√±o)", "fechaNacNino", "date", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Lugar de Nacimiento", "lugarNacNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Edad (en a√±os)", "edadNino", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Sexo", "sexoNino", "select", ch.ficha, { required: true, options: ["Masculino", "Femenino", "Otro"] }));
    sec1.appendChild(makeField("Religi√≥n", "religionNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tipo de Parto (Normal / Ces√°rea)", "tipoParto", "select", ch.ficha, { required: true, options: ["Normal", "Ces√°rea"] }));
    sec1.appendChild(makeField("Direcci√≥n", "direccionNino", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Nro. de Hermanos", "nroHermanos", "number", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tel√©fono (principal)", "telPrincipal", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tel√©fono(s) de Emergencia", "telEmergencia", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Centro M√©dico en caso de urgencia", "centroMedico", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("N√∫mero de Seguro", "numSeguro", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("Tipo de Seguro", "tipoSeguro", "text", ch.ficha, { required: true }));
    sec1.appendChild(makeField("¬øCon qui√©n o qui√©nes vive el menor?", "conQuienVive", "select", ch.ficha, {
      required: true,
      options: ["Solo el Padre", "Solo la Madre", "Ambos Padres", "Apoderado"]
    }));
    container.appendChild(sec1);
    const sec2 = document.createElement('div');
    sec2.className = 'subsection';
    let hh2 = document.createElement('h4');
    hh2.textContent = "Secci√≥n 2: Datos del Padre";
    sec2.appendChild(hh2);
    sec2.appendChild(makeField("Apellidos y Nombres", "apellidosPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("DNI", "dniPadre", "number", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Fecha de Nacimiento", "fechaNacPadre", "date", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Religi√≥n", "religionPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Estado Civil", "estadoCivilPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Grado de Instrucci√≥n", "gradoInstrPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Ocupaci√≥n", "ocupPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Tel√©fono", "telPadre", "text", ch.ficha, { required: true }));
    sec2.appendChild(makeField("Correo Electr√≥nico", "emailPadre", "text", ch.ficha, { required: true }));
    container.appendChild(sec2);
    const sec3 = document.createElement('div');
    sec3.className = 'subsection';
    let hh3 = document.createElement('h4');
    hh3.textContent = "Secci√≥n 3: Datos de la Madre";
    sec3.appendChild(hh3);
    sec3.appendChild(makeField("Apellidos y Nombres", "apellidosMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("DNI", "dniMadre", "number", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Fecha de Nacimiento", "fechaNacMadre", "date", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Religi√≥n", "religionMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Estado Civil", "estadoCivilMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Grado de Instrucci√≥n", "gradoInstrMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Ocupaci√≥n", "ocupMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Tel√©fono", "telMadre", "text", ch.ficha, { required: true }));
    sec3.appendChild(makeField("Correo Electr√≥nico", "emailMadre", "text", ch.ficha, { required: true }));
    container.appendChild(sec3);
    const sec4 = document.createElement('div');
    sec4.className = 'subsection';
    let hh4 = document.createElement('h4');
    hh4.textContent = "Secci√≥n 4: Datos del Apoderado";
    sec4.appendChild(hh4);
    sec4.appendChild(makeField("Apellidos y Nombres", "apellidosApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("DNI", "dniApod", "number", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Fecha de Nacimiento", "fechaNacApod", "date", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Religi√≥n", "religionApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Estado Civil", "estadoCivilApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Grado de Instrucci√≥n", "gradoInstrApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Ocupaci√≥n", "ocupApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Tel√©fono", "telApod", "text", ch.ficha, { required: true }));
    sec4.appendChild(makeField("Correo Electr√≥nico", "emailApod", "text", ch.ficha, { required: true }));
    container.appendChild(sec4);
    const sec5 = document.createElement('div');
    sec5.className = 'subsection';
    let hh5 = document.createElement('h4');
    hh5.textContent = "Secci√≥n 5: Desarrollo";
    sec5.appendChild(hh5);
    sec5.appendChild(makeField("Complicaciones Durante el Parto (S√≠ / No), especificar", "complicParto", "text", ch.ficha, { required: true }));
    sec5.appendChild(makeField("Desarrollo Motriz", "desarrolloMotriz", "text", ch.ficha, { required: true }));
    sec5.appendChild(makeField("¬øYa levanta la cabeza?", "levantaCabeza", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øSe sienta?", "seSienta", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øGatea?", "gatea", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øSe para?", "sePara", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øCamina?", "camina", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øControla esf√≠nteres?", "controlaEsfinteres", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øYa dijo sus primeras palabras?", "primerasPalabras", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec5.appendChild(makeField("¬øYa habla con fluidez?", "hablaFluidez", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    container.appendChild(sec5);
    const sec6 = document.createElement('div');
    sec6.className = 'subsection';
    let hh6 = document.createElement('h4');
    hh6.textContent = "Secci√≥n 6: Salud";
    sec6.appendChild(hh6);
    sec6.appendChild(makeField("¬øSufre de alguna enfermedad(es) (S√≠/No)?", "enfermedades", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Alergias (S√≠/No)", "alergias", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: Varicela", "vacunaVaricela", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: Sarampi√≥n", "vacunaSarampion", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Control de Vacunas: COVID", "vacunaCOVID", "select", ch.ficha, { required: true, options: ["S√≠", "No"] }));
    sec6.appendChild(makeField("Tipo de Sangre", "tipoSangre", "text", ch.ficha, { required: true }));
    container.appendChild(sec6);
    let vive = ch.ficha.conQuienVive || '';
    if (vive === "Solo el Padre") {
      sec3.style.display = 'none';
      sec4.style.display = 'none';
    } else if (vive === "Solo la Madre") {
      sec2.style.display = 'none';
      sec4.style.display = 'none';
    } else if (vive === "Ambos Padres") {
      sec4.style.display = 'none';
    } else if (vive === "Apoderado") {
      sec2.style.display = 'none';
      sec3.style.display = 'none';
    }
    const btnFinish = document.createElement('button');
    btnFinish.className = 'finish-btn';
    btnFinish.textContent = 'Guardar';
    btnFinish.onclick = () => {
      let missing = checkFichaCompleta(ch);
      if (missing.length > 0) {
        alert("Faltan campos:\n- " + missing.join("\n- "));
        return;
      }
      ch.fichaCompleta = true;
      saveToFirebaseServices();
      renderFicha(ch);
    };
    container.appendChild(btnFinish);
  }
  function makeField(labelText, key, fieldType, fichaObj, opts) {
    const div = document.createElement('div');
    div.className = 'form-field';
    const lab = document.createElement('label');
    lab.textContent = labelText;
    div.appendChild(lab);
    let input;
    if (fieldType === "select") {
      input = document.createElement('select');
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = '-- Selecciona --';
      input.appendChild(emptyOption);
      (opts.options || []).forEach(o => {
        let op = document.createElement('option');
        op.value = o;
        op.textContent = o;
        input.appendChild(op);
      });
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    } else if (fieldType === "date") {
      input = document.createElement('input');
      input.type = 'date';
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    } else if (fieldType === "number") {
      input = document.createElement('input');
      input.type = 'text';
      input.value = fichaObj[key] || '';
      input.oninput = (e) => {
        e.target.value = e.target.value.replace(/[^\d]/g, '');
        fichaObj[key] = e.target.value;
      };
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.value = fichaObj[key] || '';
      input.onchange = () => fichaObj[key] = input.value;
    }
    div.appendChild(input);
    if (opts?.required) input.dataset.required = "true";
    input.dataset.key = key;
    return div;
  }
  function checkFichaCompleta(ch) {
    let missing = [];
    let f = ch.ficha;
    let sec1 = ["dni", "nomApeNino", "fechaNacNino", "lugarNacNino", "edadNino", "sexoNino", "religionNino", "tipoParto", "direccionNino", "nroHermanos", "telPrincipal", "telEmergencia", "centroMedico", "numSeguro", "tipoSeguro"];
    let sec5 = ["complicParto", "desarrolloMotriz", "levantaCabeza", "seSienta", "gatea", "sePara", "camina", "controlaEsfinteres", "primerasPalabras", "hablaFluidez"];
    let sec6 = ["enfermedades", "alergias", "vacunaVaricela", "vacunaSarampion", "vacunaCOVID", "tipoSangre"];
    let needed = [...sec1, ...sec5, ...sec6];
    if (f.conQuienVive === "Apoderado") {
      let sec4 = ["apellidosApod", "dniApod", "fechaNacApod", "religionApod", "estadoCivilApod", "gradoInstrApod", "ocupApod", "telApod", "emailApod"];
      needed.push(...sec4);
    }
    needed.forEach(k => {
      if (!f[k] || f[k].toString().trim() === '') {
        missing.push(k);
      }
    });
    return missing;
  }

  /**************************************************************
   * FUNCIONES ADMIN MATR√çCULAS
   **************************************************************/
  async function initMatriculas(){
    await loadFromFirebaseServices();
    ensureMatriculaService();
    monthlyPensionCheck();
    renderMatriculasList();
  }
  function monthlyPensionCheck(){
    const matServ = services.find(s => s.title === 'Matr√≠cula');
    if(!matServ) return;
    const currentYM = getYearMonth();
    matServ.children.forEach(ch => {
      if(ch.lastPagoCheck && ch.lastPagoCheck !== currentYM){
        if(!ch.pagoPension){
          ch.pensionesAtrasadas = (ch.pensionesAtrasadas || 0) + 1;
        }
        ch.pagoPension = false;
        ch.lastPagoCheck = currentYM;
      }
    });
    saveToFirebaseServices();
  }
  function eliminarSubtipo() {
  const sel = document.getElementById('egresoSubtipo');
  const subtipoSeleccionado = sel.value;
  if(!subtipoSeleccionado) {
    alert("Selecciona un subtipo para eliminar");
    return;
  }
  if(confirm(`¬øSeguro que deseas eliminar el subtipo "${subtipoSeleccionado}"?`)) {
    // Elimina el subtipo del array
    subtiposEgresos = subtiposEgresos.filter(st => st !== subtipoSeleccionado);
    cargarSubtiposEgresos();
    saveFinanzasData(); // Guarda la lista actualizada en Firebase
  }
}

  function renderMatriculasList(){
    const matServ = services.find(s => s.title === 'Matr√≠cula');
    if(!matServ) return;
    const tbody = document.getElementById('tbodyMatriculas');
    tbody.innerHTML = '';
    matServ.children.forEach(ch => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = `${ch.lastname} ${ch.name}`;
      row.insertCell(1).textContent = getVariantName(ch.variantId) || '';
      const cellF = row.insertCell(2);
      const btnF = document.createElement('button');
      btnF.className = 'ficha-btn';
      btnF.style.fontWeight = '600';
      btnF.style.borderRadius = '8px';
      btnF.style.backgroundColor = ch.fichaCompleta ? '#3BB273' : '#E74C3C';
      btnF.style.color = '#fff';
      btnF.textContent = 'Ficha Informativa';
      btnF.onclick = () => openFicha(ch);
      cellF.appendChild(btnF);
      const cellP = row.insertCell(3);
      const btnP = document.createElement('button');
      btnP.className = 'pension-btn';
      btnP.style.fontWeight = '600';
      btnP.style.borderRadius = '8px';
      btnP.style.color = '#fff';
      btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
      btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
      btnP.onclick = () => {
        ch.pagoPension = !ch.pagoPension;
        btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
        btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
        saveToFirebaseServices();
      };
      cellP.appendChild(btnP);
      const cellA = row.insertCell(4);
      const inputA = document.createElement('input');
      inputA.type = 'number';
      inputA.style.width = '60px';
      inputA.value = ch.pensionesAtrasadas || 0;
      inputA.onchange = () => {
        ch.pensionesAtrasadas = parseInt(inputA.value) || 0;
        saveToFirebaseServices();
      };
      cellA.appendChild(inputA);
    });
  }
  function filtrarMatriculas(){
    const valAno = document.getElementById('filtroAno').value;
    const valPension = document.getElementById('filtroPension').value;
    const matServ = services.find(s => s.title === 'Matr√≠cula');
    if(!matServ) return;
    let arr = [...matServ.children];
    if(valAno){
      arr = arr.filter(ch => getVariantName(ch.variantId) === valAno);
    }
    if(valPension === 'SI'){
      arr = arr.filter(ch => (!ch.pagoPension || ch.pensionesAtrasadas > 0));
    } else if(valPension === 'NO'){
      arr = arr.filter(ch => (ch.pagoPension && ch.pensionesAtrasadas === 0));
    }
    const tbody = document.getElementById('tbodyMatriculas');
    tbody.innerHTML = '';
    arr.forEach(ch => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = `${ch.lastname} ${ch.name}`;
      row.insertCell(1).textContent = getVariantName(ch.variantId) || '';
      const cellF = row.insertCell(2);
      const btnF = document.createElement('button');
      btnF.className = 'ficha-btn';
      btnF.style.fontWeight = '600';
      btnF.style.borderRadius = '8px';
      btnF.style.backgroundColor = ch.fichaCompleta ? '#3BB273' : '#E74C3C';
      btnF.style.color = '#fff';
      btnF.textContent = 'Ficha Informativa';
      btnF.onclick = () => openFicha(ch);
      cellF.appendChild(btnF);
      const cellP = row.insertCell(3);
      const btnP = document.createElement('button');
      btnP.className = 'pension-btn';
      btnP.style.fontWeight = '600';
      btnP.style.borderRadius = '8px';
      btnP.style.color = '#fff';
      btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
      btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
      btnP.onclick = () => {
        ch.pagoPension = !ch.pagoPension;
        btnP.style.backgroundColor = ch.pagoPension ? '#3BB273' : '#E74C3C';
        btnP.textContent = ch.pagoPension ? 'S√≠' : 'No';
        saveToFirebaseServices();
      };
      cellP.appendChild(btnP);
      const cellA = row.insertCell(4);
      const inputA = document.createElement('input');
      inputA.type = 'number';
      inputA.style.width = '60px';
      inputA.value = ch.pensionesAtrasadas || 0;
      inputA.onchange = () => {
        ch.pensionesAtrasadas = parseInt(inputA.value) || 0;
        saveToFirebaseServices();
      };
      cellA.appendChild(inputA);
    });
  }
async function loadUsersFromFirebase(){
  // Leemos todos los docs de la colecci√≥n "users"
  const ref = collection(db, "users");
  const snap = await getDocs(ref);
  users = snap.docs.map(doc => ({
    username: doc.id,
    ...doc.data()
  }));
}
async function goToUsers(){
  // Solo el usuario "renatozepi" (superadmin) puede entrar, 
  // o podr√≠as hacer un permiso p.adminUsers
  if(!currentUser || currentUser.username !== "renatozepi"){
    alert("Solo el usuario administrador principal puede gestionar usuarios.");
    return;
  }
  // Ocultamos login y landing
  document.getElementById('landingPage').classList.add('hidden');
  document.getElementById('usersContainer').style.display = 'block';
  screenStack.push("users");
  await loadUsersFromFirebase();
  showUsersList();
  openTabUsers('UsersMain');
}
function descargarFichaWord(ch) {
  const year = new Date().getFullYear();
  const fileName = `Ficha Informativa_${year}_${ch.name}_${ch.lastname}.doc`;
  const f = ch.ficha || {};

  // Construimos el contenido con TODAS las secciones de la ficha
  const contentHtml = `
    <h1 style="text-align:center;">Ficha Informativa</h1>
    <h2 style="text-align:center;">${ch.lastname} ${ch.name} - A√±o: ${year}</h2>
    <hr>

    <!-- Definimos el estilo para evitar cortes de p√°gina internos -->
    <style>
      .avoid-page-break {
        page-break-inside: avoid;
      }
    </style>

    <!-- Secci√≥n 1: Datos del Ni√±o -->
    <div class="avoid-page-break">
      <h3>Secci√≥n 1: Datos del Ni√±o</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>DNI</strong></td><td>${f.dni || ''}</td></tr>
        <tr><td><strong>Nombres y Apellidos</strong></td><td>${f.nomApeNino || ''}</td></tr>
        <tr><td><strong>Fecha de Nacimiento</strong></td><td>${f.fechaNacNino || ''}</td></tr>
        <tr><td><strong>Lugar de Nacimiento</strong></td><td>${f.lugarNacNino || ''}</td></tr>
        <tr><td><strong>Edad</strong></td><td>${f.edadNino || ''}</td></tr>
        <tr><td><strong>Sexo</strong></td><td>${f.sexoNino || ''}</td></tr>
        <tr><td><strong>Religi√≥n</strong></td><td>${f.religionNino || ''}</td></tr>
        <tr><td><strong>Tipo de Parto</strong></td><td>${f.tipoParto || ''}</td></tr>
        <tr><td><strong>Direcci√≥n</strong></td><td>${f.direccionNino || ''}</td></tr>
        <tr><td><strong>Nro. de Hermanos</strong></td><td>${f.nroHermanos || ''}</td></tr>
        <tr><td><strong>Tel. Principal</strong></td><td>${f.telPrincipal || ''}</td></tr>
        <tr><td><strong>Tel. Emergencia</strong></td><td>${f.telEmergencia || ''}</td></tr>
        <tr><td><strong>Centro M√©dico</strong></td><td>${f.centroMedico || ''}</td></tr>
        <tr><td><strong>N√∫mero de Seguro</strong></td><td>${f.numSeguro || ''}</td></tr>
        <tr><td><strong>Tipo de Seguro</strong></td><td>${f.tipoSeguro || ''}</td></tr>
        <tr><td><strong>¬øCon qui√©n vive?</strong></td><td>${f.conQuienVive || ''}</td></tr>
      </table>
    </div>
    <br>

    <!-- Secci√≥n 2: Datos del Padre -->
    <div class="avoid-page-break">
      <h3>Secci√≥n 2: Datos del Padre</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Apellidos y Nombres</strong></td><td>${f.apellidosPadre || ''}</td></tr>
        <tr><td><strong>DNI</strong></td><td>${f.dniPadre || ''}</td></tr>
        <tr><td><strong>Fecha Nac.</strong></td><td>${f.fechaNacPadre || ''}</td></tr>
        <tr><td><strong>Religi√≥n</strong></td><td>${f.religionPadre || ''}</td></tr>
        <tr><td><strong>Estado Civil</strong></td><td>${f.estadoCivilPadre || ''}</td></tr>
        <tr><td><strong>Grado Instrucci√≥n</strong></td><td>${f.gradoInstrPadre || ''}</td></tr>
        <tr><td><strong>Ocupaci√≥n</strong></td><td>${f.ocupPadre || ''}</td></tr>
        <tr><td><strong>Tel√©fono</strong></td><td>${f.telPadre || ''}</td></tr>
        <tr><td><strong>Email</strong></td><td>${f.emailPadre || ''}</td></tr>
      </table>
    </div>
    <br>
    <p style="text-align:center;"><em>‚Äé‚Äé‚Äé‚Äé‚Äé‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé</em></p>
    <!-- Secci√≥n 3: Datos de la Madre -->
    <div class="avoid-page-break">
      <h3>Secci√≥n 3: Datos de la Madre</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Apellidos y Nombres</strong></td><td>${f.apellidosMadre || ''}</td></tr>
        <tr><td><strong>DNI</strong></td><td>${f.dniMadre || ''}</td></tr>
        <tr><td><strong>Fecha Nac.</strong></td><td>${f.fechaNacMadre || ''}</td></tr>
        <tr><td><strong>Religi√≥n</strong></td><td>${f.religionMadre || ''}</td></tr>
        <tr><td><strong>Estado Civil</strong></td><td>${f.estadoCivilMadre || ''}</td></tr>
        <tr><td><strong>Grado Instrucci√≥n</strong></td><td>${f.gradoInstrMadre || ''}</td></tr>
        <tr><td><strong>Ocupaci√≥n</strong></td><td>${f.ocupMadre || ''}</td></tr>
        <tr><td><strong>Tel√©fono</strong></td><td>${f.telMadre || ''}</td></tr>
        <tr><td><strong>Email</strong></td><td>${f.emailMadre || ''}</td></tr>
      </table>
    </div>
    <br>

    <!-- Secci√≥n 4: Datos del Apoderado -->
    <div class="avoid-page-break">
      <h3>Secci√≥n 4: Datos del Apoderado</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Apellidos y Nombres</strong></td><td>${f.apellidosApod || ''}</td></tr>
        <tr><td><strong>DNI</strong></td><td>${f.dniApod || ''}</td></tr>
        <tr><td><strong>Fecha Nac.</strong></td><td>${f.fechaNacApod || ''}</td></tr>
        <tr><td><strong>Religi√≥n</strong></td><td>${f.religionApod || ''}</td></tr>
        <tr><td><strong>Estado Civil</strong></td><td>${f.estadoCivilApod || ''}</td></tr>
        <tr><td><strong>Grado Instrucci√≥n</strong></td><td>${f.gradoInstrApod || ''}</td></tr>
        <tr><td><strong>Ocupaci√≥n</strong></td><td>${f.ocupApod || ''}</td></tr>
        <tr><td><strong>Tel√©fono</strong></td><td>${f.telApod || ''}</td></tr>
        <tr><td><strong>Email</strong></td><td>${f.emailApod || ''}</td></tr>
      </table>
    </div>
    <br>

    <!-- Secci√≥n 5: Desarrollo -->
    <div class="avoid-page-break">
      <h3>Secci√≥n 5: Desarrollo</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Complicaciones Parto</strong></td><td>${f.complicParto || ''}</td></tr>
        <tr><td><strong>Desarrollo Motriz</strong></td><td>${f.desarrolloMotriz || ''}</td></tr>
        <tr><td><strong>Levanta Cabeza</strong></td><td>${f.levantaCabeza || ''}</td></tr>
        <tr><td><strong>Se Sienta</strong></td><td>${f.seSienta || ''}</td></tr>
        <tr><td><strong>Gatea</strong></td><td>${f.gatea || ''}</td></tr>
        <tr><td><strong>Se Para</strong></td><td>${f.sePara || ''}</td></tr>
        <tr><td><strong>Camina</strong></td><td>${f.camina || ''}</td></tr>
        <tr><td><strong>Controla Esf√≠nteres</strong></td><td>${f.controlaEsfinteres || ''}</td></tr>
        <tr><td><strong>Primeras Palabras</strong></td><td>${f.primerasPalabras || ''}</td></tr>
        <tr><td><strong>Habla con Fluidez</strong></td><td>${f.hablaFluidez || ''}</td></tr>
      </table>
    </div>
    <br>
    <p style="text-align:center;"><em>‚Äé‚Äé‚Äé‚Äé‚Äé‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé‚Äé ‚Äé ‚Äé ‚Äé</em></p>
    <!-- Secci√≥n 6: Salud -->
    <div class="avoid-page-break">
      <h3>Secci√≥n 6: Salud</h3>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <tr><td><strong>Enfermedades</strong></td><td>${f.enfermedades || ''}</td></tr>
        <tr><td><strong>Alergias</strong></td><td>${f.alergias || ''}</td></tr>
        <tr><td><strong>Vacuna Varicela</strong></td><td>${f.vacunaVaricela || ''}</td></tr>
        <tr><td><strong>Vacuna Sarampi√≥n</strong></td><td>${f.vacunaSarampion || ''}</td></tr>
        <tr><td><strong>Vacuna COVID</strong></td><td>${f.vacunaCOVID || ''}</td></tr>
        <tr><td><strong>Tipo de Sangre</strong></td><td>${f.tipoSangre || ''}</td></tr>
      </table>
    </div>
    <br>


  `;

  // Armamos el HTML final:
  const preHtml = `
    <html>
    <head>
      <meta charset="UTF-8"/>
      <title>Ficha Informativa</title>
    </head>
    <body style="font-family:Arial, sans-serif; line-height:1.4; margin:20px;">
  `;
  const postHtml = `</body></html>`;
  const fullHtml = preHtml + contentHtml + postHtml;

  // Creamos un Blob con type "application/msword"
  const blob = new Blob([fullHtml], { type: "application/msword" });
  const url = URL.createObjectURL(blob);

  // Forzamos la descarga
  const link = document.createElement('a');
  link.href = url;
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // Liberamos el URL blob
  URL.revokeObjectURL(url);
}

function showUsersList(){
  const container = document.getElementById('usersList');
  container.innerHTML = '';
  users.forEach(u => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.border = '1px solid #ccc';
    div.style.borderRadius = '6px';
    div.style.padding = '6px';
    div.style.marginBottom = '5px';

    const leftSpan = document.createElement('span');
    leftSpan.textContent = `Usuario: ${u.username}`;
    div.appendChild(leftSpan);

    const rightDiv = document.createElement('div');
    // Bot√≥n Editar Permisos
    const btnEd = document.createElement('button');
    btnEd.textContent = 'Editar Permisos';
    btnEd.onclick = () => editUser(u.username);
    rightDiv.appendChild(btnEd);

    // Bot√≥n Eliminar (no se muestra para el usuario principal, por ejemplo "renatozepi")
    if(u.username !== "renatozepi") {
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Eliminar';
      btnDel.style.marginLeft = '5px';
      btnDel.onclick = () => deleteUser(u.username);
      rightDiv.appendChild(btnDel);
    }
    div.appendChild(rightDiv);

    container.appendChild(div);
  });
}
async function deleteUser(username) {
  if(!confirm(`¬øEst√°s seguro de eliminar el usuario "${username}"?`)) return;
  try {
    await deleteDoc(doc(db, "users", username));
    alert("Usuario eliminado");
    // Recargar la lista
    await loadUsersFromFirebase();
    showUsersList();
  } catch (error) {
    console.error("Error eliminando usuario:", error);
    alert("Error al eliminar usuario");
  }
}
async function saveUserToFirebase(userObj) {
  // userObj es un objeto con { username, password, permisos: {...} }
  const docRef = doc(db, "users", userObj.username);
  await setDoc(docRef, userObj, { merge: true });
}
async function crearUser(){
  const userName = document.getElementById('newUserName').value.trim();
  const userPass = document.getElementById('newUserPass').value;
  if(!userName || !userPass){
    alert("Completa el nombre de usuario y la contrase√±a.");
    return;
  }

  // Permisos por defecto, todos false
  const defaultPerms = {
    macros:false, macrosNinos:false,
    services:false, servicesVariants:false, servicesChildren:false,
    matriculas:false,
    finanzas:false, finanzasTotal:false, finanzasEgresos:false, finanzasIngresos:false
  };

  const newUser = {
    username: userName,
    password: userPass,
    permisos: defaultPerms
  };

  await saveUserToFirebase(newUser);
  alert("Usuario creado!");
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserPass').value = '';
  await loadUsersFromFirebase();
  showUsersList();
}
function editUser(username){
  editingUsername = username;
  openTabUsers('EditUser');
  const u = users.find(x => x.username === username);
  if(!u) return;
  document.getElementById('currentUserTitle').textContent = u.username;

  const p = u.permisos || {};
  document.getElementById('permMacros').checked           = !!p.macros;
  document.getElementById('permMacrosNinos').checked      = !!p.macrosNinos;
  document.getElementById('permServices').checked         = !!p.services;
  document.getElementById('permServicesVariants').checked = !!p.servicesVariants;
  document.getElementById('permServicesChildren').checked = !!p.servicesChildren;
  document.getElementById('permMatriculas').checked       = !!p.matriculas;
  document.getElementById('permFinanzas').checked         = !!p.finanzas;
  document.getElementById('permFinanzasTotal').checked    = !!p.finanzasTotal;
  document.getElementById('permFinanzasEgresos').checked  = !!p.finanzasEgresos;
  document.getElementById('permFinanzasIngresos').checked = !!p.finanzasIngresos;
}

async function guardarPermisosUsuario(){
  if(!editingUsername) return;
  const idx = users.findIndex(x => x.username === editingUsername);
  if(idx < 0) return;
  const u = users[idx];

  u.permisos.macros            = document.getElementById('permMacros').checked;
  u.permisos.macrosNinos       = document.getElementById('permMacrosNinos').checked;
  u.permisos.services          = document.getElementById('permServices').checked;
  u.permisos.servicesVariants  = document.getElementById('permServicesVariants').checked;
  u.permisos.servicesChildren  = document.getElementById('permServicesChildren').checked;
  u.permisos.matriculas        = document.getElementById('permMatriculas').checked;
  u.permisos.finanzas          = document.getElementById('permFinanzas').checked;
  u.permisos.finanzasTotal     = document.getElementById('permFinanzasTotal').checked;
  u.permisos.finanzasEgresos   = document.getElementById('permFinanzasEgresos').checked;
  u.permisos.finanzasIngresos  = document.getElementById('permFinanzasIngresos').checked;

  await saveUserToFirebase(u);
  alert("Permisos actualizados!");
  openTabUsers('UsersMain');
  showUsersList();
}
function openTabUsers(tabName) {
  // 1) Dependiendo de la l√≥gica, quiz√° solo el superadmin ‚Äúrenatozepi‚Äù puede acceder:
  if (tabName === 'UsersMain') {
    if (currentUser.username !== "renatozepi") {
      alert("No tienes permiso para ver la lista de usuarios.");
      return;
    }
  } else if (tabName === 'EditUser') {
    if (currentUser.username !== "renatozepi") {
      alert("No tienes permiso para editar usuarios.");
      return;
    }
  }

  // 2) Quitar clases
  document.getElementById('contentUsersMain').classList.remove('activeTabContent');
  document.getElementById('contentEditUser').classList.remove('activeTabContent');
  document.getElementById('tabUsersMain').classList.remove('activeTab');
  document.getElementById('tabEditUser').classList.remove('activeTab');

  // 3) Activar la pesta√±a solicitada
  if (tabName === 'UsersMain') {
    document.getElementById('contentUsersMain').classList.add('activeTabContent');
    document.getElementById('tabUsersMain').classList.add('activeTab');
  } else if (tabName === 'EditUser') {
    document.getElementById('contentEditUser').classList.add('activeTabContent');
    document.getElementById('tabEditUser').classList.add('activeTab');
  }
}
function initEgresosFilters() {
  // 1. Llenar el select de Tipo:
  const selectTipo = document.getElementById("filtroEgresosTipo");
  selectTipo.innerHTML = `
    <option value="">(Todos)</option>
    <option value="Fijo">Fijo</option>
    <option value="Variable">Variable</option>
  `;

  // 2. Llenar el select de Subtipo con lo que tengas en subtiposEgresos:
  const selectSubtipo = document.getElementById("filtroEgresosSubtipo");
  selectSubtipo.innerHTML = `<option value="">(Todos)</option>`;
  subtiposEgresos.forEach(st => {
    const opt = document.createElement("option");
    opt.value = st;
    opt.textContent = st;
    selectSubtipo.appendChild(opt);
  });
}
function initIngresosFilters() {
  // 1) El <select> de tipo: Matr√≠cula / Taller
  const selectTipo = document.getElementById("filtroIngresosTipo");
  selectTipo.innerHTML = `
    <option value="">(Todos)</option>
    <option value="Matr√≠cula">Matr√≠cula</option>
    <option value="Taller">Taller</option>
  `;

  // 2) El <select> de "subtipo" ser√° en realidad el nombre del servicio
  //    (que no sea "Matr√≠cula").

  const selectSubtipo = document.getElementById("filtroIngresosSubtipo");
  selectSubtipo.innerHTML = `<option value="">(Todos)</option>`;

  // Recolectamos nombres de talleres (services que no sean 'Matr√≠cula')
  const workshopNames = new Set();
  services.forEach(s => {
    if (s.title !== "Matr√≠cula") {
      workshopNames.add(s.title);
    }
  });

  // Agregamos como opciones
  workshopNames.forEach(tallerName => {
    const opt = document.createElement("option");
    opt.value = tallerName;        // ej. "Danza", "M√∫sica"
    opt.textContent = tallerName;
    selectSubtipo.appendChild(opt);
  });
}

function filtrarEgresos() {
  // Si quieres re-renderizar solo la parte de egresos:
  // Recalcamos que "renderFinanzas()" ya llama a "renderTablaEgresos(...)"
  // y lo filtra. Por eso, con solo "renderFinanzas()" basta.
  renderFinanzas();
}
function filtrarIngresos() {
  // Igualmente, "renderFinanzas()" llama a "renderTablaIngresos(mesSeleccionado)"
  // y aplica el filtro. 
  renderFinanzas();
}






  /**************************************************************
   * EXPOSE FUNCTIONS TO GLOBAL (after DOMContentLoaded)
   **************************************************************/
   document.addEventListener('DOMContentLoaded', () => {
    window.goToMacros = goToMacros;
    window.goToServices = goToServices;
    window.goToMatriculas = goToMatriculas;
    window.goToFinanzas = goToFinanzas;
    window.goBack = goBack;
    window.goBackFicha = goBackFicha;
    window.openTabMacros = openTabMacros;
    window.crearMacro = crearMacro;
    window.agregarOguardarNino = agregarOguardarNino;
    window.agregarEgreso = agregarEgreso;
    window.generarTxt = generarTxt;
    window.guardarYVolver = guardarYVolver;
    window.openTabServices = openTabServices;
    window.openTabFinanzas = openTabFinanzas;
    window.crearService = crearService;
    window.agregarOguardarVariante = agregarOguardarVariante;
    window.doneVariants = doneVariants;
    window.agregarOguardarChild = agregarOguardarChild;
    window.doneChildren = doneChildren;
    window.filtrarMatriculas = filtrarMatriculas;
    window.initMatriculas = initMatriculas;
    window.renderMatriculasList = renderMatriculasList;
    window.agregarNuevoSubtipo = agregarNuevoSubtipo;
    window.cambiarMesFinanzas = cambiarMesFinanzas;
    window.eliminarSubtipo = eliminarSubtipo;
    window.currentUser = currentUser;
    window.goToUsers = goToUsers;
    window.crearUser = crearUser;
    window.guardarPermisosUsuario = guardarPermisosUsuario
    window.logout = logout
    window.filtrarEgresos = filtrarEgresos
    window.filtrarIngresos = filtrarIngresos
  });
</script>
</body>
</html>
